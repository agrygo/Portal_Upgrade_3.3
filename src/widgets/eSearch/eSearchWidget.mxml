<?xml version="1.0" encoding="utf-8"?>
<!--
	////////////////////////////////////////////////////////////////////////////////
	//
	// Copyright © 2010 ESRI
	//
	// All rights reserved under the copyright laws of the United States.
	// You may freely redistribute and use this software, with or
	// without modification, provided you include the original copyright
	// and use restrictions.  See use restrictions in the file:
	// <install location>/FlexViewer/License.txt
	//
	////////////////////////////////////////////////////////////////////////////////
-->

<!--
	See ReadMe.txt for Version updates and bug fixes
-->
<viewer:BaseWidget xmlns:esri			="http://www.esri.com/2008/ags"
				   xmlns:fx				="http://ns.adobe.com/mxml/2009"
				   xmlns:s				="library://ns.adobe.com/flex/spark"
				   xmlns:mx				="library://ns.adobe.com/flex/mx"
				   xmlns:mxeffects     	="com.adobe.ac.mxeffects.*"
				   xmlns:viewer        	="com.esri.viewer.*"
				   xmlns:Search       	="widgets.eSearch.*"
				   xmlns:supportClasses ="com.esri.ags.tasks.supportClasses.*"
				   currentState			="textInput"
				   widgetConfigLoaded	="init()">

	<viewer:states>
		<s:State name="graphicalInput"/>
		<s:State name="textInput"/>
		<s:State name="spatialInput" />
		<s:State name="resultsList"/>
	</viewer:states>

	<viewer:transitions>
		<s:Transition autoReverse="true" toState="*">
			<s:Fade targets="{[resultsList,graphicalInput,textInput,spatialInput]}"/>
		</s:Transition>
	</viewer:transitions>

	<fx:Declarations>
		<s:GlowFilter id="glowFilter"
					  alpha="1"
					  color="{getStyle('focusColor')}"
					  inner="true"
					  strength="2"/>
		<esri:GeometryService id="geometryService"
							  fault="geometryService_faultHandler(event)"
							  url="http://tasks.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer"/>
		<s:ColorMatrixFilter id="cOver" matrix="[0.5,0.5,0.5,0,0,0.5,0.5,0.5,0,0,0.5,0.5,0.5,0,0,0,0,0,0.6,0]"/>
		<supportClasses:RelationshipQuery id="relatesQuery" outFields="[*]"/>
		<s:Animate id="anim" duration="500">
			<s:motionPaths>
				<s:SimpleMotionPath id="pth" property="verticalScrollPosition" />
			</s:motionPaths>
		</s:Animate>
		<s:Sequence id="showGraPops">
			<s:SetAction target="{graphicPopUp}" property="displayPopUp" value="true"/>
			<s:Scale target="{graphicPopUp.popUp}"
					 scaleXFrom=".0001"
					 scaleYFrom=".0001"
					 scaleXTo="1"
					 scaleYTo="1"
					 duration="200"/>
		</s:Sequence>
		<s:Sequence id="hideGraPops">
			<s:Scale target="{graphicPopUp.popUp}"
					 scaleXFrom="1"
					 scaleYFrom="1"
					 scaleXTo=".0001"
					 scaleYTo=".0001"
					 duration="250"/>
			<s:SetAction target="{graphicPopUp}" property="displayPopUp" value="false"/>
		</s:Sequence>

		<s:Sequence id="showGraPops2">
			<s:SetAction target="{graphicPopUp2}" property="displayPopUp" value="true"/>
			<s:Scale target="{graphicPopUp2.popUp}"
					 scaleXFrom=".0001"
					 scaleYFrom=".0001"
					 scaleXTo="1"
					 scaleYTo="1"
					 duration="200"/>
		</s:Sequence>
		<s:Sequence id="hideGraPops2">
			<s:Scale target="{graphicPopUp2.popUp}"
					 scaleXFrom="1"
					 scaleYFrom="1"
					 scaleXTo=".0001"
					 scaleYTo=".0001"
					 duration="250"/>
			<s:SetAction target="{graphicPopUp2}" property="displayPopUp" value="false"/>
		</s:Sequence>
		<s:Parallel id="mouseOverGear">
			<s:Rotate3D angleZFrom="0" angleZTo="45"
						duration="500" autoCenterTransform="true" />
			<s:SetAction property="filters" value="{[gf]}"  />
		</s:Parallel>
		<s:Parallel id="mouseOutGear">
			<s:Rotate3D angleZFrom="45" angleZTo="0"
						duration="500" autoCenterTransform="true" />
			<s:SetAction property="filters" value="{[]}"  />
		</s:Parallel>
		<s:GlowFilter alpha="0.8"
					  blurX="5"
					  blurY="5"
					  color="0xffffff"
					  quality="{BitmapFilterQuality.MEDIUM}"
					  strength="1"
					  id="gf"/>
	</fx:Declarations>

	<fx:Script>
		<![CDATA[
			import com.esri.ags.FeatureSet;
			import com.esri.ags.Graphic;
			import com.esri.ags.Map;
			import com.esri.ags.SpatialReference;
			import com.esri.ags.components.IdentityManager;
			import com.esri.ags.components.supportClasses.Credential;
			import com.esri.ags.events.DrawEvent;
			import com.esri.ags.events.GeometryServiceEvent;
			import com.esri.ags.events.GraphicEvent;
			import com.esri.ags.events.GraphicsLayerEvent;
			import com.esri.ags.events.LayerEvent;
			import com.esri.ags.events.MapEvent;
			import com.esri.ags.geometry.Extent;
			import com.esri.ags.geometry.Geometry;
			import com.esri.ags.geometry.MapPoint;
			import com.esri.ags.geometry.Multipoint;
			import com.esri.ags.geometry.Polygon;
			import com.esri.ags.geometry.Polyline;
			import com.esri.ags.layers.FeatureLayer;
			import com.esri.ags.layers.GraphicsLayer;
			import com.esri.ags.layers.Layer;
			import com.esri.ags.layers.supportClasses.CodedValue;
			import com.esri.ags.layers.supportClasses.CodedValueDomain;
			import com.esri.ags.layers.supportClasses.FeatureType;
			import com.esri.ags.layers.supportClasses.Field;
			import com.esri.ags.layers.supportClasses.RangeDomain;
			import com.esri.ags.layers.supportClasses.Relationship;
			import com.esri.ags.portal.PopUpRenderer;
			import com.esri.ags.portal.supportClasses.PopUpInfo;
			import com.esri.ags.portal.supportClasses.PopUpMediaInfo;
			import com.esri.ags.renderers.SimpleRenderer;
			import com.esri.ags.symbols.PictureMarkerSymbol;
			import com.esri.ags.symbols.SimpleFillSymbol;
			import com.esri.ags.symbols.SimpleLineSymbol;
			import com.esri.ags.symbols.SimpleMarkerSymbol;
			import com.esri.ags.symbols.Symbol;
			import com.esri.ags.tasks.GeometryService;
			import com.esri.ags.tasks.GeometryServiceSingleton;
			import com.esri.ags.tasks.supportClasses.BufferParameters;
			import com.esri.ags.tasks.supportClasses.Query;
			import com.esri.ags.tools.DrawTool;
			import com.esri.ags.utils.GeometryUtil;
			import com.esri.ags.utils.GraphicUtil;
			import com.esri.ags.utils.StringUtil;
			import com.esri.viewer.AppEvent;
			import com.esri.viewer.ViewerContainer;
			import com.esri.viewer.components.TitlebarButton;
			import com.esri.viewer.components.toc.utils.MapUtil;
			
			import flash.filters.BitmapFilterQuality;
			
			import mx.collections.ArrayCollection;
			import mx.collections.ArrayList;
			import mx.collections.IViewCursor;
			import mx.controls.Alert;
			import mx.core.IVisualElement;
			import mx.events.FlexEvent;
			import mx.managers.PopUpManager;
			import mx.managers.PopUpManagerChildList;
			import mx.rpc.AsyncResponder;
			import mx.rpc.Fault;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			import mx.rpc.http.Operation;
			import mx.rpc.soap.WebService;
			import mx.rpc.soap.mxml.WebService;
			import mx.utils.ObjectUtil;
			import mx.utils.StringUtil;
			
			import spark.components.supportClasses.ItemRenderer;
			import spark.formatters.CurrencyFormatter;
			import spark.formatters.DateTimeFormatter;
			import spark.formatters.NumberFormatter;
			
			import widgets.eSearch.skins.PopUpRendererSkin;
			
			//labels
			[Bindable] private var lblInclueTextQuery:String;
			[Bindable] private var lblbufferUserGraphic:String;
			[Bindable] private var noRelatesFound:String;
			[Bindable] private var noRelatesFoundAlertTitle:String;
			[Bindable] private var enableMultiPartSearch:String;
			[Bindable] private var lblTolerance:String;
			[Bindable] private var layerLabel:String;
			[Bindable] private var layerExprLabel:String;
			[Bindable] private var submitLabel:String;
			[Bindable] private var pointLabel:String;
			[Bindable] private var buffergrapicpropsLbl:String;
			[Bindable] private var bufferAlphaLabel:String;
			[Bindable] private var bufferColorLabel:String;
			[Bindable] private var nobuffercolorlbl:String;
			[Bindable] private var bufferoutlinecolorlbl:String;
			[Bindable] private var nobufferoutlinecolorlbl:String;
			[Bindable] private var bufferoutlinewidthlbl:String;
			[Bindable] private var configbuffergraTip:String;
			[Bindable] private var includetextquerywarnTip:String;
			[Bindable] private var lineLabel:String;
			[Bindable] private var rectangleLabel:String;
			[Bindable] private var polygonLabel:String;
			[Bindable] private var clearLabel:String;
			[Bindable] private var zoomallLabel:String;
			[Bindable] private var zoomallTip:String;
			[Bindable] private var drawGraLabel:String;
			[Bindable] private var bufferGraLabel:String;
            [Bindable] private var elocateGraLabel:String;
			[Bindable] private var msgVisible:Boolean = false;
			[Bindable] private var searchLayerLabel:String;
			[Bindable] private var bufferLabel:String;
			[Bindable] private var urlSearchErrorMsg:String;
			private var graphicalsearchLabel:String;
			private var textsearchLabel:String;
			private var resultsLabel:String;
			private var gridresultsLabel:String;
			private var loadingLabel:String;
			private var selectionLabel:String;
			private var nolayerLabel:String;
			private var requiredLbl:String;
			private var requiredTooltip:String;
			[Bindable] private var SelectionMethodTip:String;
			[Bindable] private var NewSelectionMethodTip:String;
			[Bindable] private var AddSelectionMethodTip:String;
			[Bindable] private var RemoveSelectionMethodTip:String;
            private var expBtnLbl:String;
            private var exp2csvOptLbl:String;
            private var exp2txtOptLbl:String;

			//Properties
			private var qFeatSet:FeatureSet;
			[Bindable] private var drawGraphicsLayer:GraphicsLayer;
            [Bindable] private var locateGraphicsLayer:GraphicsLayer;
			[Bindable] private var bufferGraphicsLayer:GraphicsLayer;
			private var graphicsLayerBuffer:GraphicsLayer;
			private var graGraphicsLayer:GraphicsLayer;
			[Bindable] private var pagingQueryTask:PagingQueryTask = new PagingQueryTask;
			[Bindable] public var searchResultAC:ArrayCollection;
			[Bindable] private var eDrawEnabled:Boolean = false;
            [Bindable] private var eLocateEnabled:Boolean = false;
			[Bindable] private var pBufferEnabled:Boolean = false;
			[Bindable] private var applyBufferLabel:String;
			[Bindable] private var multiPartGraphicSearch:Boolean;
			[Bindable] private var applyTolleranceByDefault:Boolean;
			[Bindable] private var widgetAndGridIteract:Boolean;
			[Bindable] private var PopUpsDisabled:Boolean;
            [Bindable] private var enableMutiGra:Boolean;
            [Bindable] private var enableIncludeTextSearch:Boolean;
            [Bindable] private var enableAddTollerance:Boolean;
            [Bindable] private var enableGraphicsBuffering:Boolean;
			private var layerDetails:*;
			private var gridFields:Array = [];
			private var popCBwithUniqueQue:Array = [];
			private var gridHyperFields:Array = [];
			private var relateFields:Array = [];
			private var qrelateFields:Array = [];
			private var relateHyperFields:Array = [];
			private var configSearchGraphical:Array;
			private var configSearchText:Array;
			private var configDomainVals:Array;
			private var configSubTypeVals:Array;
			private var configUserVals:Array;
			private var queryLayerRels:Array;
			private var qLinks:Array = [];
			private var lyrQLinks:Array = [];
			private var configLayerExprs:Array;
			private var configLayerExprsVals:Array;
			private var configTableExprs:Array;
			private var configTableExprsVals:Array;
			private var configLayerRels:Array;
			private var configTableRels:Array;
			private var configBufferUnits:Array;
			private var configSpatialSearchLayers:Array;
			private var configSpatialSearchRelation:Array;
			private var geomArr:Array;
			private var keepGraSearchEnabled:Boolean;
			private var autoZoom:Boolean;
			private var queryEnableExport:Boolean;
			private var queryEnablePrint:Boolean;
			private var queryPrintTitle:String;
			private var queryExprForSpatRel:Boolean;
			private var queryAttachments:Boolean;
			private var openDataGrid:Boolean;
			private var executingURLquery:Boolean;
			[Bindable] private var qFeatLayer:FeatureLayer;
			private var queryLayer:FeatureLayer;
			private var relqueryLayer:FeatureLayer;
			private var resultsFeatureSet:FeatureSet;
			private var queryGeom:Geometry;
			private var selectedDrawingIcon:Image;
			private var zoomScale:Number = 5000;
			private var zoomPercent:Number = 1.2;
			private var pointSearchTolerance:Number = 6;
			private var gridDataProvider:Object;
			private var fldAliases:Object;
			private var relfldAliases:Object;
			private var popUpRenderer:PopUpRenderer = new PopUpRenderer();
			private var rWindow:RelatesWindow;
			//Added 7/13/2011 PWA 
			[Bindable]
			private var integrationWebService:String;
			private var userid:String;
			private var parcelLayerName:String;
			private var parcelLayerPINFieldName:String;
			private var portalIntegrationMethods:mx.rpc.soap.mxml.WebService;
			private var getWhereClauseOperation:mx.rpc.http.Operation;
			private var buildSqlResultsTableOperation:mx.rpc.http.Operation;
			private var urlWhereClause:String;
			private var myfloatdg:SearchWidgetFloatDG;
			private var relfloatdg:SearchWidgetRelateFloatDG;
			private var sWidget:eSearchWidget;
			private var sReff:SpatialReference;
			private var relateIcon:String;
			private var relateToolTip:String;
			private var queryExpr:String;
			private var queryDefExpr:String = "";
			private const ICON_URL:String = "assets/images/";
			[Bindable] private var WIDGET_URL:String = "widgets/eSearch/assets/images/";
			private var _csvName:String;
			private var relatescsvName:String;
			private var queryMultiImgField:String;
			private var csvSep:String;
			private var lblSum:String;
			private var sumField:String;
			private var disableButtons:String;
			private var spatialsearchLabel:String;
			private var floatorfixed:String;
			private var selectedGraphicalTool:String;
			private var lastTool:String;
			private var lState:String = "textInput";
			private var queryTitleField:String;
			private var defaultSelectionOption:String;
			private var queryFields:XMLList;
			private var disResult:Boolean = false;
			private var disGrid:Boolean = false;
			[Bindable] private var featLyrLen:int;
			[Bindable] private var featSethasGeom:Boolean;
			[Bindable] private var BuffValue:String;

			//Print DG Properties
			private var dgheaderbgcolor:uint;
			private var dgrepeatheader:Boolean;
			private var dgheaderfontcolor:uint;
			private var dgfooterincdate:Boolean;
			private var dgfooterdateformat:String;
			private var dgfooterpageofpage:String;
			private var dgfooterdisclaimer:String;

			//Formatters
			private var dateFormatter:DateTimeFormatter = new DateTimeFormatter();
			private var numFormatter:NumberFormatter = new NumberFormatter();
			private var currFormatter:CurrencyFormatter = new CurrencyFormatter();

			//Symbols
			private var drawSymbol:Symbol;
			private var resultMarkerSymbol:Symbol;
			private var resultLineSymbol:Symbol;
			private var resultFillSymbol:Symbol;
			private var resultSATSymbol:Symbol;

			//Build Constants
			protected const VERSION:String = "3.3";
			protected const BUILDDATE:String = "5/6/2013";

			//Resources
			[Embed(source="widgets/eSearch/assets/images/i_about.png")]
			private var iconClass:Class;

			[Embed(source="widgets/eSearch/assets/images/i_relate.png")]
			private var relateClass:Class;

			[Embed(source="widgets/eSearch/assets/images/i_table.png")]
			private var satClass:Class;

			private function init():void
			{
                var fLayer:FeatureLayer = new FeatureLayer;
                
				sWidget = this;
				WIDGET_URL = config.substring(0,config.lastIndexOf("/")) + "/assets/images/";
				if (configXML){
					if (GeometryServiceSingleton.instance.url){
						geometryService.url = GeometryServiceSingleton.instance.url;
						geometryService.token = GeometryServiceSingleton.instance.token;
						geometryService.proxyURL = GeometryServiceSingleton.instance.proxyURL;
					}
					relateIcon = configXML.relateicon || WIDGET_URL + "i_relate.png";
					//labels
					urlSearchErrorMsg = configXML.labels.urlsearcherrormessage || "URL search parameters are incorrect";
					SelectionMethodTip = configXML.labels.selectionmethodtip || "Click to change the selection method";
					NewSelectionMethodTip = configXML.labels.newselectionmethodtip || "Create new selection";
					AddSelectionMethodTip = configXML.labels.addselectionmethodtip || "Add to current selection";
					RemoveSelectionMethodTip = configXML.labels.removeselectionmethodtip || "Remove from current selection";
					lblInclueTextQuery = configXML.labels.includetextquery || "include text query in selection criteria";
					lblbufferUserGraphic = configXML.labels.bufferusergraphics || "Buffer Graphic";
					noRelatesFound = configXML.labels.norelatesfound || "No related features found";
					noRelatesFoundAlertTitle = configXML.labels.norelatesfoundalerttitle || "No Results";
					buffergrapicpropsLbl = configXML.labels.buffergrapicprops || "Buffer graphic properties";
					bufferColorLabel = configXML.labels.buffercolor || "Select buffer color";
					bufferAlphaLabel = configXML.labels.bufferalpha || "Adjust buffer alpha";
					nobuffercolorlbl = configXML.labels.nobuffercolor || "No fill color";
					bufferoutlinecolorlbl = configXML.labels.bufferoutlinecolor || "Outline color";
					nobufferoutlinecolorlbl = configXML.labels.nobufferoutlinecolor || "No outline color";
					bufferoutlinewidthlbl = configXML.labels.bufferoutlinewidth || "Outline Width";
					configbuffergraTip = configXML.labels.configbuffergra || "Configure buffer graphic properties...";
					lblTolerance = configXML.labels.addtolerance || "Add search tolerance to point selection";
					drawGraLabel = configXML.labels.existingdrawgraphicslabel || "Use Existing Enhanced Draw Widget Graphics";
					bufferGraLabel = configXML.labels.existingbuffergraphicslabel || "Use Existing Point Buffer Widget Graphics";
                    elocateGraLabel = configXML.labels.existinglocategraphicslabel || "Use Existing Enhanced Locate Widget Graphics";
					graphicalsearchLabel = configXML.labels.graphicalsearchlabel || "Graphical Search";
					textsearchLabel = configXML.labels.textsearchlabel || "Text Search";
					includetextquerywarnTip = configXML.labels.includetextquerywarn || "Must be the same search layer in both\ngraphical and text search pages.";
					resultsLabel = configXML.labels.resultslabel || "Results";
					layerLabel = configXML.labels.layerlabel || "Search Layer:";
					layerExprLabel = configXML.labels.layerfieldlabel || "Search Layer Field:";
					nolayerLabel = configXML.labels.nolayerlabel || "No search layer defined.";
					submitLabel = configXML.labels.submitlabel || "Search";
					pointLabel = configXML.labels.pointlabel || "Select by Point";
					lineLabel = configXML.labels.linelabel || "Select by Line";
					rectangleLabel = configXML.labels.rectanglelabel || "Select by Rectangle";
					polygonLabel = configXML.labels.polygonlabel || "Select by Polygon";
					clearLabel = configXML.labels.clearlabel || "Clear";
					zoomallLabel = configXML.labels.zoomalllabel || "Zoom";
					zoomallTip = configXML.labels.zoomalltip || "Zoom to all results";
					loadingLabel = configXML.labels.loadinglabel || "Loading...";
					selectionLabel = configXML.labels.selectionlabel || "Features Selected:";
					gridresultsLabel = configXML.labels.gridresultslabel || "Show Results in Grid";
					exp2csvOptLbl = configXML.labels.export2csvoptionlabel || "Export to CSV...";
					exp2txtOptLbl = configXML.labels.export2txtoptionlabel || "Export to Txt...";
					expBtnLbl = configXML.labels.exportbtnlabel || "Export...";
					_csvName = configXML.labels.csvdefaultname || "Selected Records";
					relatescsvName = configXML.labels.relatescsvdefaultname || "Related Records";
					csvSep = configXML.csvseparator;
					spatialsearchLabel = configXML.labels.spatialsearchlabel || "Spatial search";
					searchLayerLabel = configXML.labels.searchlayerlabel || "Search entities of:";
					bufferLabel = configXML.labels.bufferlabel || "apply a search distance:";
					applyBufferLabel = configXML.labels.applybufferlabel || "Apply buffer";
					relateToolTip = configXML.relatetooltip || "Show Relates";
					sReff = new SpatialReference(configXML.spatialreference);
					defaultSelectionOption = configXML.defaultselectionoption || "textInput";
					currentState = defaultSelectionOption;
					disableButtons = configXML.disablebuttons || "";
					selectedGraphicalTool = configXML.selectedgraphicaltool || "";
					enableMultiPartSearch = configXML.labels.enablemultipartsearch || "enable multi-part graphics";
					applyTolleranceByDefault = configXML.tolerancebydefault && configXML.tolerancebydefault == "true";
					widgetAndGridIteract = configXML.enabledatagridinteractionwithwidget && configXML.enabledatagridinteractionwithwidget == "true";
					requiredLbl = configXML.labels.required || "*";
					requiredTooltip = configXML.labels.requiredtooltip || "This field is required.&#13;Enter a value to enable search button";
					dgheaderbgcolor = configXML.printdatagrid.columnheaderbgcolor || 0xa7a7a7;
					dgrepeatheader = configXML.printdatagrid.addheadertoeachpage && configXML.printdatagrid.addheadertoeachpage == "true";
					dgheaderfontcolor = configXML.printdatagrid.columnheaderfontcolor || 0x000000;
					dgfooterincdate = configXML.printdatagrid.footer.includeprintdate && configXML.printdatagrid.footer.includeprintdate == "true";
					dgfooterdateformat = configXML.printdatagrid.footer.includeprintdate.@format || "MM-DD-YYYY L:NN A";
					dgfooterpageofpage = configXML.printdatagrid.footer.pageoftext || "page ## of ##";
					dgfooterdisclaimer = configXML.printdatagrid.footer.disclaimer || "";
					PopUpsDisabled = configXML.popupsdisabled && configXML.popupsdisabled == "true";
                    enableMutiGra = configXML.enablemultigraphicssearch && configXML.enablemultigraphicssearch == "true";
                    enableIncludeTextSearch = configXML.enableincludetextsearch && configXML.enableincludetextsearch == "true";
                    enableAddTollerance = configXML.enableaddtollerance && configXML.enableaddtollerance == "true";
                    enableGraphicsBuffering = configXML.enablegraphicsbuffering && configXML.enablegraphicsbuffering == "true";

					configSpatialSearchRelation = [];
					var operList:XMLList = configXML..spatialrelationship;
					var sOpBtn:Image;
					for (var s:Number = 0; s < operList.length(); s++){
						var srName:String = operList[s].name;
						var srLabel:String = operList[s].label;
						var spatialRelationship:Object = {
							name: srName,
							label: srLabel
						};
						sOpBtn = new Image();
						sOpBtn.name = srName;
						sOpBtn.source = getSopImg(srName);
						sOpBtn.toolTip = srLabel;
						sOpBtn.addEventListener(MouseEvent.CLICK, sOpBtnClickHandler);
						sOpBtn.useHandCursor = true;
						sOpBtn.buttonMode = true;
						SpatialOps.addElement(sOpBtn);
						configSpatialSearchRelation.push(spatialRelationship);
					}
					if(operList.length() == 0){
						lblSearchLayerSpatial.visible = false;
						cboSearchLayerSpatial.visible = false;
						SpatialOps.visible = false;
						lblSearchLayerSpatial.includeInLayout = false;
						cboSearchLayerSpatial.includeInLayout = false;
						SpatialOps.includeInLayout = false;
					}

					keepGraSearchEnabled = configXML.keepgraphicalsearchenabled && configXML.keepgraphicalsearchenabled == "true";
					autoZoom = configXML.autozoomtoresults && configXML.autozoomtoresults == "true";
					eDrawEnabled = configXML.enabledrawgraphicbutton && configXML.enabledrawgraphicbutton == "true";
                    eLocateEnabled = configXML.enablelocategraphicbutton && configXML.enablelocategraphicbutton == "true";
					pBufferEnabled = configXML.enablebuffergraphicbutton && configXML.enablebuffergraphicbutton == "true";
					multiPartGraphicSearch = configXML.multipartgraphicsearch && configXML.multipartgraphicsearch == "true";
					(multiPartGraphicSearch.valueOf() == true) ? graFeatureQueryBtn.visible = true : graFeatureQueryBtn.visible = false;
					floatorfixed = configXML.floatorfixed || "float";

					//Added 7/13/2011 PWA store path to web service
					integrationWebService = configXML.integrationWebService;
					parcelLayerName = configXML.parcelLayerName;
					parcelLayerPINFieldName = configXML.parcelLayerPINFieldName;
					//userid =  ExternalInterface.call("getUserID");
					userid = "101";
										
					portalIntegrationMethods = new mx.rpc.soap.mxml.WebService();
					portalIntegrationMethods.wsdl = integrationWebService;
					portalIntegrationMethods.BuildSqlResultsTable.addEventListener(ResultEvent.RESULT,BuildSqlResultsTableSuccess);
					portalIntegrationMethods.BuildSqlResultsTable.addEventListener(FaultEvent.FAULT,BuildSqlResultsTableFailure);
					portalIntegrationMethods.generateWhereClause.addEventListener(ResultEvent.RESULT,onPortalGenerateWhereClause);
					portalIntegrationMethods.generateWhereClause.addEventListener(FaultEvent.FAULT,generateWhereClauseFailure);
					portalIntegrationMethods.generateWhereClause.concurrency="last";
					portalIntegrationMethods.generateWhereClause.resultFormat="xml";

					portalIntegrationMethods.loadWSDL();
					portalIntegrationMethods.endpointURI = integrationWebService.replace('?wsdl','');
					
					if(eDrawEnabled){
						eDrawBtn.filters = [cOver];
						eDrawBtn.buttonMode = eDrawBtn.useHandCursor = eDrawBtn.enabled = false;
						map.addEventListener(MapEvent.LAYER_ADD, checkForeDrawGL);
						MapUtil.forEachMapLayer(map, function(layer:Layer):void
						{
							if(layer.name.toLowerCase() == "draw features"){
								drawGraphicsLayer = layer as GraphicsLayer;
								if(drawGraphicsLayer.numGraphics > 0){
									checkeDrawNumGras(null);
								}
								drawGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_ADD, checkeDrawNumGras);
								drawGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_REMOVE, checkeDrawNumGras);
								drawGraphicsLayer.addEventListener(GraphicsLayerEvent.GRAPHICS_CLEAR, checkeDrawNumGras);
							}
						});
					}
                    
                    if(eLocateEnabled){
                        eLocateBtn.filters = [cOver];
                        eLocateBtn.buttonMode = eLocateBtn.useHandCursor = eLocateBtn.enabled = false;
                        map.addEventListener(MapEvent.LAYER_ADD, checkForeLocateGL);
                        MapUtil.forEachMapLayer(map, function(layer:Layer):void
                        {
                            if(layer.name.toLowerCase() == "elocate features"){
                                locateGraphicsLayer = layer as GraphicsLayer;
                                if(locateGraphicsLayer.numGraphics > 0){
                                    checkeLocateNumGras(null);
                                }
                                locateGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_ADD, checkeLocateNumGras);
                                locateGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_REMOVE, checkeLocateNumGras);
                                locateGraphicsLayer.addEventListener(GraphicsLayerEvent.GRAPHICS_CLEAR, checkeLocateNumGras);
                            }
                        });
                    }

					if(pBufferEnabled){
						pBufferBtn.filters = [cOver];
						pBufferBtn.buttonMode = pBufferBtn.useHandCursor = pBufferBtn.enabled = false;
						map.addEventListener(MapEvent.LAYER_ADD, checkForpntBufferGL);
						MapUtil.forEachMapLayer(map, function(layer:Layer):void
						{
							if(layer.name.toLowerCase() == "buffer results"){
								bufferGraphicsLayer = layer as GraphicsLayer;
								if(bufferGraphicsLayer.numGraphics > 0){
									checkBufferNumGras(null);
								}
								bufferGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_ADD, checkBufferNumGras);
								bufferGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_REMOVE, checkBufferNumGras);
								bufferGraphicsLayer.addEventListener(GraphicsLayerEvent.GRAPHICS_CLEAR, checkBufferNumGras);
							}
						});
					}

					configBufferUnits = [];
					var bufferUnitsList:XMLList = configXML..bufferunit;
					var ddSelIndx:int = -1;
					for (var b:int = 0; b < bufferUnitsList.length(); b++){
						var buffUnitName:String = bufferUnitsList[b].name;
						var buffUnitLabel:String = bufferUnitsList[b].label;
						if(bufferUnitsList[b].@selected && bufferUnitsList[b].@selected == "true"){
							ddSelIndx = b;
						}
						var bufferUnit:Object = {
							name: buffUnitName,
							label: buffUnitLabel
						};
						configBufferUnits.push(bufferUnit);
					}
					cboGraBufferUnit.dataProvider = new ArrayCollection(configBufferUnits);
					cboGraBufferUnit.width = determineDropDownWidth(configBufferUnits);
					if((cboGraBufferUnit.width + 102 + bufferUserGraphic.measureText(lblbufferUserGraphic).width + 37) > wTemplate.width){
						cboGraBufferUnit.width = (wTemplate.width - (102 + bufferUserGraphic.measureText(lblbufferUserGraphic).width + 37));
					}
					cboGraBufferUnit.selectedIndex = ddSelIndx;
					BuffValue = configXML.buffervalue || "50";

					//marker symbol
					if(configXML.symbols.picturemarkersymbol.@url[0] != null){
						const resultMarkerSymbolURL:String = configXML.symbols.picturemarkersymbol.@url || widgetIcon;
						const resultMarkerSymbolHeight:Number = (configXML.symbols.picturemarkersymbol.@height[0] != null) ? configXML.symbols.picturemarkersymbol.@height : 30;
						const resultMarkerSymbolWidth:Number = (configXML.symbols.picturemarkersymbol.@width[0] != null) ? configXML.symbols.picturemarkersymbol.@width : 30;
						const resultMarkerSymbolXOffset:Number = (configXML.symbols.picturemarkersymbol.@xoffset[0] != null) ? configXML.symbols.picturemarkersymbol.@xoffset : 0;
						const resultMarkerSymbolYOffset:Number = (configXML.symbols.picturemarkersymbol.@yoffset[0] != null) ? configXML.symbols.picturemarkersymbol.@yoffset : 0;
						const resultMarkerSymbolAngle:Number = (configXML.symbols.simplemarkersymbol.@angle[0] != null) ? configXML.symbols.simplemarkersymbol.@angle : 0;
						resultMarkerSymbol = new PictureMarkerSymbol(resultMarkerSymbolURL, resultMarkerSymbolWidth, resultMarkerSymbolHeight, resultMarkerSymbolXOffset, resultMarkerSymbolYOffset, resultMarkerSymbolAngle);
					}else{
						const resultMarkerSymbolStyle:String = configXML.symbols.simplemarkersymbol.@style || "circle";
						const resultMarkerSymbolSize:Number = (configXML.symbols.simplemarkersymbol.@size[0] != null) ? configXML.symbols.simplemarkersymbol.@size : 15;
						const resultMarkerSymbolColor:uint = (configXML.symbols.simplemarkersymbol.@color[0] != null) ? configXML.symbols.simplemarkersymbol.@color : 0xFF0000;
						const resultMarkerSymbolAlpha:Number = (configXML.symbols.simplemarkersymbol.@alpha[0] != null) ? configXML.symbols.simplemarkersymbol.@alpha : 0.8;
						const resultMarkerSymbolXOffset2:Number = (configXML.symbols.simplemarkersymbol.@xoffset[0] != null) ? configXML.symbols.simplemarkersymbol.@xoffset : 0;
						const resultMarkerSymbolYOffset2:Number = (configXML.symbols.simplemarkersymbol.@yoffset[0] != null) ? configXML.symbols.simplemarkersymbol.@yoffset : 0;
						const resultMarkerSymbolAngle2:Number = (configXML.symbols.simplemarkersymbol.@angle[0] != null) ? configXML.symbols.simplemarkersymbol.@angle : 0;
						const resultMarkerSymbolOutlineStyle:String = configXML.symbols.simplemarkersymbol.outline.@style || "solid";
						const resultMarkerSymbolOutlineColor:uint = (configXML.symbols.simplemarkersymbol.outline.@color[0] != null) ? configXML.symbols.simplemarkersymbol.outline.@color : 0x0000ff;
						const resultMarkerSymbolOutlineAlpha:Number = (configXML.symbols.simplemarkersymbol.outline.@alpha[0] != null) ? configXML.symbols.simplemarkersymbol.outline.@alpha : 0.8;
						const resultMarkerSymbolOutlineWidth:Number = (configXML.symbols.simplemarkersymbol.outline.@width[0] != null) ? configXML.symbols.simplemarkersymbol.outline.@width : 2;
						resultMarkerSymbol = new SimpleMarkerSymbol(resultMarkerSymbolStyle,resultMarkerSymbolSize,resultMarkerSymbolColor,resultMarkerSymbolAlpha,resultMarkerSymbolXOffset2,resultMarkerSymbolYOffset2,resultMarkerSymbolAngle2,new SimpleLineSymbol(resultMarkerSymbolOutlineStyle, resultMarkerSymbolOutlineColor, resultMarkerSymbolOutlineAlpha, resultMarkerSymbolOutlineWidth));
					}

					//Symbol for stand alone tables
					resultSATSymbol = new PictureMarkerSymbol(satClass,20,20);

					//line symbol
					const resultLineSymbolColor:uint = (configXML.symbols.simplelinesymbol.@color[0] != null) ? configXML.symbols.simplelinesymbol.@color : 0xFF0000;
					const resultLineSymbolAlpha:Number = (configXML.symbols.simplelinesymbol.@alpha[0] != null) ? configXML.symbols.simplelinesymbol.@alpha : 0.8;
					const resultLineSymbolWidth:Number = (configXML.symbols.simplelinesymbol.@width[0] != null) ? configXML.symbols.simplelinesymbol.@width : 2;
					resultLineSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, resultLineSymbolColor, resultLineSymbolAlpha, resultLineSymbolWidth);

					// fill symbol
					const resultFillSymbolColor:uint = (configXML.symbols.simplefillsymbol.@color[0] != null) ? configXML.symbols.simplefillsymbol.@color : 0xFF0000;
					const resultFillSymbolAlpha:Number = (configXML.symbols.simplefillsymbol.@alpha[0] != null) ? configXML.symbols.simplefillsymbol.@alpha : 0.5;
					const resultFillSymbolOutlineColor:uint = (configXML.symbols.simplefillsymbol.outline.@color[0] != null) ? configXML.symbols.simplefillsymbol.outline.@color : 0xFF0000;
					const resultFillSymbolOutlineAlpha:Number = (configXML.symbols.simplefillsymbol.outline.@alpha[0] != null) ? configXML.symbols.simplefillsymbol.outline.@alpha : 0.8;
					const resultFillSymbolOutlineWidth:Number = (configXML.symbols.simplefillsymbol.outline.@width[0] != null) ? configXML.symbols.simplefillsymbol.outline.@width : 2;
					resultFillSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, resultFillSymbolColor, resultFillSymbolAlpha, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, resultFillSymbolOutlineColor, resultFillSymbolOutlineAlpha, resultFillSymbolOutlineWidth));

					configSearchGraphical = [];
					configSearchText = [];
					configSpatialSearchLayers = [];
					configDomainVals = [];
					var r:Number;
					var i:Number;
					var j:Number;
					var l:Number;
					var v:Number;
					var lyrList:XMLList = configXML..layer;
					for (i = 0; i < lyrList.length(); i++){
						configLayerExprs = [];
						configLayerRels = [];
						var lyrURL:String = lyrList[i].url;
						var lyrToken:String = lyrList[i].token;
						var lyrLabel:String = lyrList[i].name;
						var lyrGraphicalLabel:String = lyrList[i].graphicalsearchlabel;
						var lyrRelList:XMLList = configXML.layers.layer[i]..relate;
						for (r = 0; r < lyrRelList.length(); r++){
							var lyrRelLabel:String = lyrRelList[r].@label;
							var lyrRelId:String = lyrRelList[r].@id;
							var lyrRelIcon:String = lyrRelList[r].@icon || WIDGET_URL + "i_relate.png";
							var lyrRelFields:XMLList = lyrRelList[r].fields;
							var lyrRelEnableExport:Boolean = lyrRelList[r].@enableexport && lyrRelList[r].@enableexport == "true";
							var lyrRelEnablePrint:Boolean = lyrRelList[r].@enableprintgrid && lyrRelList[r].@enableprintgrid == "true";
							var lyrRelPrintTitle:String = lyrRelList[r].@printtitle || "";
                            var lyrRelZoomScale:Number;
                            var lyrRelZoomPercent:Number;
                            if ((lyrRelList[r].zoomscale.@usegeometry) && (lyrRelList[r].zoomscale.@usegeometry == "true")){
                                lyrRelZoomScale = Number.NaN;
                                if(lyrRelList[r].zoomscale.@zoompercent){
                                    lyrRelZoomPercent = Number(lyrRelList[r].zoomscale.@zoompercent)
                                }else{
                                    lyrRelZoomPercent = 1.2
                                }
                            }else{
                                if (Number(lyrRelList[r].zoomscale) > 0){
                                    lyrRelZoomScale = Number(lyrRelList[r].zoomscale);
                                }
                            }
							var lyrRel:Object = {
								id: lyrRelId,
								fields: lyrRelFields,
								label: lyrRelLabel,
								enableexport: lyrRelEnableExport,
								enableprint: lyrRelEnablePrint,
                                zoomscale: lyrRelZoomScale,
                                zoompercent: lyrRelZoomPercent,
								icon: lyrRelIcon,
								printtitle: lyrRelPrintTitle
							};
							configLayerRels.push(lyrRel);
						}
						var lyrExprList:XMLList = configXML.layers.layer[i]..expression;
						for (j = 0; j < lyrExprList.length(); j++){
							var lyrExprAlias:String = lyrExprList[j].@alias;
							var lyrTextLabel:String = lyrExprList[j].@textsearchlabel;
							var lyrRequiresAValue:Boolean = lyrExprList[j].@isvaluerequired && lyrExprList[j].@isvaluerequired == "true";
							var lyrExprVals:XMLList = lyrExprList[j]..value;
							configLayerExprsVals = [];
							for (v = 0; v < lyrExprVals.length(); v++){
								var valPrompt:String = lyrExprVals[v].@prompt;
								var valExpr:String = lyrExprVals[v];
								var valField:String = lyrExprVals[v].@field;
								var valUserList:String = lyrExprVals[v].@userlist;
								var valUniqueFromField:String = lyrExprVals[v].@uniquevalsfromfield;
								var valDomain:Boolean = lyrExprVals[v].@usedomain && lyrExprVals[v].@usedomain == "true";
                                var valDisableAutoSubmit:Boolean = lyrExprVals[v].@autosubmit && lyrExprVals[v].@autosubmit == "false";
								var valSubType:Boolean = lyrExprVals[v].@usesubtype && lyrExprVals[v].@usesubtype == "true";
								var valDateFormat:String = lyrExprVals[v].@dateformat || "";
								var valUseUTC:Boolean = lyrExprVals[v].@useutc && lyrExprVals[v].@useutc == "true";
								// if config is given and set to false explicitly, then make it optional (aka not required). Otherwise, default to being required
								var isOptional:Boolean = lyrExprVals[v].@isvaluerequired && lyrExprVals[v].@isvaluerequired == "false";
								var operatorValue:String =  lyrExprVals[v].@operator;
								var exprVals:Object = {
									prompt:valPrompt,
									expression:valExpr,
									field:valField,
									usedomain:valDomain,
									userlist:valUserList,
									uniquevalsfromfield:valUniqueFromField,
									isvaluerequired:!isOptional,
                                    disableautosubmit:valDisableAutoSubmit,
									operator:operatorValue,
									usesubtype:valSubType,
									dateformat:valDateFormat,
									useutc:valUseUTC
								};
								configLayerExprsVals.push(exprVals)
							}
							var expr:Object = {
								label: lyrExprAlias,
								textlabel: lyrTextLabel,
								values: configLayerExprsVals,
								isvaluerequired : lyrRequiresAValue
							};
							configLayerExprs.push(expr);
						}
						var lyrDefExpr:String = lyrList[i].definitionexpression;
						var lyrFields:XMLList = lyrList[i].fields;
						var lyrTitleField:String = lyrList[i].titlefield;

						var lyrLinks:Array = [];
						var lyrLinkList:XMLList = lyrList[i]..link;
						for (l = 0; l < lyrLinkList.length(); l++){
							var lyrLink:String = XML(lyrLinkList[l]).text() || "";
							var lyrLinkAlias:String = lyrLinkList[l].@alias || "";
							var lyrLinkdisableIfNull:Boolean = lyrLinkList[l].@disablelinksifnull && lyrLinkList[l].@disablelinksifnull == "true";
							var lyrIcon:String = XML(lyrLinkList[l]).child("icon") || "";
							var linkObj:Object = {
								link: lyrLink,
								alias: lyrLinkAlias,
								icon: lyrIcon,
								disablelinksifnull: lyrLinkdisableIfNull
							};
							lyrLinks.push(linkObj);
						}
						var lyrQueryAttach:Boolean = lyrList[i].queryattachments && lyrList[i].queryattachments == "true";
						var lyrEnableExport:Boolean = lyrList[i].enableexport && lyrList[i].enableexport == "true";
						var lyrEnablePrint:Boolean = lyrList[i].enableprintgrid && lyrList[i].enableprintgrid == "true";
						var lyrPrintTitle:String = "";
						if(lyrEnablePrint){
							lyrPrintTitle = lyrList[i].enableprintgrid.@title || "";
						}
						var lyrMultiImgField:String = lyrList[i].multiimagefield;
						var useProxy:Boolean = lyrList[i].useproxy && lyrList[i].useproxy == "true";
						var useAMF:String = lyrList[i].useamf;
						var openDG:Boolean = lyrList[i].autoopendatagrid && lyrList[i].autoopendatagrid == "true";
						if ((lyrList[i].zoomscale.@usegeometry) && (lyrList[i].zoomscale.@usegeometry == "true")){
							zoomScale = Number.NaN;
							if(lyrList[i].zoomscale.@zoompercent){
								zoomPercent = Number(lyrList[i].zoomscale.@zoompercent)
							}else{
								zoomPercent = 1.2
							}
						}else{
							if (Number(lyrList[i].zoomscale) > 0){
								zoomScale = Number(lyrList[i].zoomscale);
							}
						}

						var lyrSpatialLabel:String = lyrList[i].spatialquerylabel;
						var lyrSpatialSearchLyr:Boolean = lyrList[i].spatialsearchlayer && lyrList[i].spatialsearchlayer == "true";
//This is where I need to get a token from the Identity Manager if one is not provided
						if(IdentityManager.instance.enabled){
							var cred:Credential = IdentityManager.instance.findCredential(lyrURL);
							if (cred && lyrToken == ""){
								lyrToken = cred.token;
							}
						}
						const layer:FeatureLayer = new FeatureLayer(lyrURL, null, (lyrToken != "")?lyrToken:null);
//
						layer.name = layer.id = "hiddenLayer_" + lyrLabel;
                        layer.selectionColor = NaN;
						layer.mode = FeatureLayer.MODE_SELECTION;
						if (useProxy && configData.proxyUrl){
							layer.proxyURL = configData.proxyUrl;
						}
						if (useAMF){
							layer.useAMF = useAMF == "true";
						}
						if (lyrFields && lyrFields[0].@all[0] == "true"){
							layer.outFields = ["*"];
						}else if (lyrFields){
							var fields:XMLList = lyrFields.field;
							layer.outFields = [];
							for each (var fieldXML:XML in fields){
								if (fieldXML.@name[0]){
									layer.outFields.push(fieldXML.@name[0]);
								}
							}
						}

						var lyrSymbol:Symbol = getLayerSymbology(lyrList[i]);
						if(lyrSymbol){
							layer.renderer = new SimpleRenderer(lyrSymbol);
						}

						var searchLayer:Object = {
							layer: layer,
							label: lyrLabel,
							titlefield: lyrTitleField,
							spatialsearchlabel: lyrSpatialLabel,
							spatialsearchlayer: lyrSpatialSearchLyr,
							graphicallabel: lyrGraphicalLabel,
							expr: configLayerExprs,
							fields: lyrFields,
							links: lyrLinks,
							multi: lyrMultiImgField,
							zoomscale: zoomScale,
							zoompercent: zoomPercent,
							enableexport: lyrEnableExport,
							enableprint: lyrEnablePrint,
							printtitle: lyrPrintTitle,
							defexpr: lyrDefExpr,
							opendg: openDG,
							relates: configLayerRels,
							attachments: lyrQueryAttach,
							symbology: lyrSymbol
						};
						configSearchGraphical.push(searchLayer);

						if (searchLayer.spatialsearchlayer){
							configSpatialSearchLayers.push(searchLayer);
						}
						if (configLayerExprs && configLayerExprs.length > 0){
							configSearchText.push(searchLayer);
						}
					}

					var tblList:XMLList = configXML..table;
					for (i = 0; i < tblList.length(); i++){
						configTableExprs = [];
						configTableRels = [];
						var tblURL:String = tblList[i].url;
						var tblToken:String = tblList[i].token;
						var tblLabel:String = tblList[i].name;
						var tblRelList:XMLList = configXML.tables.table[i]..relate;
						for (r = 0; r < tblRelList.length(); r++){
							var tblRelLabel:String = tblRelList[r].@label;
							var tblRelId:String = tblRelList[r].@id;
							var tblRelIcon:String = tblRelList[r].@icon || WIDGET_URL + "i_relate.png";
							var tblRelFields:XMLList = tblRelList[r].fields;
							var tblRelEnableExport:Boolean = tblRelList[r].@enableexport && tblRelList[r].@enableexport == "true";
							var tblRelEnablePrint:Boolean = tblRelList[r].@enableprintgrid && tblRelList[r].@enableprintgrid == "true";
                            var tblRelZoomScale:Number;
                            var tblRelZoomPercent:Number;
                            if ((tblRelList[r].zoomscale.@usegeometry) && (tblRelList[r].zoomscale.@usegeometry == "true")){
                                tblRelZoomScale = Number.NaN;
                                if(tblRelList[r].zoomscale.@zoompercent){
                                    tblRelZoomPercent = Number(tblRelList[r].zoomscale.@zoompercent)
                                }else{
                                    tblRelZoomPercent = 1.2
                                }
                            }else{
                                if (Number(tblRelList[r].zoomscale) > 0){
                                    tblRelZoomScale = Number(tblRelList[r].zoomscale);
                                }
                            }
							var tblRelPrintTitle:String = tblRelList[r].@printtitle;
							var tblRel:Object = {
								id: tblRelId,
								fields: tblRelFields,
								label: tblRelLabel,
								enableexport: tblRelEnableExport,
								enableprint: tblRelEnablePrint,
                                zoomscale: tblRelZoomScale,
                                zoompercent: tblRelZoomPercent,
								icon: tblRelIcon,
								printtitle: tblRelPrintTitle
							};
							configTableRels.push(tblRel);
						}
						var tblExprList:XMLList = configXML.tables.table[i]..expression;
						for (j = 0; j < tblExprList.length(); j++){
							var tblExprAlias:String = tblExprList[j].@alias;
							var tblTextLabel:String = tblExprList[j].@textsearchlabel;
							var tblRequiresAValue:Boolean = tblExprList[j].@isvaluerequired && tblExprList[j].@isvaluerequired == "true";
							var tblExprVals:XMLList = tblExprList[j]..value;
							configTableExprsVals = [];
							for (v = 0; v < tblExprVals.length(); v++){
								var tblPrompt:String = tblExprVals[v].@prompt;
								var tblExpr:String = tblExprVals[v];
								var tblField:String = tblExprVals[v].@field;
								var tblUserList:String = tblExprVals[v].@userlist;
								var tblUniqueFromField:String = tblExprVals[v].@uniquevalsfromfield;
								var tblDomain:Boolean = tblExprVals[v].@usedomain && tblExprVals[v].@usedomain == "true";
								var tblSubType:Boolean = tblExprVals[v].@usesubtype && tblExprVals[v].@usesubtype == "true";
								var tblDateFormat:String = tblExprVals[v].@dateformat || "";
                                var tblDisableAutoSubmit:Boolean = tblExprVals[v].@autosubmit && tblExprVals[v].@autosubmit == "false";
								var tblUseUTC:Boolean = tblExprVals[v].@useutc && tblExprVals[v].@useutc == "true";
								// if config is given and set to false explicitly, then make it optional (aka not required). Otherwise, default to being required
								var isOptionalt:Boolean = tblExprVals[v].@isvaluerequired && tblExprVals[v].@isvaluerequired == "false";
								var operatorValuet:String =  tblExprVals[v].@operator;
								var tblexprVals:Object = {
									prompt: tblPrompt,
									expression: tblExpr,
									field: tblField,
									usedomain: tblDomain,
									userlist: tblUserList,
									uniquevalsfromfield: tblUniqueFromField,
									isvaluerequired: !isOptionalt,
                                    disableautosubmit: tblDisableAutoSubmit,
									operator: operatorValuet,
									usesubtype: tblSubType,
									dateformat: tblDateFormat,
									useutc: tblUseUTC
								};
								configTableExprsVals.push(tblexprVals)
							}
							var tblexpr:Object ={
								label: tblExprAlias,
								textlabel: tblTextLabel,
								values: configTableExprsVals,
								isvaluerequired : tblRequiresAValue
							};
							configTableExprs.push(tblexpr);
						}
						var tblDefExpr:String = tblList[i].definitionexpression;
						var tblFields:XMLList = tblList[i].fields;
						var tblTitleField:String = tblList[i].titlefield;

						var tblLinks:Array = [];
						var tblLinkList:XMLList = tblList[i]..link;
						for (l = 0; l < tblLinkList.length(); l++){
							var tblLink:String = XML(tblLinkList[l]).text() || "";
							var tblLinkAlias:String = tblLinkList[l].@alias || "";
							var tblLinkdisableIfNull:Boolean = tblLinkList[l].@disablelinksifnull && tblLinkList[l].@disablelinksifnull == "true";
							var tblIcon:String = XML(tblLinkList[l]).child("icon") || "";
							var tbllinkObj:Object = {
								link: tblLink,
								alias: tblLinkAlias,
								icon: tblIcon,
								disablelinksifnull: tblLinkdisableIfNull
							};
							tblLinks.push(tbllinkObj);
						}
						var tblEnableExport:Boolean = tblList[i].enableexport && tblList[i].enableexport == "true";
						var tblEnablePrint:Boolean = tblList[i].enableprintgrid && tblList[i].enableprintgrid == "true";
						var tblPrintTitle:String ="";
						if(tblEnablePrint){
							tblPrintTitle = tblList[i].enableprintgrid.@title || "";
						}
						var tblMultiImgField:String = tblList[i].multiimagefield;
						var tbluseProxy:Boolean = tblList[i].useproxy && tblList[i].useproxy == "true";
						var tbluseAMF:String = tblList[i].useamf;
						var tblopenDG:Boolean = tblList[i].autoopendatagrid && tblList[i].autoopendatagrid == "true";
						var tblQueryAttach:Boolean = tblList[i].@queryattachments && tblList[i].@queryattachments == "true";
//This is where I need to get the token from the Identity Manger if one is not provided
						if(IdentityManager.instance.enabled){
							var tcred:Credential = IdentityManager.instance.findCredential(tblURL);
							if (tcred && tblToken == ""){
								tblToken = tcred.token;
							}
						}
						var table:FeatureLayer = new FeatureLayer(tblURL, null, (tblToken != "")?tblToken:null);
///
						if (useProxy && configData.proxyUrl){
							table.proxyURL = configData.proxyUrl;
						}
						if (useAMF){
							table.useAMF = useAMF == "true";
						}
						if (tblFields && tblFields[0].@all[0] == "true"){
							table.outFields = ["*"];
						}else if (tblFields){
							var tblfields:XMLList = tblFields.field;
							table.outFields = [];
							for each (var tblfieldXML:XML in tblfields){
								if (tblfieldXML.@name[0]){
									table.outFields.push(tblfieldXML.@name[0]);
								}
							}
						}

						var searchTable:Object = {
							table: table,
							label: tblLabel,
							titlefield: tblTitleField,
							expr: configTableExprs,
							fields: tblFields,
							links: tblLinks,
							multi: tblMultiImgField,
							enableexport: tblEnableExport,
							enableprint: tblEnablePrint,
							printtitle: tblPrintTitle,
                            zoomscale: zoomScale,
                            zoompercent: zoomPercent,
							defexpr: tblDefExpr,
							opendg: tblopenDG,
							relates: configTableRels,
							attachments: tblQueryAttach
						};

						if (configTableExprs && configTableExprs.length > 0){
							configSearchText.push(searchTable);
						}
					}

					graphicsLayerBuffer = new GraphicsLayer();
					graphicsLayerBuffer.name = "Search Buffer Results";
					map.addLayer(graphicsLayerBuffer);

					graGraphicsLayer = new GraphicsLayer();
					graGraphicsLayer.name = "Graphical Search Layer";
					map.addLayer(graGraphicsLayer);

					var userTolerance:Number = Number(configXML.toleranceforpointgraphicalselection);
					if (userTolerance > 0){
						pointSearchTolerance = userTolerance;
					}
					if (selectedGraphicalTool != "" && defaultSelectionOption == "graphicalInput"){
						activateSearchTool(null, selectedGraphicalTool);
					}
				}

				if(disableButtons != ""){
					var dbArr:Array = disableButtons.split(",");
				}
				var disText:Boolean = false;
				var disGra:Boolean = false;
				var disSpat:Boolean = false;
				var disDataGrid:Boolean = false;

				if(dbArr){
					for (var d:int = 0; d<dbArr.length; d++){
						switch (dbArr[d]){
							case "text":{
								disText = true;
								break;
							}
							case "graphic":{
								disGra = true;
								break;
							}
							case "spatial":{
								disSpat = true;
								break;
							}
							case "grid":{
								disGrid = true;
								break;
							}
							case "datagrid":{
								disDataGrid = true;
								break;
							}
							case "result":{
								disResult = true;
								break;
							}
						}
					}
				}
				if(disGrid || disResult ){
					widgetAndGridIteract = false;
				}
				if(floatorfixed != "fixed" && !disDataGrid){
					wTemplate.addTitlebarButton(WIDGET_URL + "i_table2.png", gridresultsLabel,showGridResults,false);
				}
				if(!disGra){
					wTemplate.addTitlebarButton(ICON_URL + "search_graphic.png", graphicalsearchLabel, showStateGraphicalSearch);
				}
				if (configSearchText.length && disText != true){
					wTemplate.addTitlebarButton(ICON_URL + "search_text.png", textsearchLabel, showStateTextSearch);
				}
				if (configSpatialSearchLayers.length && disSpat != true){
					wTemplate.addTitlebarButton(ICON_URL + "search_spatial.png", spatialsearchLabel, showStateSpatialSearch);
				}
				if(!disGrid && !disResult ){
					wTemplate.addTitlebarButton(ICON_URL + "i_table.png", resultsLabel, showStateResults);
				}

				//Setup Text Search
				var sItemVal:SearchExpValueItem;
				if (configSearchText.length){
					cboLayerText.dataProvider = new ArrayCollection(configSearchText);
					cboLayerText.width = determineDropDownWidth(configSearchText);
					if((cboLayerText.width + lblLayerText.measureText(layerLabel).width + 122) > wTemplate.width){
						cboLayerText.width = (wTemplate.width - (lblLayerText.measureText(layerLabel).width + 122));
					}
					cboLayerText.selectedIndex = 0;
					txtLabelText.text = configSearchText[0].expr[0].textlabel;

					for(v=0; v<configSearchText[0].expr[0].values.length; v++){
						var cfg:Object = configSearchText[0].expr[0].values[v];
						if(v == 0){
							sItemVal = searchGroup.getElementAt(0) as SearchExpValueItem;
							sItemVal.changeToTextBox();
							sItemVal.setPrompt = cfg.prompt;
                            sItemVal.isAutoSubmitdisabled = cfg.disableautosubmit;
							sItemVal.isValueRequired = cfg.isvaluerequired;// set the required property from the config
							sItemVal.setRequiredText = requiredLbl;
							sItemVal.setRequiredTooltip = requiredTooltip;
							if (cfg.operator){
								sItemVal.operator = cfg.operator;
							};
							sItemVal.addEventListener("valueChanged", onValueChanged);
							sItemVal.addEventListener("submitSearch", onSearchSubmitted);
							sItemVal.addEventListener(FocusEvent.FOCUS_IN, searchGroupItem_focusInHandler);
						}else{
							sItemVal = new SearchExpValueItem;
							sItemVal.wTemplateWidth = wTemplate.width;
							sItemVal.percentWidth = 100;
							sItemVal.setPrompt = cfg.prompt;
                            sItemVal.isAutoSubmitdisabled = cfg.disableautosubmit;
							sItemVal.isValueRequired = cfg.isvaluerequired;// set the required property from the config
							sItemVal.setRequiredText = requiredLbl;
							sItemVal.setRequiredTooltip = requiredTooltip;
							if (cfg.operator){
								sItemVal.operator = cfg.operator;
							};
							sItemVal.addEventListener("valueChanged", onValueChanged);
							sItemVal.addEventListener("submitSearch", onSearchSubmitted);
							sItemVal.addEventListener(FocusEvent.FOCUS_IN, searchGroupItem_focusInHandler);
                            if ((v%2) == 1) {
                                sItemVal.setBGcolor = getStyle('rolloverColor');
                            }
							searchGroup.addElement(sItemVal);
						}

						if(configSearchText[0].expr[0].values[v].usedomain){
							popCBwithDomain(configSearchText[0].expr[0].values[v].field, sItemVal);
						}else if(configSearchText[0].expr[0].values[v].userlist != ""){
							popCBwithUserList(configSearchText[0].expr[0].values[v].userlist, sItemVal);
						}else if(configSearchText[0].expr[0].values[v].usesubtype){
							popCBwithSubType(sItemVal);
						}else if(configSearchText[0].expr[0].values[v].uniquevalsfromfield != ""){
							var uFld:String = configSearchText[0].expr[0].values[v].uniquevalsfromfield;
							var uDateFormat:String = configSearchText[0].expr[0].values[v].dateformat;
							var uUseUTC:Boolean = configSearchText[0].expr[0].values[v].useutc;
							if(!pagingQueryTask.isQuerying && (configSearchText[0].layer)?configSearchText[0].layer.loaded:configSearchText[0].table.loaded){
								popCBwithUnique(uFld, sItemVal, uDateFormat, uUseUTC);
							}else{
								//add this field to the Que
								var queObj:Object = {
									ufld: uFld,
									sitemval: sItemVal,
									udatefmt: uDateFormat,
									uuseutc: uUseUTC
								}
								popCBwithUniqueQue.push(queObj);
							}
						}
					}

					if (configSearchText.length == 1){
						lblLayerText.text += ("  " + configSearchText[0].label);
						cboLayerText.visible = false;
						cboLayerText.includeInLayout = false;
					}
					cboLayerExpr.dataProvider = new ArrayCollection(configSearchText[0].expr);
					cboLayerExpr.width = determineDropDownWidth(configSearchText[0].expr);
					if((cboLayerExpr.width + lblExprText.measureText(layerExprLabel).width + 57) > wTemplate.width){
						cboLayerExpr.width = (wTemplate.width - (lblExprText.measureText(layerExprLabel).width + 57));
					}
					cboLayerExpr.selectedIndex = 0;
					if (configSearchText[0].expr.length == 1){
						boxTextexpr.visible = false;
						boxTextexpr.includeInLayout = false;
					}
				}else{
					boxText.visible = false;
					txtLabelText.text = nolayerLabel;
				}

				//Setup Graphical Search
				if (configSearchGraphical.length){
					cboLayerGraphical.dataProvider = new ArrayCollection(configSearchGraphical);
					cboLayerGraphical.width = determineDropDownWidth(configSearchGraphical);
					if((cboLayerGraphical.width + lblLayerGraphical.measureText(layerLabel).width + 57) > wTemplate.width){
						cboLayerGraphical.width = wTemplate.width - (lblLayerGraphical.measureText(layerLabel).width + 57);
					}
					cboLayerGraphical.selectedIndex = 0;
					txtLabelGraphical.text = configSearchGraphical[0].graphicallabel;
					if (configSearchGraphical.length == 1){
						lblLayerGraphical.text += ("  " + configSearchGraphical[0].label);
						cboLayerGraphical.visible = false;
						cboLayerGraphical.includeInLayout = false;
					}
				}else{
					boxGraphical.visible = false;
					txtLabelGraphical.text = nolayerLabel;
				}

				if (configSpatialSearchLayers.length){
					cboSearchLayerSpatial.dataProvider = new ArrayCollection(configSpatialSearchLayers);
					cboSearchLayerSpatial.width = determineDropDownWidth(configSpatialSearchLayers);
					if(cboSearchLayerSpatial.width > (wTemplate.width - 57)){
						cboSearchLayerSpatial.width = (wTemplate.width - 57);
					}
					cboSearchLayerSpatial.selectedIndex = 0;
					cboBufferUnit.dataProvider = new ArrayCollection(configBufferUnits);
					cboBufferUnit.width = determineDropDownWidth(configBufferUnits);
					if((cboBufferUnit.width + 117) > wTemplate.width){
						cboBufferUnit.width = (wTemplate.width - 117);
					}
					cboBufferUnit.selectedIndex = cboGraBufferUnit.selectedIndex;
				}

				//Determine which button to select based on the default selection option
				for(var tb:int=0; tb < wTemplate.headerToolGroup.numElements; tb++){
					var tbb:TitlebarButton = wTemplate.headerToolGroup.getElementAt(tb) as TitlebarButton;
					if(tbb.toolTip == graphicalsearchLabel && defaultSelectionOption == "graphicalInput"){
						wTemplate.selectedTitlebarButtonIndex = tb;
					}
					if(tbb.toolTip == textsearchLabel && defaultSelectionOption == "textInput"){
						wTemplate.selectedTitlebarButtonIndex = tb;
					}
					if(tbb.toolTip == spatialsearchLabel && defaultSelectionOption == "spatialInput"){
						wTemplate.selectedTitlebarButtonIndex = tb;
					}
				}

				AppEvent.addListener(AppEvent.DATA_PUBLISH, sharedDataUpdated);

				if(ViewerContainer.urlConfigParams.esearch != null){
					callLater(queryFromURL,[ViewerContainer.urlConfigParams.esearch,ViewerContainer.urlConfigParams.slayer,ViewerContainer.urlConfigParams.exprnum]);
				}
				wTemplate.visible = true;
				wTemplate.header.addEventListener(MouseEvent.CLICK, DisplayVersion);
				searchBtn.addEventListener(MouseEvent.CLICK, equeryFeaturesText);

				// a new (default) search form is shown
				onSearchFormChanged();

				/* If the first layer has qued popCBwithUniques and is yet to be loaded then
				once it is loaded get those popCBwithUniques */
				var fFeatLayer:FeatureLayer = (configSearchText[0].layer)?configSearchText[0].layer:configSearchText[0].table;
				if(fFeatLayer){
					fFeatLayer.addEventListener(LayerEvent.LOAD, queryLayer_loadHandler);
					function queryLayer_loadHandler(event:LayerEvent):void
					{
						if(popCBwithUniqueQue.length > 0){
							var arr:Object = popCBwithUniqueQue.shift();
							popCBwithUnique(arr.ufld, arr.sitemval, arr.udatefmt, arr.uuseutc);
						}
						if(configSearchText[0].layer && !configSearchText[0].symbology){
							var gType:String = (event.layer as FeatureLayer).layerDetails.geometryType;
							switch (gType){
								case Geometry.MAPPOINT:{
									lyrSymbol = resultMarkerSymbol;
									break;
								}
								case Geometry.POLYLINE:{
									lyrSymbol = resultLineSymbol;
									break;
								}
								case Geometry.POLYGON:{
									lyrSymbol = resultFillSymbol;
									break;
								}
							}
							configSearchText[0].symbology = lyrSymbol;
							fFeatLayer.renderer = new SimpleRenderer(lyrSymbol);
						}
					}
				}
			}

			
						/*
			* If a layer has specific symbology set in the eSearchWidget.xml then use it instead of the default symbology
			*/
			private function getLayerSymbology(lyrList:XML):Symbol
			{
				var retSym:Symbol = null;

				if(lyrList.symbology.picturemarkersymbol[0] || lyrList.symbology.simplemarkersymbol[0]){
					//marker symbol
					if(lyrList.symbology.picturemarkersymbol.@url[0] != null){
						const resultMarkerSymbolURL:String = lyrList.symbology.picturemarkersymbol.@url || widgetIcon;
						const resultMarkerSymbolHeight:Number = (lyrList.symbology.picturemarkersymbol.@height[0] != null) ? lyrList.symbology.picturemarkersymbol.@height : 30;
						const resultMarkerSymbolWidth:Number = (lyrList.symbology.picturemarkersymbol.@width[0] != null) ? lyrList.symbology.picturemarkersymbol.@width : 30;
						const resultMarkerSymbolXOffset:Number = (lyrList.symbology.picturemarkersymbol.@xoffset[0] != null) ? lyrList.symbology.picturemarkersymbol.@xoffset : 0;
						const resultMarkerSymbolYOffset:Number = (lyrList.symbology.picturemarkersymbol.@yoffset[0] != null) ? lyrList.symbology.picturemarkersymbol.@yoffset : 0;
						const resultMarkerSymbolAngle:Number = (lyrList.symbologysimplemarkersymbol.@angle[0] != null) ? lyrList.symbology.simplemarkersymbol.@angle : 0;
						retSym = new PictureMarkerSymbol(resultMarkerSymbolURL, resultMarkerSymbolWidth, resultMarkerSymbolHeight, resultMarkerSymbolXOffset, resultMarkerSymbolYOffset, resultMarkerSymbolAngle);
					}else{
						const resultMarkerSymbolStyle:String = lyrList.symbology.simplemarkersymbol.@style || "circle";
						const resultMarkerSymbolSize:Number = (lyrList.symbology.simplemarkersymbol.@size[0] != null) ? lyrList.symbology.simplemarkersymbol.@size : 15;
						const resultMarkerSymbolColor:uint = (lyrList.symbology.simplemarkersymbol.@color[0] != null) ? lyrList.symbology.simplemarkersymbol.@color : 0xFF0000;
						const resultMarkerSymbolAlpha:Number = (lyrList.symbology.simplemarkersymbol.@alpha[0] != null) ? lyrList.symbology.simplemarkersymbol.@alpha : 0.8;
						const resultMarkerSymbolXOffset2:Number = (lyrList.symbology.simplemarkersymbol.@xoffset[0] != null) ? lyrList.symbology.simplemarkersymbol.@xoffset : 0;
						const resultMarkerSymbolYOffset2:Number = (lyrList.symbology.simplemarkersymbol.@yoffset[0] != null) ? lyrList.symbology.simplemarkersymbol.@yoffset : 0;
						const resultMarkerSymbolAngle2:Number = (lyrList.symbology.simplemarkersymbol.@angle[0] != null) ? lyrList.symbology.simplemarkersymbol.@angle : 0;
						const resultMarkerSymbolOutlineStyle:String = lyrList.symbology.simplemarkersymbol.outline.@style || "solid";
						const resultMarkerSymbolOutlineColor:uint = (lyrList.symbology.simplemarkersymbol.outline.@color[0] != null) ? lyrList.symbology.simplemarkersymbol.outline.@color : 0x0000ff;
						const resultMarkerSymbolOutlineAlpha:Number = (lyrList.symbology.simplemarkersymbol.outline.@alpha[0] != null) ? lyrList.symbology.simplemarkersymbol.outline.@alpha : 0.8;
						const resultMarkerSymbolOutlineWidth:Number = (lyrList.symbology.simplemarkersymbol.outline.@width[0] != null) ? lyrList.symbology.simplemarkersymbol.outline.@width : 2;
						retSym = new SimpleMarkerSymbol(resultMarkerSymbolStyle,resultMarkerSymbolSize,resultMarkerSymbolColor,resultMarkerSymbolAlpha,resultMarkerSymbolXOffset2,resultMarkerSymbolYOffset2,resultMarkerSymbolAngle2,new SimpleLineSymbol(resultMarkerSymbolOutlineStyle, resultMarkerSymbolOutlineColor, resultMarkerSymbolOutlineAlpha, resultMarkerSymbolOutlineWidth));
					}
				}else if(lyrList.symbology.simplelinesymbol[0]){
					//line symbol
					const resultLineSymbolColor:uint = (lyrList.symbology.simplelinesymbol.@color[0] != null) ? lyrList.symbology.simplelinesymbol.@color : 0xFF0000;
					const resultLineSymbolAlpha:Number = (lyrList.symbology.simplelinesymbol.@alpha[0] != null) ? lyrList.symbology.simplelinesymbol.@alpha : 0.8;
					const resultLineSymbolWidth:Number = (lyrList.symbology.simplelinesymbol.@width[0] != null) ? lyrList.symbology.simplelinesymbol.@width : 2;
					retSym = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, resultLineSymbolColor, resultLineSymbolAlpha, resultLineSymbolWidth);
				}else if(lyrList.symbology.simplefillsymbol[0]){
					// fill symbol
					const resultFillSymbolColor:uint = (lyrList.symbology.simplefillsymbol.@color[0] != null) ? lyrList.symbology.simplefillsymbol.@color : 0xFF0000;
					const resultFillSymbolAlpha:Number = (lyrList.symbology.simplefillsymbol.@alpha[0] != null) ? lyrList.symbology.simplefillsymbol.@alpha : 0.5;
					const resultFillSymbolOutlineColor:uint = (lyrList.symbology.simplefillsymbol.outline.@color[0] != null) ? lyrList.symbology.simplefillsymbol.outline.@color : 0xFF0000;
					const resultFillSymbolOutlineAlpha:Number = (lyrList.symbology.simplefillsymbol.outline.@alpha[0] != null) ? lyrList.symbology.simplefillsymbol.outline.@alpha : 0.8;
					const resultFillSymbolOutlineWidth:Number = (lyrList.symbology.simplefillsymbol.outline.@width[0] != null) ? lyrList.symbology.simplefillsymbol.outline.@width : 2;
					retSym = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, resultFillSymbolColor, resultFillSymbolAlpha, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, resultFillSymbolOutlineColor, resultFillSymbolOutlineAlpha, resultFillSymbolOutlineWidth));
				}
				return retSym;
			}

			/*
			* when a new search is selected, validate the new search
			*/
			private function onSearchFormChanged():void
			{
				// when value changes, check that search criteria are valid
				validateSearch();
			}

			/*
			* when a value is changed (such as each character in textbox or value selected from combo)
			*  validate the Search
			*/
			private function onValueChanged(evt:Event):void
			{
				// when value changes, check that search criteria are valid
				validateSearch();
			}

			/*
			* when a value triggers a submit such as when Enter is pressed in text box
			* perform the search
			*/
			private function onSearchSubmitted(evt:Event):void
			{
				if(searchGroup.numElements == 1){
					equeryFeaturesText(null);
				}else{
					//If the search is valid then the searchBtn is enabled
					if(searchBtn.enabled){
						equeryFeaturesText(null);
					}
				}
			}
			
			//Created 7/27/2011 Pro West & Associates
			//given a layer name find the given index in the name tag inside of the Search tags 
			//from the xml file where the layer names are equal.  If layer name is not present 
			//pass -1 back
			private function findID(layerName:String):int
			{
				for(var cnt:int = 0; cnt<configSearchText.length; ++cnt)
				{
					if(configSearchText[cnt].layer.layerDetails.name == layerName)
					{
						return cnt;
					}
				}
				
				return -1;
			}

			private function BuildSqlResultsTableSuccess(event:ResultEvent):void{
				ExternalInterface.call("changePageResults");
				Alert.show('Save Complete');
			}
			
			private function BuildSqlResultsTableFailure(event:FaultEvent):void{
				Alert.show('Unable to save results. ' + event.message.body.toString());
			}
			
			private function generateWhereClauseFailure(event:FaultEvent):void{
				Alert.show('Unable to select features. ' + event.message.body.toString());
			}
			
			//Created 7/27/2011 Pro West & Associates
			//Uses the where clause returned from calling the generate where clause from the
			//portal integration web service to search against the specified layer on the map
			private function onPortalGenerateWhereClause(event:ResultEvent):void{
				
				if(event.message.body == null)
				{
					Alert.show("Unable to get search layer information.");
					return;
				}
				
				var layerSearchInfo:XML = new XML(event.message.body);
				portalIntegrationMethods.disconnect();
				
				var soapNS:Namespace = layerSearchInfo.namespace("soap");                     
				var xmlnsNS:Namespace =  new Namespace("http://tempuri.org/")                   
				var layerSearchList:XMLList = layerSearchInfo.soapNS::Body.xmlnsNS::generateWhereClauseResponse.xmlnsNS::generateWhereClauseResult.layer;
				
				var layerName:String = layerSearchList.child("layer_name").text();
				var whereClause:String = layerSearchList.child("layer_whereClause").text();
				
				var slayerId:int = findID(layerName);
				
				if(slayerId == -1)
				{
					Alert.show("Layer is not currently searchable.  In order to make searchable add the record to the SearchWidget.xml file under the widgets/eSearch folder.");
					return;
				}
				
				
				queryLayer = configSearchText[slayerId].layer;
				if (queryLayer && !queryLayer.loaded)
				{
					queryLayer.addEventListener(LayerEvent.LOAD, queryLayer_loadHandler);
					function queryLayer_loadHandler(revent:LayerEvent):void
					{
						onPortalGenerateWhereClause(event);
					}
					return;
				}
				
				if(queryLayer != qFeatLayer)
				{
					map.removeLayer(qFeatLayer);
					qFeatLayer = queryLayer;
					qFeatLayer.renderer = new SimpleRenderer(getFeatLyrSymbol(qFeatLayer, "queryFeaturesText"));
					qFeatLayer.name = qFeatLayer.id = "hiddenLayer_eSearchhSelectionLayer";
					qFeatLayer.addEventListener(FlexEvent.HIDE, featLayer_hideHandler);
					featLyrLen = qFeatLayer.selectedFeatures.length;
					map.addLayer(qFeatLayer);
				}
				
				var oidFld:String;
				if(queryLayer.layerDetails)
				{
					oidFld = queryLayer.layerDetails.objectIdField;
				}
				
				var qFields:Array;
				zoomScale = configSearchText[slayerId].zoomscale;
				if(configSearchText[slayerId].zoompercent){
					zoomPercent = Number(configSearchText[slayerId].zoompercent);
				}else{
					zoomPercent = 1.2;
				}
				queryExpr = whereClause;
				queryFields = configSearchText[slayerId].fields;
				queryDefExpr = configSearchText[slayerId].defexpr;
				queryLayerRels = configSearchText[slayerId].relates;
				
				//get the grid fields
				setupGridFields();
				
				queryTitleField = configSearchText[slayerId].titlefield;
				qLinks = configSearchText[slayerId].links;
				queryMultiImgField = configSearchText[slayerId].multi;
				queryAttachments = configSearchText[slayerId].attachments;
				queryEnableExport = configSearchText[slayerId].enableexport;
				queryEnablePrint = configSearchText[slayerId].enableprint;
				queryPrintTitle = (configSearchText[slayerId].printtitle != "")?configSearchText[slayerId].printtitle:configSearchText[slayerId].label;
				openDataGrid = configSearchText[slayerId].opendg;
				
				
				var fields:XMLList;
				if (queryLayer)
				{
					var query:Query = new Query();
					var myPattern:RegExp = /\[value\]/g;
					var expr:String;
					expr = queryExpr.replace(myPattern, whereClause); 
					query.where = expr;
					query.outSpatialReference = map.spatialReference;
					if(queryDefExpr != "")
						queryLayer.definitionExpression = queryDefExpr;
					
					
					map.cursorManager.setBusyCursor();
					queryLayer.selectFeatures(query, "new", new AsyncResponder(onResult, onFault, queryFields)); 
					showMessage(loadingLabel, true); 
					showStateResults();   
					
					var gid:Number = 0;   
					
					// on result
					function onResult(feats:Array, token:XMLList = null):void                 
					{   
						try
						{
							
							if(feats.length == 0)
							{
								Alert.show("No features found");
								showStateTextSearch();
								return;
							}
							createFeatureSet(feats);
							qFeatLayer.selectionColor = Number.NaN;
							for each (var gra:Graphic in feats)                    
							{
								var obj:Object = gra.attributes;
								if(!queryLayer.layerDetails.objectIdField){
									obj["oid"] = gid;
									gid +=1;
								}else{
									obj["oid"] = gra.attributes[queryLayer.layerDetails.objectIdField];
								}
							}
							//gridDataProvider = featureSet.attributes;
							//resultsFeatureSet = featureSet;
							searchResultAC = createSearchResults(feats, token,null,"graphical",true,false);
							// share data
							addSharedData(widgetTitle, searchResultAC);
							showMessage(selectionLabel + " " + qFeatSet.features.length, false);
							if (myfloatdg){
								if(myfloatdg.datagrid.dataProvider)
									myfloatdg.datagrid.dataProvider.removeAll();
								myfloatdg.csvExportOptionLbl = exp2csvOptLbl;
								myfloatdg.txtExportOptionLbl = exp2txtOptLbl;
								myfloatdg.ExportButtonLbl = expBtnLbl;
								myfloatdg.csvSeperator = csvSep;
								myfloatdg.dgFieldAliases = fldAliases;
								myfloatdg.csvName = _csvName;
								myfloatdg.sumField = sumField;
								myfloatdg.labelSum = lblSum;
								myfloatdg.hasRelates = (queryLayerRels && queryLayerRels.length > 0);
								myfloatdg.RelateIcon = relateIcon;
								myfloatdg.RelateToolTip = relateToolTip;
								myfloatdg.dgColumns = gridFields;
								myfloatdg.dgHyperColumns = gridHyperFields;
								myfloatdg.dProvider = gridDataProvider;
								myfloatdg.featlayer = qFeatLayer;
								myfloatdg.zoomScale = zoomScale;
								myfloatdg.zoomPercent = zoomPercent;
								myfloatdg.ownerWidget = sWidget;
								myfloatdg.featLayer = queryLayer;
								myfloatdg.layerDetails = (queryLayer.layerDetails)?queryLayer.layerDetails:queryLayer.tableDetails;
								myfloatdg.enableExport = queryEnableExport;
								myfloatdg.printLabel = getDefaultString('printSubmitLabel');
								myfloatdg.enablePrint = queryEnablePrint;
								myfloatdg.widgetInteract = widgetAndGridIteract;
								myfloatdg.popupsdiabled = PopUpsDisabled;
								myfloatdg.headerBGColor = dgheaderbgcolor;
								myfloatdg.repeatHeader = dgrepeatheader;
								myfloatdg.headerFontColor = dgheaderfontcolor;
								myfloatdg.footerIncludeDate = dgfooterincdate;
								myfloatdg.footerDateFormat = dgfooterdateformat;
								myfloatdg.footerDisclaimer = dgfooterdisclaimer;
								myfloatdg.footerPageofPage = dgfooterpageofpage;
								myfloatdg.dgtitle = queryPrintTitle;
								
								//Added 7/13/2011 PWA
								myfloatdg.integrationWebService = integrationWebService;
								myfloatdg.userID = userid;
								myfloatdg.parcelLayerName = parcelLayerName;
							}
							map.cursorManager.removeBusyCursor();
							if(autoZoom && searchResultAC.length > 0){
								if(isNaN(zoomScale)){
									zoomAll();
								}
								else
								{
									if(map.scale > zoomScale){
										map.scale = zoomScale;
									}
									map.centerAt(searchResultAC[0].point);
								}
							}
							map.cursorManager.removeBusyCursor();
							if(openDataGrid)
								showGridResults();
						}
						catch (error:Error)
						{
							showMessage(error.message, false);
						}
					}
					//on fault
					function onFault(info:Object, token:Object = null) : void
					{      
						showMessage(info.toString(), false);
					}
				}  
			}
			//End Add	
			/*
			* Assign the event listener to the search button to execute the queryFeaturesText function
			*/
			private function equeryFeaturesText(evt:Event):void
			{
				queryFeaturesText();
			}
			
			//Modified 7/27/2011 Pro West & Associates
			//Gets a result table name containing the records to be searched on the map
			//from the results tab on the main portal screen 		
			public function queryFromURL(value:String):void
			{
				//hide infowindow if any
				hideInfoWindow();
				clear();
				portalIntegrationMethods.loadWSDL();
				portalIntegrationMethods.endpointURI = integrationWebService.replace('?wsdl','');
				portalIntegrationMethods.generateWhereClause(value);
			}
			
			public function selectParcelOnMap(pin:String):void{
				clear();
				var layerName:String = parcelLayerName;
				var whereClause:String = parcelLayerPINFieldName + "= '" + pin + "'";
				var slayerId:int = findID(layerName);
				
				if(slayerId == -1)
				{
					Alert.show("Layer is not currently searchable.  In order to make searchable add the record to the SearchWidget.xml file under the widgets/eSearch folder.");
					return;
				}
				
				queryLayer = configSearchText[slayerId].layer;
				if (queryLayer && !queryLayer.loaded)
				{
					queryLayer.addEventListener(LayerEvent.LOAD, queryLayer_loadHandler);
					function queryLayer_loadHandler(revent:LayerEvent):void
					{
						selectParcelOnMap(pin);
					}
					return;
				}
				
				if(queryLayer != qFeatLayer)
				{
					map.removeLayer(qFeatLayer);
					qFeatLayer = queryLayer;
					qFeatLayer.renderer = new SimpleRenderer(getFeatLyrSymbol(qFeatLayer,"queryFeaturesText"));
					qFeatLayer.name = qFeatLayer.id = "hiddenLayer_eSearchhSelectionLayer";
					qFeatLayer.addEventListener(FlexEvent.HIDE,featLayer_hideHandler);
					featLyrLen = qFeatLayer.selectedFeatures.length;
					map.addLayer(qFeatLayer);
				}
				
				var oidFld:String;
				if(queryLayer.layerDetails)
					oidFld = queryLayer.layerDetails.objectIdField;
				
				var qFields:Array;
				zoomScale = configSearchText[slayerId].zoomscale;
				if(configSearchText[slayerId].zoompercent){
					zoomPercent = Number(configSearchText[slayerId].zoompercent);
				}else{
					zoomPercent = 1.2;
				}
				queryExpr = whereClause;
				queryFields = configSearchText[slayerId].fields;
				queryDefExpr = configSearchText[slayerId].defexpr;
				queryLayerRels = configSearchText[slayerId].relates;
				
				//get the grid fields
				setupGridFields();
				
				queryTitleField = configSearchText[slayerId].titlefield;
				qLinks = configSearchText[slayerId].links;
				queryMultiImgField = configSearchText[slayerId].multi;
				queryAttachments = configSearchText[slayerId].attachments;
				queryEnableExport = configSearchText[slayerId].enableexport;
				queryEnablePrint = configSearchText[slayerId].enableprint;
				queryPrintTitle = (configSearchText[slayerId].printtitle != "")?configSearchText[slayerId].printtitle:configSearchText[slayerId].label;
				openDataGrid = configSearchText[slayerId].opendg;
				
				var fields:XMLList;
				if (queryLayer)
				{
					var query:Query = new Query();
					var myPattern:RegExp = /\[value\]/g;
					var expr:String;
					expr = queryExpr.replace(myPattern, whereClause); 
					query.where = expr;
					query.outSpatialReference = map.spatialReference;
					if(queryDefExpr != "")
						queryLayer.definitionExpression = queryDefExpr;
					
					map.cursorManager.setBusyCursor();
					queryLayer.selectFeatures(query, "new",new AsyncResponder(onResult, onFault, queryFields)); 
					showMessage(loadingLabel, true); 
					showStateResults();   
					var gid:Number = 0;   
					
					// on result
					function onResult(feats:Array, token:XMLList = null):void                 
					{   
						try
						{
							if(feats.length == 0)
							{
								Alert.show("No features found");
								showStateTextSearch();
								return;
							}
							createFeatureSet(feats);
							qFeatLayer.selectionColor = Number.NaN;
							for each (var gra:Graphic in feats)                    
							{   
								var obj:Object = gra.attributes;
								if(!queryLayer.layerDetails.objectIdField){
									obj["oid"] = gid;
									gid +=1;
								}else{
									obj["oid"] = gra.attributes[queryLayer.layerDetails.objectIdField];
								}
							}
							//gridDataProvider = featureSet.attributes;
							//resultsFeatureSet = featureSet;
							searchResultAC = createSearchResults(feats, token,null,"graphical",true,false);
							// share data
							addSharedData(widgetTitle, searchResultAC);
							showMessage(selectionLabel + " " + qFeatSet.features.length, false);
							if (myfloatdg){
								if(myfloatdg.datagrid.dataProvider)
									myfloatdg.datagrid.dataProvider.removeAll();
								myfloatdg.csvExportOptionLbl = exp2csvOptLbl;
								myfloatdg.txtExportOptionLbl = exp2txtOptLbl;
								myfloatdg.ExportButtonLbl = expBtnLbl;
								myfloatdg.csvSeperator = csvSep;
								myfloatdg.dgFieldAliases = fldAliases;
								myfloatdg.csvName = _csvName;
								myfloatdg.sumField = sumField;
								myfloatdg.labelSum = lblSum;
								myfloatdg.hasRelates = (queryLayerRels && queryLayerRels.length > 0);
								myfloatdg.RelateIcon = relateIcon;
								myfloatdg.RelateToolTip = relateToolTip;
								myfloatdg.dgColumns = gridFields;
								myfloatdg.dgHyperColumns = gridHyperFields;
								myfloatdg.dProvider = gridDataProvider;
								myfloatdg.featlayer = qFeatLayer;
								myfloatdg.zoomScale = zoomScale;
								myfloatdg.zoomPercent = zoomPercent;
								myfloatdg.ownerWidget = sWidget;
								myfloatdg.featLayer = queryLayer;
								myfloatdg.layerDetails = (queryLayer.layerDetails)?queryLayer.layerDetails:queryLayer.tableDetails;
								myfloatdg.enableExport = queryEnableExport;
								myfloatdg.printLabel = getDefaultString('printSubmitLabel');
								myfloatdg.enablePrint = queryEnablePrint;
								myfloatdg.widgetInteract = widgetAndGridIteract;
								myfloatdg.popupsdiabled = PopUpsDisabled;
								myfloatdg.headerBGColor = dgheaderbgcolor;
								myfloatdg.repeatHeader = dgrepeatheader;
								myfloatdg.headerFontColor = dgheaderfontcolor;
								myfloatdg.footerIncludeDate = dgfooterincdate;
								myfloatdg.footerDateFormat = dgfooterdateformat;
								myfloatdg.footerDisclaimer = dgfooterdisclaimer;
								myfloatdg.footerPageofPage = dgfooterpageofpage;
								myfloatdg.dgtitle = queryPrintTitle;
								//Added 7/13/2011 PWA
								myfloatdg.integrationWebService = integrationWebService;
								myfloatdg.userID = userid;
								myfloatdg.parcelLayerName = parcelLayerName;
								
							}
							map.cursorManager.removeBusyCursor();
							if(autoZoom && searchResultAC.length > 0){
								if(isNaN(zoomScale)){
									zoomAll();
								}
								else
								{
									if(map.scale > zoomScale){
										map.scale = zoomScale;
									}
									map.centerAt(searchResultAC[0].point);
								}
							}
							map.cursorManager.removeBusyCursor();
							if(openDataGrid)
								showGridResults();
						}
						catch (error:Error)
						{
							showMessage(error.message, false);
						}
					}
					//on fault
					function onFault(info:Object, token:Object = null) : void
					{      
						showMessage(info.toString(), false);
					}
				}  
			}
			
			
//End Add
			/*
			* The FeatureLayer select features does not return a FeatureSet like the QueryFeatures did so I have to
			* create it myself from the array of features (graphics)
			*	@param Array feats is an array of graphics
			*/
			private function createFeatureSet(feats:Array):void
			{
				featLyrLen = qFeatLayer.selectedFeatures.length;
				qFeatSet = new FeatureSet(qFeatLayer.selectedFeatures);
				qFeatSet.fields = (queryLayer.layerDetails)?queryLayer.layerDetails.fields:queryLayer.tableDetails.fields;
				qFeatSet.displayFieldName = (queryLayer.layerDetails)?queryLayer.layerDetails.displayField:queryLayer.tableDetails.displayField;
				gridDataProvider = qFeatSet.attributes;
				resultsFeatureSet = qFeatSet;
				featSethasGeom = (queryLayer.layerDetails)?true:false;
			}

			/*
			* Setup the datagrid fields for the selected search layer
			*/
			private function setupGridFields():void
			{
				var gfields:XMLList;
				sumField = "";
				gridFields = [];
				gridHyperFields = [];
				var fldOrder:int = 0;
                var oidAdded:Boolean;

				if (queryFields){
					gfields = queryFields.field;
					for each (var fieldXML:XML in gfields){
						if (fieldXML.@gridfield[0]){
							if(fieldXML.@gridfield[0]=="true"){
								fldOrder++;
								if(fieldXML.@sum[0] && fieldXML.@sum[0] == "true"){
									if(fieldXML.@sumlabel[0]){
										lblSum = fieldXML.@sumlabel[0];
									}
									sumField = fieldXML.@name[0];
								}
								var str:String = fieldXML.@name[0] + "~";
								if(fieldXML.@alias[0]){
									if(fieldXML.@alias[0] == ""){
										str += "NA~";
									}else{
										str += fieldXML.@alias[0] + "~";
									}
								}else{
									str += "NA~";
								}
								if(fieldXML.@dateformat[0]){
									if(fieldXML.@dateformat[0] == ""){
										str += "NA~";
									}else{
										str += fieldXML.@dateformat[0] + "~";
									}
								}else{
									str += "NA~";
								}
								if(fieldXML.@currencyformat[0]){
									if(fieldXML.@currencyformat[0] == ""){
										str += "NA~";
									}else{
										str += fieldXML.@currencyformat[0] + "~";
									}
								}else{
									str += "NA~";
								}
								if(fieldXML.@numberformat[0]){
									if(fieldXML.@numberformat[0] == ""){
										str += "NA~";
									}else{
										str += fieldXML.@numberformat[0] + "~";
									}
								}else{
									str += "NA~";
								}
								if(fieldXML.@useutc[0]){
									if(fieldXML.@useutc[0] == "false"){
										str += "false~";
									}else{
										str += "true~";
									}
								}else{
									str += "NA~";
								}
								if(fieldXML.@sort[0]){
									if(fieldXML.@sort[0] == ""){
										str += "NA~";
									}else{
										str += fieldXML.@sort[0] + "~";
									}
								}else{
									str += "NA~";
								}
								str += fldOrder;
								gridFields.push(str);
							}
						}
						if (fieldXML.@hyperlinkgridfield[0]){
							if (fieldXML.@hyperlinkgridfield[0]=="true"){
								fldOrder++;
								var str2:String = fieldXML.@name[0] + "~";
								if(fieldXML.@alias[0]){
									if(fieldXML.@alias[0] == ""){
										str2 += "NA~";
									}else{
										str2 += fieldXML.@alias[0] + "~";
									}
								}else{
									str2 += "NA~";
								}
								if(fieldXML.@hyperlinkaliastext[0]){
									if(fieldXML.@hyperlinkaliastext[0] == ""){
										str2 += "NA~";
									}else{
										str2 += fieldXML.@hyperlinkaliastext[0] + "~";
									}
								}else{
									str2 += "NA~";
								}
								if(fieldXML.@linkprefix[0]){
									if(fieldXML.@linkprefix[0] == ""){
										str2 += "NA~";
									}else{
										str2 += fieldXML.@linkprefix[0] + "~";
									}
								}else{
									str2 += "NA~";
								}
								if(fieldXML.@linksuffix[0]){
									if(fieldXML.@linksuffix[0] == ""){
										str2 += "NA~";
									}else{
										str2 += fieldXML.@linksuffix[0] + "~";
									}
								}else{
									str2 += "NA~";
								}
								if(fieldXML.@hyperlinkgridicon[0]){
									if(fieldXML.@hyperlinkgridicon[0] == ""){
										str2 += "NA~";
									}else{
										str2 += fieldXML.@hyperlinkgridicon[0] + "~";
									}
								}else{
									str2 += "NA~";
								}
								str2 += fldOrder;
								gridHyperFields.push(str2);
							}
						}
					}
				}
			}

			/*
			* gets the configuration object for the currently selected search expression
			*   @param String value the search string to use
			*	@param int slayerId the specific search index to use in the search
			*	This index comes from the layers that are setup in the eSearchWidget.xml and is a 0 based index
			*	@param int exprNum the specific search expression index to use for the search
			*	This index comes from the layers expressions that are setup in the eSearchWidget.xml and defaults to 0
			*/
/*  			public function queryFromURL(value:String, slayerId:int = 0, exprNum:int = 0):void
			{
				//First check if the layer or table is loaded.
				var typeQ:String = "layer";
				if(configSearchText[slayerId].layer){
					queryLayer = configSearchText[slayerId].layer;
				}else if(configSearchText[slayerId].table){
					queryLayer = configSearchText[slayerId].table;
					typeQ = "table";
				}

				if (queryLayer && !queryLayer.loaded){
					queryLayer.addEventListener(LayerEvent.LOAD, queryLayer_loadHandler);
					function queryLayer_loadHandler(event:LayerEvent):void
					{
						callLater(queryFromURL,[value,slayerId,exprNum]);
					}
					return;
				}

				if(queryLayer != qFeatLayer){
					map.removeLayer(qFeatLayer);
					qFeatLayer = queryLayer;
					if(typeQ == "layer"){
						qFeatLayer.renderer = new SimpleRenderer(getFeatLyrSymbol(qFeatLayer, "queryFromURL"));
					}
                    qFeatLayer.name = qFeatLayer.id = "hiddenLayer_eSearchhSelectionLayer";
					qFeatLayer.addEventListener(FlexEvent.HIDE, featLayer_hideHandler);
					featLyrLen = qFeatLayer.selectedFeatures.length;
					map.addLayer(qFeatLayer);
				}

				if(searchGroup.numElements > 1){
					for(var sgi:Number = searchGroup.numElements - 1; sgi >= 1; sgi--){
						searchGroup.removeElementAt(sgi);
					}
				}
				var v:int;
				var sItemVal:SearchExpValueItem;
				if(!configSearchText[slayerId].expr[exprNum]){
					showError(urlSearchErrorMsg);
					return;
				}
				for(v=0; v<configSearchText[slayerId].expr[exprNum].values.length; v++){
					var cfg:Object = configSearchText[slayerId].expr[exprNum].values[v];
					if(v == 0){
						sItemVal = searchGroup.getElementAt(0) as SearchExpValueItem;
						sItemVal.setPrompt = cfg.prompt;
                        sItemVal.isAutoSubmitdisabled = cfg.disableautosubmit;
						// set the required property from the config
						sItemVal.isValueRequired = cfg.isvaluerequired;
						sItemVal.setRequiredText = requiredLbl;
						sItemVal.setRequiredTooltip = requiredTooltip;
						if (cfg.operator){
							sItemVal.operator = cfg.operator;
						};
						sItemVal.changeToTextBox();
                        if ((v%2) == 1) {
                            sItemVal.setBGcolor = getStyle('rolloverColor');
                        }
					}else{
						sItemVal = new SearchExpValueItem;
						sItemVal.wTemplateWidth = wTemplate.width;
						sItemVal.percentWidth = 100;
						sItemVal.setPrompt = cfg.prompt;
                        sItemVal.isAutoSubmitdisabled = cfg.disableautosubmit;
						// set the required property from the config
						sItemVal.isValueRequired = cfg.isvaluerequired;
						sItemVal.setRequiredText = requiredLbl;
						sItemVal.setRequiredTooltip = requiredTooltip;
						if (cfg.operator){
							sItemVal.operator = cfg.operator;
						};
						sItemVal.addEventListener("valueChanged", onValueChanged);
						sItemVal.addEventListener("submitSearch", onSearchSubmitted);
						sItemVal.addEventListener(FocusEvent.FOCUS_IN, searchGroupItem_focusInHandler);
                        if ((v%2) == 1) {
                            sItemVal.setBGcolor = getStyle('rolloverColor');
                        }
						searchGroup.addElement(sItemVal);
					}
					if(configSearchText[slayerId].expr[exprNum].values[v].usedomain){
						popCBwithDomain(configSearchText[slayerId].expr[exprNum].values[v].field, sItemVal);
					}else if(configSearchText[slayerId].expr[exprNum].values[v].userlist != ""){
						popCBwithUserList(configSearchText[slayerId].expr[exprNum].values[v].userlist, sItemVal);
					}else if(configSearchText[slayerId].expr[exprNum].values[v].usesubtype){
						popCBwithSubType(sItemVal);
					}else if(configSearchText[slayerId].expr[exprNum].values[v].uniquevalsfromfield != ""){
						var uFld:String = configSearchText[slayerId].expr[exprNum].values[v].uniquevalsfromfield;
						var uDateFormat:String = configSearchText[slayerId].expr[exprNum].values[v].dateformat;
						var uUseUTC:Boolean = configSearchText[slayerId].expr[exprNum].values[v].useutc;
						if(!pagingQueryTask.isQuerying){
							popCBwithUnique(uFld, sItemVal, uDateFormat, uUseUTC);
						}else{
							//add this field to the Que
							var queObj:Object = {
								ufld: uFld,
								sitemval: sItemVal,
								udatefmt: uDateFormat,
								uuseutc: uUseUTC
							}
							popCBwithUniqueQue.push(queObj);
						}
					}
				}
				searchBtn.addEventListener(MouseEvent.CLICK, equeryFeaturesText);

				txtLabelText.text = configSearchText[slayerId].expr[exprNum].textlabel;
				cboLayerExpr.dataProvider = new ArrayCollection(configSearchText[slayerId].expr);
				if (configSearchText[slayerId].expr.length == 1){
					boxTextexpr.visible = false;
					boxTextexpr.includeInLayout = false;
				}else{
					boxTextexpr.visible = true;
					boxTextexpr.includeInLayout = true;
				}

				//hide infowindow if any
				hideInfoWindow();

				executingURLquery = true;

				cboLayerText.selectedIndex = slayerId;
				cboLayerExpr.selectedIndex = exprNum;

				sItemVal.textValue = value;

				var qFields:Array;
				 if(configSearchText[slayerId].layer){
					zoomScale = configSearchText[slayerId].zoomscale;
					if(configSearchText[slayerId].zoompercent){
						zoomPercent = configSearchText[slayerId].zoompercent;
					}else{
						zoomPercent = 1.2;
					}
				}

				queryExpr = configSearchText[slayerId].expr[exprNum].values[0].expression;
				queryFields = configSearchText[slayerId].fields;
				queryLayerRels = configSearchText[slayerId].relates;
				queryDefExpr = configSearchText[slayerId].defexpr;

				//get the grid fields
				setupGridFields();

				queryTitleField = configSearchText[slayerId].titlefield;
				qLinks = configSearchText[slayerId].links;
				queryMultiImgField = configSearchText[slayerId].multi;
				queryAttachments = configSearchText[slayerId].attachments;
				queryEnableExport = configSearchText[slayerId].enableexport;
				queryEnablePrint = configSearchText[slayerId].enableprint;
				queryPrintTitle = (configSearchText[slayerId].printtitle != "")?configSearchText[slayerId].printtitle:configSearchText[slayerId].label;
                openDataGrid = configSearchText[slayerId].opendg;
				var fields:XMLList;

				if(configSearchText[slayerId].layer){
					queryLayer = configSearchText[slayerId].layer;
				}else if(configSearchText[slayerId].table){
					queryLayer = configSearchText[slayerId].table;
					typeQ = "table";
				}

				if (queryLayer){
					var query:Query = new Query();
					var myPattern:RegExp = /\[value\]/g;
					var expr:String;
					var eVal:String;
                    if(queryExpr == "[value]" || queryExpr.toLowerCase().indexOf(" in (") > 0){
                        //meaning an open SQL expression or an SQL with an IN Statement
                        eVal = value;
                    }else{
                        eVal = value.replace(/'/g,"''");
                    };
                    /*If the expression is an IN Statement and the the value is a string then
                    replace the user defines comma seperated values with single quoted values
                    if(queryExpr.toLowerCase().indexOf(" in (") > 0 && queryExpr.toLowerCase().indexOf("'[value]'") > -1){
                        //replace the begining and trailing single qoutes if they exist
                        eVal = eVal.replace(/^'|'$/g, "").replace(/,|','/g, "','");
                    }
					expr = queryExpr.replace(myPattern, eVal);
					query.where = expr;
					query.outSpatialReference = map.spatialReference;
					if(queryDefExpr != ""){
						queryLayer.definitionExpression = queryDefExpr;
					}
                    map.cursorManager.setBusyCursor();
					queryLayer.selectFeatures(query, FeatureLayer.SELECTION_NEW, new AsyncResponder(onResult, onFault, queryFields));
					showMessage(loadingLabel, true);
					showStateResults();

					// on result
					function onResult(feats:Array, token:XMLList = null):void
					{
						try{
							createFeatureSet(feats);
							qFeatLayer.selectionColor = Number.NaN;
							var gid:Number = 0;
							for each (var gra:Graphic in feats){
								var obj:Object = gra.attributes;
								if(typeQ == "layer"){
									if(!queryLayer.layerDetails.objectIdField){
										obj["oid"] = gid;
										gid ++;
									}else{
										obj["oid"] = gra.attributes[queryLayer.layerDetails.objectIdField];
									}
								}else{
									if(!queryLayer.tableDetails.objectIdField){
										obj["oid"] = gid;
										gid ++;
									}else{
										obj["oid"] = gra.attributes[queryLayer.tableDetails.objectIdField];
									}
								}
							}
							if(queryLayerRels && queryLayerRels.length > 0){
								searchResultAC = createSearchResults(feats, token, queryLayerRels, "queryFromURL");
							}else{
								searchResultAC = createSearchResults(feats, token, null, "queryFromURL");
							}

							// share data
							addSharedData(widgetTitle, searchResultAC);
							showMessage(selectionLabel + " " + feats.length, false);
							msgVisible = true;
							map.cursorManager.removeBusyCursor();
							if(typeQ == "layer"){
								if(isNaN(zoomScale)){
									zoomAll();
								}else{
									if (map.scale > zoomScale){
										map.scale = zoomScale;
									}
									map.centerAt(searchResultAC[0].point);
								}
							}
							if(ViewerContainer.urlConfigParams.showdatagrid != null){
								if(ViewerContainer.urlConfigParams.showdatagrid == "true" && floatorfixed == "float"){
									showGridResults();
								}
							}

							if(floatorfixed == "fixed"){
								var dgConfig:Object = {
									widgetTitle: queryPrintTitle,
									csvExportOptionLbl: exp2csvOptLbl,
									txtExportOptionLbl: exp2txtOptLbl,
									ExportButtonLbl: expBtnLbl,
									csvSeperator: csvSep,
									dgFieldAliases: fldAliases,
									csvName: _csvName,
									sumField: sumField,
									labelSum: lblSum,
									hasRelates: (queryLayerRels && queryLayerRels.length > 0),
									dgColumns: gridFields,
									dgHyperColumns: gridHyperFields,
									dProvider: gridDataProvider,
									featlayer: qFeatLayer,
									zoomScale: zoomScale,
									zoomPercent: zoomPercent,
									ownerWidget: sWidget,
									layerDetails: (queryLayer.layerDetails)?queryLayer.layerDetails:queryLayer.tableDetails,
									enableExport: queryEnableExport,
									enablePrint: queryEnablePrint,
									widgetInteract: widgetAndGridIteract,
									popupsdisabled: PopUpsDisabled,
									disableRelateTab: !(queryLayerRels && queryLayerRels.length > 0),
									headerBGColor: dgheaderbgcolor,
									repeatHeader: dgrepeatheader,
									headerFontColor: dgheaderfontcolor,
									includeDateInFooter: dgfooterincdate,
									footerDateFormat : dgfooterdateformat,
									footerPageofPage: dgfooterpageofpage,
									footerDisclaimer: dgfooterdisclaimer,
                                    autoOpenDataGrid: openDataGrid,
                                    relateToolTip: relateToolTip
								};
								var dgconfigArr:ArrayCollection = new ArrayCollection();
								dgconfigArr.addItem(dgConfig);
								addSharedData("configFixedDatagrid", dgconfigArr);
							}
							executingURLquery = false;
						}
						catch (error:Error){
                            map.cursorManager.removeBusyCursor();
							showMessage(error.message, false);
						}
                        map.cursorManager.removeBusyCursor();
					}
					//on fault
					function onFault(info:Object, token:Object = null) : void
					{
                        map.cursorManager.removeBusyCursor();
						showMessage(info.toString(), false);
					}
				}
			} */

			/*
			* Click Handler for the spatial operations buttons
			* This also deactivates any draw tools (like the graphical search)
			*/
			private function sOpBtnClickHandler(event:Event):void
			{
				addSharedData("Deactivate_DrawTool", null);
				intersectResults(event.currentTarget.name);
			}

			/*
			* Returns the spatial operation image url string based on the value passed in
			*	@param String value is the spatial relationship constant
			*	@return String the url of the icon image
			*/
			private function getSopImg(value:String):String
			{
				var retVal:String = ""
				switch(value){
					case "esriSpatialRelIntersects":{
						retVal = WIDGET_URL + "i_intersect.png";
						break;
					}
					case "esriSpatialRelContains":{
						retVal = WIDGET_URL + "i_contain.png";
						break;
					}
					case "esriSpatialRelCrosses":{
						retVal = WIDGET_URL + "i_crosses.png";
						break;
					}
					case "esriSpatialRelEnvelopeIntersects":{
						retVal = WIDGET_URL + "i_envintersects.png";
						break;
					}
					case "esriSpatialRelIndexIntersects":{
						retVal = WIDGET_URL + "i_index.png";
						break;
					}
					case "esriSpatialRelOverlaps":{
						retVal = WIDGET_URL + "i_overlaps.png";
						break;
					}
					case "esriSpatialRelTouches":{
						retVal = WIDGET_URL + "i_touches.png";
						break;
					}
					case "esriSpatialRelWithin":{
						retVal = WIDGET_URL + "i_within.png";
						break;
					}
				}
				return retVal;
			}

			/*
			* Set SearchExpValueItems based on the search layer changing
			*/
			private function searchLayerChangedText():void
			{
				if(searchGroup.numElements > 1){
					for(var sgi:Number = searchGroup.numElements - 1; sgi >= 1; sgi--){
						searchGroup.removeElementAt(sgi);
					}
				}
				var v:int;
				var i:Number = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;
				cboLayerGraphical.selectedItem = cboLayerText.selectedItem;
				var sItemVal:SearchExpValueItem;
				for(v=0; v<configSearchText[i].expr[0].values.length; v++){
					var cfg:Object = configSearchText[i].expr[0].values[v];
					if(v == 0){
						sItemVal = searchGroup.getElementAt(0) as SearchExpValueItem;
						sItemVal.setPrompt = cfg.prompt;
                        sItemVal.isAutoSubmitdisabled = cfg.disableautosubmit;
						// set the required property from the config
						sItemVal.isValueRequired = cfg.isvaluerequired;
						sItemVal.setRequiredText = requiredLbl;
						sItemVal.setRequiredTooltip = requiredTooltip;
						if (cfg.operator){
							sItemVal.operator = cfg.operator;
						};
						sItemVal.changeToTextBox();
                        if ((v%2) == 1) {
                            sItemVal.setBGcolor = getStyle('rolloverColor');
                        }
					}else{
						sItemVal = new SearchExpValueItem;
						sItemVal.wTemplateWidth = wTemplate.width;
						sItemVal.percentWidth = 100;
						sItemVal.setPrompt = cfg.prompt;
                        sItemVal.isAutoSubmitdisabled = cfg.disableautosubmit;
						// set the required property from the config
						sItemVal.isValueRequired = cfg.isvaluerequired;
						sItemVal.setRequiredText = requiredLbl;
						sItemVal.setRequiredTooltip = requiredTooltip;
						if (cfg.operator){
							sItemVal.operator = cfg.operator;
						};
						sItemVal.addEventListener("valueChanged", onValueChanged);
						sItemVal.addEventListener("submitSearch", onSearchSubmitted);
						sItemVal.addEventListener(FocusEvent.FOCUS_IN, searchGroupItem_focusInHandler);
                        if ((v%2) == 1) {
                            sItemVal.setBGcolor = getStyle('rolloverColor');
                        }
						searchGroup.addElement(sItemVal);
					}
					if(configSearchText[i].expr[0].values[v].usedomain){
						popCBwithDomain(configSearchText[i].expr[0].values[v].field, sItemVal);
					}else if(configSearchText[i].expr[0].values[v].userlist != ""){
						popCBwithUserList(configSearchText[i].expr[0].values[v].userlist, sItemVal);
					}else if(configSearchText[i].expr[0].values[v].usesubtype){
						popCBwithSubType(sItemVal);
					}else if(configSearchText[i].expr[0].values[v].uniquevalsfromfield != ""){
						var uFld:String = configSearchText[i].expr[0].values[v].uniquevalsfromfield;
						var uDateFormat:String = configSearchText[i].expr[0].values[v].dateformat;
						var uUseUTC:Boolean = configSearchText[i].expr[0].values[v].dateformat;
						if(!pagingQueryTask.isQuerying){
							popCBwithUnique(uFld, sItemVal, uDateFormat, uUseUTC);
						}else{
							//add this field to the Que
							var queObj:Object = {
								ufld: uFld,
								sitemval: sItemVal,
								udatefmt: uDateFormat,
								uuseutc: uUseUTC
							}
							popCBwithUniqueQue.push(queObj);
						}
					}
				}
				searchBtn.addEventListener(MouseEvent.CLICK, equeryFeaturesText);

				txtLabelText.text = configSearchText[i].expr[0].textlabel;
				cboLayerExpr.dataProvider = new ArrayCollection(configSearchText[i].expr);
				cboLayerExpr.width = determineDropDownWidth(configSearchText[i].expr);
				if((cboLayerExpr.width + lblExprText.measureText(layerExprLabel).width + 57) > wTemplate.width){
					cboLayerExpr.width = (wTemplate.width - (lblExprText.measureText(layerExprLabel).width + 57));
				}
				cboLayerExpr.selectedIndex = 0;
				if (configSearchText[i].expr.length == 1){
					boxTextexpr.visible = false;
					boxTextexpr.includeInLayout = false;
				}else{
					boxTextexpr.visible = true;
					boxTextexpr.includeInLayout = true;
				}
				// a new (default) search form is shown for the selected layer
				onSearchFormChanged();
			}

			/*
			* Set SearchExpValueItems based on the search layers search expression changing
			*/
			private function searchLayerExprChangedText():void
			{
				var i:Number = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;
				var j:Number = (cboLayerExpr.selectedIndex < 0) ? 0 : cboLayerExpr.selectedIndex;
				if(searchGroup.numElements > 1){
					for(var sgi:Number = searchGroup.numElements - 1; sgi >= 1; sgi--){
						searchGroup.removeElementAt(sgi);
					}
				}
				var sItemVal:SearchExpValueItem;
                for(var v:int=0; v<configSearchText[i].expr[j].values.length; v++){
                    var cfg:Object = configSearchText[i].expr[j].values[v];
					if(v == 0){
						sItemVal = searchGroup.getElementAt(0) as SearchExpValueItem;
						sItemVal.setPrompt = cfg.prompt;
                        sItemVal.isAutoSubmitdisabled = cfg.disableautosubmit;
						sItemVal.isValueRequired = cfg.isvaluerequired;// set the required property from the config
						sItemVal.setRequiredText = requiredLbl;
						sItemVal.setRequiredTooltip = requiredTooltip;
						if (cfg.operator){
							sItemVal.operator = cfg.operator;
						};
                        if ((v%2) == 1) {
                            sItemVal.setBGcolor = getStyle('rolloverColor');
                        }
						sItemVal.changeToTextBox();
					}else{
						sItemVal = new SearchExpValueItem;
						sItemVal.wTemplateWidth = wTemplate.width;
						sItemVal.percentWidth = 100;
						sItemVal.setPrompt = cfg.prompt;
                        sItemVal.isAutoSubmitdisabled = cfg.disableautosubmit;
						sItemVal.isValueRequired = cfg.isvaluerequired;// set the required property from the config
						sItemVal.setRequiredText = requiredLbl;
						sItemVal.setRequiredTooltip = requiredTooltip;
						if (cfg.operator){
							sItemVal.operator = cfg.operator;
						};
						sItemVal.addEventListener("valueChanged", onValueChanged);
						sItemVal.addEventListener("submitSearch", onSearchSubmitted);
						sItemVal.addEventListener(FocusEvent.FOCUS_IN, searchGroupItem_focusInHandler);
                        if ((v%2) == 1) {
                            sItemVal.setBGcolor = getStyle('rolloverColor');
                        }
						searchGroup.addElement(sItemVal);
					}
					if(configSearchText[i].expr[j].values[v].usedomain){
						popCBwithDomain(configSearchText[i].expr[j].values[v].field, sItemVal);
					}else if(configSearchText[i].expr[j].values[v].userlist != ""){
						popCBwithUserList(configSearchText[i].expr[j].values[v].userlist, sItemVal);
					}else if(configSearchText[i].expr[j].values[v].usesubtype){
						popCBwithSubType(sItemVal);
					}else if(configSearchText[i].expr[j].values[v].uniquevalsfromfield != ""){
						var uFld:String = configSearchText[i].expr[j].values[v].uniquevalsfromfield;
						var uDateFormat:String = configSearchText[i].expr[j].values[v].dateformat;
						var uUseUTC:Boolean = configSearchText[i].expr[j].values[v].useutc;
						if(!pagingQueryTask.isQuerying){
							popCBwithUnique(uFld, sItemVal, uDateFormat, uUseUTC);
						}else{
							//add this field to the Que
							var queObj:Object = {
								ufld: uFld,
								sitemval: sItemVal,
								udatefmt: uDateFormat,
								uuseutc: uUseUTC
							}
							popCBwithUniqueQue.push(queObj);
						}
					}
				}
				searchBtn.addEventListener(MouseEvent.CLICK, equeryFeaturesText);
				txtLabelText.text = configSearchText[i].expr[j].textlabel;

				// new search so validate
				onSearchFormChanged();
			}

			/*
			* Set the graphicl search label in the GUI based on the selected search layer
			*/
			private function searchLayerChangedGraphical():void
			{
				var i:Number = (cboLayerGraphical.selectedIndex < 0) ? 0 : cboLayerGraphical.selectedIndex;
				txtLabelGraphical.text = configSearchText[i].graphicallabel;
			}

			/*
			* Set SearchExpValueItems based on the search layer changing
			*/
			private function activateSearchTool(event:MouseEvent, lTool:String = ""):void
			{
				addSharedData("Deactivate_DrawTool", null); // to be able to deactivate drawTool on other widgets

				if(event){
                    //Allow button to act as toggle buttons
                    if(lastTool == Image(event.currentTarget).name){
                        clearSelectionFilter();
                        setMapAction(null, null, null, null);
                        hideInfoWindow();
                        setMapNavigation(null, null);
                        lastTool = "";
                        return;
                    }else{
                        graGraphicsLayer.clear();
                        selectedDrawingIcon = Image(event.currentTarget);
                    }
				}else{
					switch(lTool){
						case DrawTool.EXTENT :{
							selectedDrawingIcon = iSearchExt;
							break;
						}
						case DrawTool.POLYGON :{
							selectedDrawingIcon = iSearchPoly;
							break;
						}
						case DrawTool.MAPPOINT :{
							selectedDrawingIcon = iSearchPnt;
							break;
						}
						case DrawTool.POLYLINE :{
							selectedDrawingIcon = iSearchLine;
							break;
						}
						default:{
							selectedDrawingIcon = iSearchPnt;
						}
					}
				}
				clearSelectionFilter();
				selectedDrawingIcon.filters = [ glowFilter ];

				var status:String;
				var value:String = lastTool = selectedDrawingIcon.name;
				switch (value){
					case DrawTool.MAPPOINT:{
						status = pointLabel;
						drawSymbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE, 15, 0x3FAFDC, 1);
						break;
					}
					case DrawTool.POLYLINE:{
						status = lineLabel;
						drawSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, 0x3FAFDC, 1, 1);
						break;
					}
					case DrawTool.EXTENT:{
						status = rectangleLabel;
						drawSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, 0x3FAFDC, 0.5, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, 0x3FAFDC, 1, 1));
						break;
					}
					case DrawTool.POLYGON:{
						status = polygonLabel;
						drawSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, 0x3FAFDC, 0.5, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, 0x3FAFDC, 1, 1));
						break;
					}
				}
				setMapAction(value, status, drawSymbol, searchDrawEnd, null, false, true);
			}

			/*
			* Executed when the drawing is done
			*/
			private function searchDrawEnd(event:DrawEvent):void
			{
				activateSearchTool(null,lastTool);
				var geom:Geometry = event.graphic.geometry;
				var graGraphic:Graphic = new Graphic(geom, drawSymbol);
				graGraphicsLayer.add(graGraphic);
				if(!graMultiChk.selected){
					queryFeaturesGra();
				}
			}

			/*
			* Function fired by the enable multi-graphics search on the Graphical Search view
			* Specifies whether the search button should be shown in that view
			*/
			private function graMultiChanged():void
			{
				(graMultiChk.selected) ? graFeatureQueryBtn.visible = true : graFeatureQueryBtn.visible = false;
			}

			/*
			* Function That takes all the graphics in a defined GraphicsLayer and adds unions them into one geometry
			*	@param GraphicsLayer gl is the graphics layer to union
			*	@return Geometry of the unioned graphics
			*/
			private function unionGeoms2(gl:GraphicsLayer):Geometry
			{
				var retGeom:Geometry;
				var mPoint:Multipoint = new Multipoint(null);
				mPoint.spatialReference = map.spatialReference;
				var mPoly:Polygon = new Polygon(null);
				mPoly.spatialReference = map.spatialReference;
				var mPolyL:Polyline = new Polyline(null);
				mPolyL.spatialReference = map.spatialReference;
				var rType:String;
				for each (var graphic:Graphic in gl.graphicProvider){
					if(graphic.geometry.type == "esriGeometryPoint" && !addTolerance.selected){
						mPoint.addPoint(graphic.geometry as MapPoint);
						rType = "point";
					}else if (graphic.geometry.type == "esriGeometryPoint" && addTolerance.selected){
						var ext2:Extent = createExtentAroundMapPoint(graphic.geometry as MapPoint, pointSearchTolerance) as Extent;
                        mPoly = ext2.toPolygon();
						rType = "poly";
						mPoly.spatialReference = ext2.spatialReference;
					}

					if(graphic.geometry.type == "esriGeometryMultipoint"){
						var mp:Multipoint = graphic.geometry as Multipoint
						var pnts:MapPoint;
						for (var p:int=0;p < mp.points.length; p++){
							mPoint.addPoint(mp.points[p]);
						}
						rType = "point";
					}

					if(graphic.geometry.type == "esriGeometryPolygon"){
						var poly:Polygon = graphic.geometry as Polygon;
						for (var i2:int = poly.rings.length - 1; i2 >= 0; i2--){
							var ringArray:Array = [];
							for (var j1:int = 0; j1 < poly.rings[i2].length; j1++){
								var mp2:MapPoint = poly.getPoint(i2,j1) as MapPoint;
								mp2.spatialReference = poly.spatialReference;
								ringArray.push(mp2);
							}
							mPoly.addRing(ringArray);
						}
						rType = "poly";
						mPoly.spatialReference = poly.spatialReference;
					}

					if(graphic.geometry.type == "esriGeometryPolyline"){
						var polyl:Polyline = graphic.geometry as Polyline;
						for(var l:int=polyl.paths.length-1; l >= 0; l--){
							var pathArray:Array = [];
							for (var j2:int = 0; j2 < polyl.paths[l].length; j2++){
								var mp3:MapPoint = polyl.getPoint(l,j2) as MapPoint;
								mp3.spatialReference = polyl.spatialReference;
								pathArray.push(mp3);
							}
							mPolyL.addPath(pathArray);
						}
						rType = "line";
					}

					if(graphic.geometry.type == "esriGeometryEnvelope"){
						var ext:Extent = graphic.geometry as Extent;
                        mPoly = ext.toPolygon();
						rType = "poly";
					}
				}

				switch(rType){
					case "point":{
						retGeom = mPoint;
						break;
					}
					case "poly":{
						retGeom = mPoly;
						break;
					}
					case "line":{
						retGeom = mPolyL;
						break;
					}
				}
				return retGeom;
			}
			/*
			* Function fired by the graFeatureQueryBtn on the Graphical Search view or the draw end function
			* Calls unionGeoms2  and/or simplify if the graphics layer has more than one geometry or is
			* not simple and then executes the queryFeaturesGraphical function
			*/
			private function queryFeaturesGra():void
			{
				if(keepGraSearchEnabled == false){
					addSharedData("Deactivate_DrawTool", null); // to be able to deactivate drawTool on other widgets
				}
				var geom:Geometry
				var graLayAC:ArrayCollection = graGraphicsLayer.graphicProvider as ArrayCollection;
				if (graLayAC.length > 1){
					 geom = unionGeoms2(graGraphicsLayer);
				}else if (graLayAC.length == 1){
					geom = (graLayAC[0] as Graphic).geometry;
				}else{
					return;
				}
				if(keepGraSearchEnabled == false){
					selectedDrawingIcon = null;
					clearSelectionFilter();
				}
				clearBuffer();
				if (geom is Polygon && GeometryUtil.polygonSelfIntersecting(geom as Polygon)){
					geometryService.simplify([geom], new AsyncResponder(simpResult, null));
					function simpResult(item:Object ,spatialRelat:String):void{
						var simpGeoms:Array = item as Array;
						if(bufferUserGraphic.selected){
							applyBuffer(true);
						}else{
							queryFeaturesGraphical(simpGeoms[0] as Polygon, "esriSpatialRelIntersects", configSearchGraphical[(cboLayerGraphical.selectedIndex < 0)?0:cboLayerGraphical.selectedIndex]);
						}
					}
				}else{
					//create extent around map point to improve search results
					if (geom.type == Geometry.MAPPOINT && addTolerance.selected){
						geom = createExtentAroundMapPoint(geom as MapPoint, pointSearchTolerance);
					}
					if(bufferUserGraphic.selected){
						applyBuffer(true);
					}else{
						queryFeaturesGraphical(geom, "esriSpatialRelIntersects", configSearchGraphical[(cboLayerGraphical.selectedIndex < 0)?0:cboLayerGraphical.selectedIndex]);
					}
				}
				graGraphicsLayer.clear();
			}

			/*
			* Function that takes a MapPoint and creates an extent around it for zooming
			*	@param MapPoint centerPoint is the MapPoint that needs an extent
			*	@param Number tolerance is the number of pixels that will be added to the MapPoint
			*	@return Extent of the inputMapPoint with the tollerance added
			*/
			private function createExtentAroundMapPoint(centerPoint:MapPoint, tolerance:Number):Extent
			{
				var screenPoint:Point = map.toScreen(centerPoint as MapPoint);

				var upperLeftScreenPoint:Point = new Point(screenPoint.x - tolerance, screenPoint.y - tolerance);
				var lowerRightScreenPoint:Point = new Point(screenPoint.x + tolerance, screenPoint.y + tolerance);

				var upperLeftMapPoint:MapPoint = map.toMap(upperLeftScreenPoint);
				var lowerRightMapPoint:MapPoint = map.toMap(lowerRightScreenPoint);

				return new Extent(upperLeftMapPoint.x, upperLeftMapPoint.y, lowerRightMapPoint.x, lowerRightMapPoint.y, map.spatialReference);
			}

			/*
			* Querys the feature layer based on the text views criteria
			*/
			private function queryFeaturesText():void
			{
				//hide infowindow if any
				hideInfoWindow();
				var typeQ:String = "layer";
				var i:Number = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;

				if(configSearchText[i].layer){
					queryLayer = configSearchText[i].layer;
				}else if(configSearchText[i].table){
					queryLayer = configSearchText[i].table;
					typeQ = "table";
				}
				if (queryLayer && !queryLayer.loaded){
					queryLayer.addEventListener(LayerEvent.LOAD, queryLayer_loadHandler);
					function queryLayer_loadHandler(event:LayerEvent):void
					{
						queryFeaturesText()
					}
					return;
				}
				if(queryLayer != qFeatLayer){
					map.removeLayer(qFeatLayer);
					qFeatLayer = queryLayer;
					if(typeQ == "layer"){
						qFeatLayer.renderer = new SimpleRenderer(getFeatLyrSymbol(qFeatLayer, "queryFeaturesText"));
					}
                    qFeatLayer.name = qFeatLayer.id = "hiddenLayer_eSearchhSelectionLayer";
					qFeatLayer.addEventListener(FlexEvent.HIDE, featLayer_hideHandler);
					featLyrLen = qFeatLayer.selectedFeatures.length;
					map.addLayer(qFeatLayer);
				}

				var oidFld:String;
				if(queryLayer.layerDetails){
					oidFld = queryLayer.layerDetails.objectIdField;
				}else{
					oidFld = queryLayer.tableDetails.objectIdField;
				}
				var qFields:Array;
				zoomScale = configSearchText[i].zoomscale;
				zoomPercent = configSearchText[i].zoompercent;
				queryLayer = (typeQ == "layer") ? configSearchText[i].layer : configSearchText[i].table;
				var j:Number = (cboLayerExpr.selectedIndex < 0) ? 0 : cboLayerExpr.selectedIndex;
				queryFields = configSearchText[i].fields;
				queryDefExpr = configSearchText[i].defexpr;
				queryLayerRels = configSearchText[i].relates;

				//get the grid fields
				setupGridFields();

				queryTitleField = configSearchText[i].titlefield;
				qLinks = configSearchText[i].links;
				queryMultiImgField = configSearchText[i].multi;
				queryAttachments = configSearchText[i].attachments;
				queryEnableExport = configSearchText[i].enableexport;
				queryEnablePrint = configSearchText[i].enableprint;
				queryPrintTitle = (configSearchText[i].printtitle != "")?configSearchText[i].printtitle:configSearchText[i].label;
				openDataGrid = configSearchText[i].opendg;
				var sItemVal:SearchExpValueItem;
				var fields:XMLList;
				if(queryLayer){
					var query:Query = new Query();
					var myPattern:RegExp = /\[value\]/g;
					var expr:String = "";
					var eVal:String = "";
					var criteriaFromValue:String;

					for(var sg:Number = 0; sg < searchGroup.numElements; sg++){
						sItemVal = searchGroup.getElementAt(sg) as SearchExpValueItem;
						queryExpr = configSearchText[i].expr[j].values[sg].expression;
                        
                        if(queryExpr == "[value]" || queryExpr.toLowerCase().indexOf(" in (") > 0){
                            //meaning an open SQL expression or an SQL with an IN Statement
                            eVal = sItemVal.textValue;
                        }else{
                            eVal = sItemVal.textValue.replace(/'/g,"''");
                        };
                        /*If the expression is an IN Statement and the the value is a string then
                        replace the user defines comma seperated values with single quoted values*/
                        if(queryExpr.toLowerCase().indexOf(" in (") > 0 && queryExpr.toLowerCase().indexOf("'[value]'") > -1){
                            //replace the begining and trailing single qoutes if they exist
                            eVal = eVal.replace(/^'|'$/g, "").replace(/,|','/g, "','");
                        }
						if (sItemVal.isValueRequired && !sItemVal.hasAValue()){
							// no value specified so skip this part of where clause
							continue;
						};

						if(sItemVal.textValue.toLowerCase() == "all" && !sItemVal.isTextBox()){
							var mExpr:String = queryExpr.replace("=", "IN(") + ")";
							var uList:String = configSearchText[i].expr[j].values[sg].userlist;
                            var myPat:RegExp = /,all/gi;
                            uList = uList.replace(myPat, "");
							var uaList:Array = uList.split(",");
							if(mExpr.indexOf("'[value]'") > -1){
								uList = uaList.join("','");
							}
							criteriaFromValue = mExpr.replace(myPattern, uList);
							expr = AppendTo(expr, criteriaFromValue, sItemVal.operator);
						}else if(sItemVal.textValue.toLowerCase() == "allu" && !sItemVal.isTextBox()){
							expr = AppendTo(expr, "1=1", sItemVal.operator);
						}else if(sItemVal.textValue.toLowerCase() == "null"){
							var mExpr2:String = queryExpr.substr(0, queryExpr.indexOf("=")) + " is null";
							expr = AppendTo(expr, mExpr2, sItemVal.operator);
						}else{
							//don't add the expression if there is no user input
							if(eVal != ""){
								criteriaFromValue = queryExpr.replace(myPattern, eVal);
								expr = AppendTo(expr, criteriaFromValue, sItemVal.operator);
							}
						}
					}

					query.where = expr;
					query.outSpatialReference = map.spatialReference;
					if(queryDefExpr != ""){
						queryLayer.definitionExpression = queryDefExpr;
					}
                    map.cursorManager.setBusyCursor();
					qFeatLayer.selectFeatures(query, selectionMethodText.selectedItem.selectionName, new AsyncResponder(onResult, onFault, queryFields));
					showMessage(loadingLabel, true);
					showStateResults();

					// on result
					function onResult(feats:Array, token:XMLList = null):void
					{
						try{
							createFeatureSet(feats);
							qFeatLayer.selectionColor = Number.NaN;
							var gid:Number = 0;
							for each (var gra:Graphic in feats){
								var obj:Object = gra.attributes;
								if(typeQ == "layer"){
									if(!queryLayer.layerDetails.objectIdField){
										obj["oid"] = gid;
										gid ++;
									}else{
										obj["oid"] = gra.attributes[queryLayer.layerDetails.objectIdField];
									}
								}else{
									if(!queryLayer.tableDetails.objectIdField){
										obj["oid"] = gid;
										gid ++;
									}else{
										obj["oid"] = gra.attributes[queryLayer.tableDetails.objectIdField];
									}
								}
							}
							var adding:Boolean;
							var removing:Boolean;
							if(selectionMethodText.selectedItem.selectionName == FeatureLayer.SELECTION_ADD){
								adding = true;
							}else if(selectionMethodText.selectedItem.selectionName == FeatureLayer.SELECTION_SUBTRACT){
								removing = true;
							}
							if(queryLayerRels && queryLayerRels.length > 0){
								searchResultAC = createSearchResults((adding || removing)?feats:qFeatLayer.selectedFeatures, token, queryLayerRels, "queryFeaturesText", adding, removing);
                                if(queryLayerRels.length == 1){
                                    relateToolTip = queryLayerRels[0].label;
                                }else{
                                    relateToolTip = configXML.relatetooltip || "Show Relates";
                                }
							}else{
								searchResultAC = createSearchResults((adding || removing)?feats:qFeatLayer.selectedFeatures, token, null, "queryFeaturesText", adding, removing);
							}

							// share data
							addSharedData(widgetTitle, searchResultAC);
							showMessage(selectionLabel + " " + qFeatSet.features.length, false);
							if(floatorfixed == "float"){
								if (myfloatdg){
									if(myfloatdg.datagrid.dataProvider){
										myfloatdg.datagrid.dataProvider.removeAll();
									}
									myfloatdg.csvExportOptionLbl = exp2csvOptLbl;
									myfloatdg.txtExportOptionLbl = exp2txtOptLbl;
									myfloatdg.ExportButtonLbl = expBtnLbl;
									myfloatdg.csvSeperator = csvSep;
									myfloatdg.dgFieldAliases = fldAliases;
									myfloatdg.csvName = _csvName;
									myfloatdg.sumField = sumField;
									myfloatdg.labelSum = lblSum;
									myfloatdg.hasRelates = (queryLayerRels && queryLayerRels.length > 0);
									myfloatdg.RelateIcon = relateIcon;
									myfloatdg.RelateToolTip = relateToolTip;
									myfloatdg.dgColumns = gridFields;
									myfloatdg.dgHyperColumns = gridHyperFields;
									myfloatdg.dProvider = gridDataProvider;
									myfloatdg.featlayer = qFeatLayer;
									myfloatdg.zoomScale = zoomScale;
									myfloatdg.zoomPercent = zoomPercent;
									myfloatdg.ownerWidget = sWidget;
									myfloatdg.featLayer = queryLayer;
									myfloatdg.layerDetails = (queryLayer.layerDetails)?queryLayer.layerDetails:queryLayer.tableDetails;
									myfloatdg.enableExport = queryEnableExport;
									myfloatdg.printLabel = getDefaultString('printSubmitLabel');
									myfloatdg.enablePrint = queryEnablePrint;
									myfloatdg.widgetInteract = widgetAndGridIteract;
									myfloatdg.popupsdiabled = PopUpsDisabled;
									myfloatdg.headerBGColor = dgheaderbgcolor;
									myfloatdg.repeatHeader = dgrepeatheader;
									myfloatdg.headerFontColor = dgheaderfontcolor;
									myfloatdg.footerIncludeDate = dgfooterincdate;
									myfloatdg.footerDateFormat = dgfooterdateformat;
									myfloatdg.footerDisclaimer = dgfooterdisclaimer;
									myfloatdg.footerPageofPage = dgfooterpageofpage;
									myfloatdg.dgtitle = queryPrintTitle;
									
																		//Added 7/13/2011 PWA
									//Added 7/13/2011 PWA
									myfloatdg.integrationWebService = integrationWebService;
									myfloatdg.userID = userid;
									myfloatdg.parcelLayerName = parcelLayerName;

								}
                                map.cursorManager.removeBusyCursor();
							}else if(floatorfixed == "fixed"){
								if(!gridFields){
									gridFields = configSearchText[i].gridfields;
								}
								var dgConfig:Object = {
									widgetTitle: (configSearchText[i].printtitle != "")?configSearchText[i].printtitle:configSearchText[i].label,
									csvExportOptionLbl: exp2csvOptLbl,
									txtExportOptionLbl: exp2txtOptLbl,
									ExportButtonLbl: expBtnLbl,
									csvSeperator: csvSep,
									dgFieldAliases: fldAliases,
									csvName: _csvName,
									sumField: sumField,
									labelSum: lblSum,
									hasRelates: (queryLayerRels && queryLayerRels.length > 0),
									dgColumns: gridFields,
									dgHyperColumns: gridHyperFields,
									dProvider: gridDataProvider,
									featlayer: qFeatLayer,
									zoomScale: zoomScale,
									zoomPercent: zoomPercent,
									ownerWidget: sWidget,
									featLayer: queryLayer,
									layerDetails: (queryLayer.layerDetails)?queryLayer.layerDetails:queryLayer.tableDetails,
									enableExport: queryEnableExport,
									enablePrint: queryEnablePrint,
									widgetInteract: widgetAndGridIteract,
									popupsdisabled: PopUpsDisabled,
									disableRelateTab: !(queryLayerRels && queryLayerRels.length > 0),
									relateIcon: relateIcon,
									relateToolTip: relateToolTip,
									headerBGColor: dgheaderbgcolor,
									repeatHeader: dgrepeatheader,
									headerFontColor: dgheaderfontcolor,
									includeDateInFooter: dgfooterincdate,
									footerDateFormat : dgfooterdateformat,
									footerPageofPage: dgfooterpageofpage,
									footerDisclaimer: dgfooterdisclaimer,
                                    autoOpenDataGrid: openDataGrid
								};
								var dgconfigArr:ArrayCollection = new ArrayCollection();
								dgconfigArr.addItem(dgConfig);
								addSharedData("configFixedDatagrid", dgconfigArr);
                                map.cursorManager.removeBusyCursor();
							}

							if (openDataGrid && floatorfixed != "fixed"){
								showGridResults();
                                map.cursorManager.removeBusyCursor();
							}
							if(autoZoom && searchResultAC.length > 0){
								if(typeQ == "layer"){
									if(isNaN(zoomScale)){
										zoomAll();
									}else{
										if (map.scale > zoomScale){
											map.scale = zoomScale;
										}
										map.centerAt(searchResultAC[0].point);
									}
								}
							}
						}
						catch (error:Error){
                            map.cursorManager.removeBusyCursor();
							showMessage(error.message, false);
						}
					}

					//on fault
					function onFault(info:Object, token:Object = null) : void
					{
                        map.cursorManager.removeBusyCursor();
						showMessage(info.toString(), false);
					}
				}
			}

			/*
			* Append string2 to string1 (if set) using operator
			* @param String string1 the first string
			* @param String string2 the 2nd string
			* @param String operator string to put between the strings
			* @returns String
			*/
			private function AppendTo(string1:String, string2:String, operator:String = "AND"): String
			{
				var combined:String = "";
				if (string1.length > 0){
					return string1 + " " + operator + " " + string2;
				}else{
					return string2;
				};
			}

			/*
			* Querys the feature layer based on the graphical views criteria
			* @param Geometry geom the geometry to invoke the search on
			* @param String querySpatialRel the spatial relationship of the input geomerty and the feature layers geometries
			* @param Object layerConfig the search layers configuration object
			* @param String initiator a string that specifys if this function was called by the graphical view or the Spatial view
			*/
			private function queryFeaturesGraphical(geom:Geometry, querySpatialRel:String, layerConfig:Object, initiator:String = "graphical"):void
			{
				//hide infowindow if any
				hideInfoWindow();

				var qFields:Array;
				queryLayer = layerConfig.layer;

				if(queryLayer != qFeatLayer){
					map.removeLayer(qFeatLayer);
					qFeatLayer = queryLayer;
					qFeatLayer.renderer = new SimpleRenderer(getFeatLyrSymbol(qFeatLayer, initiator));
                    qFeatLayer.name = qFeatLayer.id = "hiddenLayer_eSearchhSelectionLayer";
					qFeatLayer.addEventListener(FlexEvent.HIDE, featLayer_hideHandler);
					featLyrLen = qFeatLayer.selectedFeatures.length;
					map.addLayer(qFeatLayer);
				}

				var oidFld:String;
				if(queryLayer.layerDetails){
					oidFld = queryLayer.layerDetails.objectIdField;
				}
				queryGeom = geom;
				zoomScale = layerConfig.zoomscale;
				zoomPercent = layerConfig.zoompercent;
				queryFields = layerConfig.fields;
				queryExpr = layerConfig.expr;

				//get the grid fields
				setupGridFields();

				queryTitleField = layerConfig.titlefield;
				qLinks = layerConfig.links;

				queryMultiImgField = layerConfig.multi;
				queryAttachments = layerConfig.attachments;
				queryExprForSpatRel = layerConfig.useforspatial;
				queryEnableExport = layerConfig.enableexport;
				queryEnablePrint = layerConfig.enableprint;
				queryPrintTitle = queryPrintTitle = (layerConfig.printtitle != "")?layerConfig.printtitle:layerConfig.label;
				queryDefExpr = layerConfig.defexpr;
				openDataGrid = layerConfig.opendg;
				queryLayerRels = layerConfig.relates;

				var fields:XMLList;
				if (queryLayer){
					var query:Query = new Query();
					query.geometry = queryGeom;
					if(includeTextQuery.selected && includeTextQuery.enabled){
						var i:Number = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;
						var j:Number = (cboLayerExpr.selectedIndex < 0) ? 0 : cboLayerExpr.selectedIndex;
						var sItemVal:SearchExpValueItem;
						var myPattern:RegExp = /\[value\]/g;
						var expr:String = "";
						var eVal:String = "";
						var criteriaFromValue:String;

						for(var sg:Number = 0; sg < searchGroup.numElements; sg++){
							sItemVal = searchGroup.getElementAt(sg) as SearchExpValueItem;
							queryExpr = configSearchText[i].expr[j].values[sg].expression;
                            if(queryExpr == "[value]" || queryExpr.toLowerCase().indexOf(" in (") > 0){
                                //meaning an open SQL expression or an SQL with an IN Statement
                                eVal = sItemVal.textValue;
                            }else{
                                eVal = sItemVal.textValue.replace(/'/g,"''");
                            };
							if(sItemVal.textValue.toLowerCase() == "all" && !sItemVal.isTextBox()){
								var mExpr:String = queryExpr.replace("=", "IN(") + ")";
								var uList:String = configSearchText[i].expr[j].values[sg].userlist;
                                var myPat:RegExp = /,all/gi;
                                uList = uList.replace(myPat, "");
								if(mExpr.indexOf("'[value]'") > -1){
									uList = uList.replace(",", "','");
								}
								criteriaFromValue = mExpr.replace(myPattern, uList);
								expr = AppendTo(expr, criteriaFromValue, sItemVal.operator);
							}else if(sItemVal.textValue.toLowerCase() == "allu" && !sItemVal.isTextBox()){
								expr = AppendTo(expr, "1=1", sItemVal.operator);
							}else if(sItemVal.textValue.toLowerCase() == "null"){
								var mExpr2:String = queryExpr.substr(0, queryExpr.indexOf("=")) + " is null";
								expr = AppendTo(expr, mExpr2, sItemVal.operator);
							}else{
								if(eVal != ""){
									//don't add the expression if there is no user input
									criteriaFromValue = queryExpr.replace(myPattern, eVal);
									expr = AppendTo(expr, criteriaFromValue, sItemVal.operator);
								}
							}
						}
						query.where = expr;
					}
					query.returnGeometry = true;
					query.spatialRelationship = querySpatialRel;
					query.outSpatialReference = map.spatialReference;
					if(queryDefExpr != ""){
						queryLayer.definitionExpression = queryDefExpr;
					}
                    map.cursorManager.setBusyCursor();
					queryLayer.selectFeatures(query, (initiator == "graphical")?selectionMethodGraphical.selectedItem.selectionName:selectionMethodSpatial.selectedItem.selectionName, new AsyncResponder(onResult, onFault, queryFields));
					showMessage(loadingLabel, true);
					showStateResults();
					// on result
					function onResult(feats:Array, token:XMLList = null):void
					{
						try{
							createFeatureSet(feats);
							qFeatLayer.selectionColor = Number.NaN;
							var gid:Number = 0;
							for each (var gra:Graphic in feats){
								var obj:Object = gra.attributes;
								if(!queryLayer.layerDetails.objectIdField){
									obj["oid"] = gid;
									gid ++;
								}else{
									obj["oid"] = gra.attributes[queryLayer.layerDetails.objectIdField];
								}
							}
							var adding:Boolean;
							var removing:Boolean;
							if(selectionMethodGraphical.selectedItem.selectionName == FeatureLayer.SELECTION_ADD){
								adding = true;
							}else if(selectionMethodGraphical.selectedItem.selectionName == FeatureLayer.SELECTION_SUBTRACT){
								removing = true;
							}
							if(queryLayerRels && queryLayerRels.length > 0){
								searchResultAC = createSearchResults((adding || removing)?feats:qFeatLayer.selectedFeatures, token, queryLayerRels, (initiator == "graphical")?"graphical":"queryFeaturesSpatial", adding, removing);
                                if(queryLayerRels.length == 1){
                                    relateToolTip = queryLayerRels[0].label;
                                }
							}else{
								searchResultAC = createSearchResults((adding || removing)?feats:qFeatLayer.selectedFeatures, token, null, (initiator == "graphical")?"graphical":"queryFeaturesSpatial", adding, removing);
							}
							showMessage(selectionLabel + " " + qFeatSet.features.length, false);
							if(floatorfixed == "float"){
								if (myfloatdg){
									if(myfloatdg.datagrid.dataProvider){
										myfloatdg.datagrid.dataProvider.removeAll();
									}
									myfloatdg.RelateIcon = relateIcon;
									myfloatdg.RelateToolTip = relateToolTip;
									myfloatdg.csvExportOptionLbl = exp2csvOptLbl;
									myfloatdg.txtExportOptionLbl = exp2txtOptLbl;
									myfloatdg.ExportButtonLbl = expBtnLbl;
									myfloatdg.csvSeperator = csvSep;
									myfloatdg.dgFieldAliases = fldAliases;
									myfloatdg.csvName = _csvName;
									myfloatdg.sumField = sumField;
									myfloatdg.labelSum = lblSum;
									myfloatdg.hasRelates = (queryLayerRels && queryLayerRels.length > 0);
									myfloatdg.dgColumns = gridFields;
									myfloatdg.dgHyperColumns = gridHyperFields;
									myfloatdg.dProvider = gridDataProvider;
									myfloatdg.featlayer = qFeatLayer;
									myfloatdg.zoomScale = zoomScale;
									myfloatdg.zoomPercent = zoomPercent;
									myfloatdg.ownerWidget = sWidget;
									myfloatdg.layerDetails = queryLayer.layerDetails;
									myfloatdg.featLayer = queryLayer;
									myfloatdg.enableExport = queryEnableExport;
									myfloatdg.printLabel = getDefaultString('printSubmitLabel');
									myfloatdg.enablePrint = queryEnablePrint;
									myfloatdg.widgetInteract = widgetAndGridIteract;
									myfloatdg.popupsdiabled = PopUpsDisabled;
									myfloatdg.headerBGColor = dgheaderbgcolor;
									myfloatdg.repeatHeader = dgrepeatheader;
									myfloatdg.headerFontColor = dgheaderfontcolor;
									myfloatdg.footerIncludeDate = dgfooterincdate;
									myfloatdg.footerDateFormat = dgfooterdateformat;
									myfloatdg.footerDisclaimer = dgfooterdisclaimer;
									myfloatdg.footerPageofPage = dgfooterpageofpage;
									myfloatdg.dgtitle = queryPrintTitle;

									//Added 7/13/2011 PWA
									myfloatdg.integrationWebService = integrationWebService;
									myfloatdg.userID = userid;
									myfloatdg.parcelLayerName = parcelLayerName;

								}
								if (openDataGrid && floatorfixed != "fixed"){
									showGridResults();
								}
								if(autoZoom && searchResultAC.length > 0){
									if(isNaN(zoomScale)){
										zoomAll();
									}else{
										if (map.scale > zoomScale){
											map.scale = zoomScale;
										}
										map.centerAt(searchResultAC[0].point);
									}
								}
							}else if(floatorfixed == "fixed"){
								var dgConfig:Object = {
									widgetTitle: (layerConfig.printtitle != "")?layerConfig.printtitle:layerConfig.label,
									csvExportOptionLbl: exp2csvOptLbl,
									txtExportOptionLbl: exp2txtOptLbl,
									ExportButtonLbl: expBtnLbl,
									csvSeperator: csvSep,
									dgFieldAliases: fldAliases,
									csvName: _csvName,
									sumField: sumField,
									labelSum: lblSum,
									hasRelates: (queryLayerRels && queryLayerRels.length > 0),
									dgColumns: gridFields,
									dgHyperColumns: gridHyperFields,
									dProvider: gridDataProvider,
									featlayer: qFeatLayer,
									zoomScale: zoomScale,
									zoomPercent: zoomPercent,
									ownerWidget: sWidget,
									featLayer: queryLayer,
									layerDetails: (queryLayer.layerDetails)?queryLayer.layerDetails:queryLayer.tableDetails,
									enableExport: queryEnableExport,
									enablePrint: queryEnablePrint,
									widgetInteract: widgetAndGridIteract,
									popupsdisabled: PopUpsDisabled,
									disableRelateTab: !(queryLayerRels && queryLayerRels.length > 0),
									relateIcon: relateIcon,
									relateToolTip: relateToolTip,
									headerBGColor: dgheaderbgcolor,
									repeatHeader: dgrepeatheader,
									headerFontColor: dgheaderfontcolor,
									includeDateInFooter: dgfooterincdate,
									footerDateFormat : dgfooterdateformat,
									footerPageofPage: dgfooterpageofpage,
									footerDisclaimer: dgfooterdisclaimer,
                                    autoOpenDataGrid: openDataGrid
								};
								var dgconfigArr:ArrayCollection = new ArrayCollection();
								dgconfigArr.addItem(dgConfig);
								addSharedData("configFixedDatagrid", dgconfigArr);
								if(autoZoom && searchResultAC.length > 0){
									if(isNaN(zoomScale)){
										zoomAll();
									}else{
										if (map.scale > zoomScale){
											map.scale = zoomScale;
										}
										map.centerAt(searchResultAC[0].point);
									}
								}
							}
                            map.cursorManager.removeBusyCursor();
						}
						catch (error:Error){
                            map.cursorManager.removeBusyCursor();
							showMessage(error.message, false);
						}
					}

					//on fault
					function onFault(info:Object, token:Object = null) : void
					{
                        map.cursorManager.removeBusyCursor();
						showMessage(info.toString(), false);
					}
				}
			}

			/*
			* Unions the geometries of a featureset together to account for the fact that a query only wants one geometry
			* @param FeatureSet featureSet the input featureset
			* @return Geometry the union of the geometries from the input featureSet
			*/
			private function unionGeoms(featureSet:FeatureSet):Geometry
			{
				var graphic:Graphic;
				var retGeom:Geometry;
				var mPoint:Multipoint = new Multipoint(null);
				var mPoly:Polygon = new Polygon(null);
				var mPolyL:Polyline = new Polyline(null);
				var rType:String;
				for each (graphic in featureSet.features){
					if(graphic.geometry.type == "esriGeometryPoint"){
						mPoint.addPoint(graphic.geometry as MapPoint);
						rType = "point";
					}

					if(graphic.geometry.type == "esriGeometryMultipoint"){
						var mp:Multipoint = graphic.geometry as Multipoint
						var pnts:MapPoint;
						for (var p:int=0;p < mp.points.length; p++){
							mPoint.addPoint(mp.points[p]);
						}
						rType = "point";
					}

					if(graphic.geometry.type == "esriGeometryPolygon"){
						var poly:Polygon = graphic.geometry as Polygon;
						for (var i2:int = poly.rings.length - 1; i2 >= 0; i2--){
							var ringArray:Array = [];
							for (var j1:int = 0; j1 < poly.rings[i2].length; j1++){
								var mp2:MapPoint = poly.getPoint(i2,j1) as MapPoint;
								mp2.spatialReference = poly.spatialReference;
								ringArray.push(mp2);
							}
							mPoly.addRing(ringArray);
						}
						rType = "poly";
						mPoly.spatialReference = poly.spatialReference;
					}

					if(graphic.geometry.type == "esriGeometryPolyline"){
						var polyl:Polyline = graphic.geometry as Polyline;
						for(var l:int=polyl.paths.length-1; l >= 0; l--){
							var pathArray:Array = [];
							for (var j2:int = 0; j2 < polyl.paths[l].length; j2++){
								var mp3:MapPoint = polyl.getPoint(l,j2) as MapPoint;
								mp3.spatialReference = polyl.spatialReference;
								pathArray.push(mp3);
							}
							mPolyL.addPath(pathArray);
						}
						rType = "line";
					}

					if(graphic.geometry.type == "esriGeometryEnvelope"){
						var ext:Extent = graphic.geometry as Extent;
						var pA:Array = [];
						pA.push(new MapPoint(ext.xmin,ext.ymin,ext.spatialReference));
						pA.push(new MapPoint(ext.xmin,ext.ymax,ext.spatialReference));
						pA.push(new MapPoint(ext.xmax,ext.ymax,ext.spatialReference));
						pA.push(new MapPoint(ext.xmax,ext.ymin,ext.spatialReference));
						pA.push(new MapPoint(ext.xmin,ext.ymin,ext.spatialReference));
						mPoly.addRing(pA);
						rType = "poly";
					}
				}
				var graphic2:Graphic = new Graphic();
				var sfs:SimpleFillSymbol = new SimpleFillSymbol();
				sfs.color = 0x0000FF;
				sfs.alpha = 0.2;
				var sms:SimpleMarkerSymbol = new SimpleMarkerSymbol();
				sms.color = 0x0000FF;
				sms.style = SimpleMarkerSymbol.STYLE_CIRCLE;
				sms.size = 8;
				sfs.alpha = 0.4;
				var sls:SimpleLineSymbol = new SimpleLineSymbol();
				sls.color = 0x0000FF;
				sls.style = SimpleLineSymbol.STYLE_SOLID;
				sls.width = 1;
				sls.alpha = 0.4;

				switch(rType){
					case "point":{
						graphic2.geometry = mPoint;
						graphic2.symbol = sms;
						graphicsLayerBuffer.clear();
						graphicsLayerBuffer.add(graphic2);
						retGeom = mPoint;
						break;
					}
					case "poly":{
						graphic2.geometry = mPoly;
						graphic2.symbol = sfs;
						graphicsLayerBuffer.clear();
						graphicsLayerBuffer.add(graphic2);
						retGeom = mPoly;
						break;
					}
					case "line":{
						graphic2.geometry = mPolyL;
						graphic2.symbol = sls;
						graphicsLayerBuffer.clear();
						graphicsLayerBuffer.add(graphic2);
						retGeom = mPolyL;
						break;
					}
				}
				return retGeom;
			}

			/*
			* Prepare the feature(s) of the graGraphicsLayer or the query featurelayers graphics for the bufferGeometries function
			* @param Boolean isGraphicalBufferOp whether the buffer request was initiated by the graphical view or not.
			*/
			private function applyBuffer(isGraphicalBufferOp:Boolean=false):void
			{
				var graLayAC:ArrayCollection;
				if(isGraphicalBufferOp){
					graLayAC = graGraphicsLayer.graphicProvider as ArrayCollection;
				}else{
                    if(!qFeatLayer){
                        graLayAC = new ArrayCollection([]);
                    }else{
					    graLayAC = qFeatLayer.graphicProvider as ArrayCollection;
                    }
				}
				if (graLayAC.length > 0){
					geomArr = [];
					var buffUnit:Number;

					if(isGraphicalBufferOp){
						for each (var graphic:Graphic in graGraphicsLayer.graphicProvider){
							geomArr.push(graphic.geometry);
						}
						buffUnit = GeometryService[configBufferUnits[(cboGraBufferUnit.selectedIndex < 0)?0:cboGraBufferUnit.selectedIndex].name];
						bufferGeometries(geomArr,sReff,[textGraInputBuffer.text],buffUnit,isGraphicalBufferOp);
					}else{
						for each (var graphic2:Graphic in qFeatLayer.graphicProvider){
							geomArr.push(graphic2.geometry);
						}
						buffUnit = GeometryService[configBufferUnits[(cboBufferUnit.selectedIndex < 0)?0:cboBufferUnit.selectedIndex].name];
						bufferGeometries(geomArr,sReff,[textInputBuffer.text],buffUnit,isGraphicalBufferOp);
					}
				}else{
					showStateResults();
					showMessage("There is no result to buffer, please make a graphical or text search first.",false);
				}
			}

			/*
			* Buffer the array of features input
			* @param Array geomArr the input geometry array
			* @param SpatialReference sr the SpatialReference to be used in the buffer operation
			* @param Array dist the aray of distances to use in the buffer operation (more than one if a multi-ring buffer is desired).
			* @param Number unit The units for calculating each buffer distance.
			* @param Boolean isGraphicalBufferOp whether the buffer request was initiated by the graphical view or not.
			*/
			private function bufferGeometries(geomArr:Array, sr:SpatialReference, dist:Array, unit:Number, isGraphicalBufferOp:Boolean=false):void
			{
				if (geomArr){
					var bufferParameters:BufferParameters = new BufferParameters();
					var resultEvent:Polygon = new Polygon;
					bufferParameters.geometries = geomArr;
					bufferParameters.bufferSpatialReference = sr;
					bufferParameters.unit = unit;
					bufferParameters.distances = dist;
					bufferParameters.unionResults = true;
                    bufferParameters.outSpatialReference = map.spatialReference;
					geometryService.addEventListener(GeometryServiceEvent.BUFFER_COMPLETE, bufferCompleteHandler);
					geometryService.buffer(bufferParameters);

					function bufferCompleteHandler(event:GeometryServiceEvent):void
					{
						geometryService.removeEventListener(GeometryServiceEvent.BUFFER_COMPLETE, bufferCompleteHandler);
						resultEvent = event.result[0];
						try{
							var graphic:Graphic = new Graphic();
							var sfs:SimpleFillSymbol = new SimpleFillSymbol();
							var sls:SimpleLineSymbol = new SimpleLineSymbol();

							if(isGraphicalBufferOp){
								if(chkNoBufferFill){
									sfs.style = (chkNoBufferFill.selected) ? SimpleFillSymbol.STYLE_NULL : SimpleFillSymbol.STYLE_SOLID;
								}else{
									SimpleFillSymbol.STYLE_SOLID;
								}
								if(chkNoBufferOutline){
									sls.style = (chkNoBufferOutline.selected)? SimpleLineSymbol.STYLE_NULL : SimpleLineSymbol.STYLE_SOLID;
								}else{
									SimpleLineSymbol.STYLE_SOLID;
								}
								if(cpGraBufferOLColor){
									sls.color = cpGraBufferOLColor.selectedColor;
								}else{
									sls.color = 0x01b9fd;
								}
								if(linewidth){
									sls.width = linewidth.value;
								}else{
									sls.width = 1;
								}
								sfs.outline = sls;
								if(cpGraBufferColor){
									sfs.color = cpGraBufferColor.selectedColor;
								}else{
									sfs.color = 0x01b9fd;
								}
								if(hsGraBufferAlpha){
									sfs.alpha = hsGraBufferAlpha.value;
								}else{
									sfs.alpha = 0.3;
								}
							}else{
								if(chkNoBufferFill2){
									sfs.style = (chkNoBufferFill2.selected) ? SimpleFillSymbol.STYLE_NULL : SimpleFillSymbol.STYLE_SOLID;
								}else{
									SimpleFillSymbol.STYLE_SOLID;
								}
								if(chkNoBufferOutline2){
									sls.style = (chkNoBufferOutline2.selected)? SimpleLineSymbol.STYLE_NULL : SimpleLineSymbol.STYLE_SOLID;
								}else{
									SimpleLineSymbol.STYLE_SOLID;
								}
								if(cpBufferOLColor){
									sls.color = cpBufferOLColor.selectedColor;
								}else{
									sls.color = 0x01b9fd;
								}
								if(linewidth2){
									sls.width = linewidth2.value;
								}else{
									sls.width = 1;
								}
								sfs.outline = sls;
								if(cpBufferColor){
									sfs.color = cpBufferColor.selectedColor;
								}else{
									sfs.color = 0x01b9fd;
								}
								if(hsBufferAlpha){
									sfs.alpha = hsBufferAlpha.value;
								}else{
									sfs.alpha = 0.3;
								}
							}
							graphic.geometry = resultEvent;
							graphic.symbol = sfs;

							graphicsLayerBuffer.clear();
							graphicsLayerBuffer.add(graphic);
							if(isGraphicalBufferOp){
								queryFeaturesGraphical(resultEvent, "esriSpatialRelIntersects", configSearchGraphical[(cboLayerGraphical.selectedIndex < 0)?0:cboLayerGraphical.selectedIndex]);
							}
						}
						catch (error:Error){
							showMessage(error.message, false);
						}
					}
				}
			}

			/*
			* determines if there is a buffer or just drawn graphics that need to be unioned before the queryFeaturesGraphical
			* function is executed.
			* @param String spatialRelat the spatial relationship of the input geomerty and the feature layers geometries
			*/
			private function intersectResults(spatialRelat:String):void
			{
				geomArr = [];
				var graLayBufferAC:ArrayCollection = graphicsLayerBuffer.graphicProvider as ArrayCollection;
				var graLayAC:ArrayCollection = qFeatLayer.graphicProvider as ArrayCollection;
				var intersectGeom:Geometry;
				if (graLayBufferAC.length >0){
					var gra:Graphic = graLayBufferAC[0] as Graphic;
					intersectGeom =  gra.geometry;
					queryFeaturesGraphical(intersectGeom, spatialRelat, configSpatialSearchLayers[(cboSearchLayerSpatial.selectedIndex < 0)?0:cboSearchLayerSpatial.selectedIndex], "spatial");
				} else if (graLayAC.length >0) {
					intersectGeom = unionGeoms(resultsFeatureSet);
					if (GeometryUtil.polygonSelfIntersecting(intersectGeom as Polygon)){
						geometryService.simplify([intersectGeom], new AsyncResponder(simpResult, null, spatialRelat));
						function simpResult(item:Object ,spatialRelat:String):void{
							var simpGeoms:Array = item as Array;
							queryFeaturesGraphical(simpGeoms[0] as Polygon, spatialRelat, configSpatialSearchLayers[(cboSearchLayerSpatial.selectedIndex < 0)?0:cboSearchLayerSpatial.selectedIndex], "spatial");
						}
					}else{
						queryFeaturesGraphical(intersectGeom, spatialRelat,configSpatialSearchLayers[(cboSearchLayerSpatial.selectedIndex < 0)?0:cboSearchLayerSpatial.selectedIndex], "spatial");
					}
				}else{
					showStateResults();
					showMessage("There is no result to intersect, please make a graphical or text search first.",false);
				}
			}

			/*
			* Get the graphics symbol from the config file if a symbol is specified for this indivual layer or just
			* return the deault symbol for this geometry type.
			* @param Graphic graphic the graphic that a symbol should be returned for.
			* @param String initiator the specific view that initiated this function.
			* @return Symbol the Symbol of the input graphic
			*/
			private function getGraphicSymbol(graphic:Graphic, initiator:String):Symbol
			{
				var i:int;
				var sym:Symbol;
				if(initiator == "queryFeaturesText" || initiator == "queryFromURL"){
					i = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;
				}else if(initiator == "graphical"){
					i = (cboLayerGraphical.selectedIndex < 0) ? 0 : cboLayerGraphical.selectedIndex;
				}else{
					i = (cboSearchLayerSpatial.selectedIndex < 0) ? 0 : cboSearchLayerSpatial.selectedIndex;
				}

				if(graphic.geometry){
					switch (graphic.geometry.type){
						case Geometry.MAPPOINT:{
							if(initiator == "queryFeaturesText" || initiator == "queryFromURL"){
								if(configSearchText[i].symbology){
									sym = configSearchText[i].symbology;
								}else{
									sym = resultMarkerSymbol;
								};
							}else if (initiator == "graphical"){
								if(configSearchGraphical[i].symbology){
									sym = configSearchGraphical[i].symbology;
								}else{
									sym = resultMarkerSymbol;
								};
							}else{
								if(configSpatialSearchLayers.length && configSpatialSearchLayers[i].symbology){
									sym = configSpatialSearchLayers[i].symbology;
								}else{
									sym = resultMarkerSymbol;
								};
							}
							break;
						}
						case Geometry.POLYLINE:{
							if(initiator == "queryFeaturesText" || initiator == "queryFromURL"){
								if(configSearchText[i].symbology){
									sym = configSearchText[i].symbology;
								}else{
									sym = resultLineSymbol;
								};
							}else if (initiator == "graphical"){
								if(configSearchGraphical[i].symbology){
									sym = configSearchGraphical[i].symbology;
								}else{
									sym = resultLineSymbol;
								};
							}else{
								if(configSpatialSearchLayers.length && configSpatialSearchLayers[i].symbology){
									sym = configSpatialSearchLayers[i].symbology;
								}else{
									sym = resultLineSymbol;
								};
							}
							break;
						}
						case Geometry.POLYGON:{
							if(initiator == "queryFeaturesText" || initiator == "queryFromURL"){
								if(configSearchText[i].symbology){
									sym = configSearchText[i].symbology;
								}else{
									sym = resultFillSymbol;
								};
							}else if (initiator == "graphical"){
								if(configSearchGraphical[i].symbology){
									sym = configSearchGraphical[i].symbology;
								}else{
									sym = resultFillSymbol;
								};
							}else{
								if(configSpatialSearchLayers.length && configSpatialSearchLayers[i].symbology){
									sym = configSpatialSearchLayers[i].symbology;
								}else{
									sym = resultFillSymbol;
								};
							}
							break;
						}
					}
				}else{
					sym = resultSATSymbol;
				}
				return sym;
			}

			/*
			* Get the FeatureLayer symbol from the config file if a symbol is specified for this indivual layer or just
			* return the deault symbol for this geometry type.
			* @param FeatureLayer FeatLyr the FeatureLayer that a symbol should be returned for.
			* @param String initiator the specific view that initiated this function.
			* @return Symbol the Symbol of the input graphic
			*/
			private function getFeatLyrSymbol(FeatLyr:FeatureLayer, initiator:String):Symbol
			{
				var i:int;
				var sym:Symbol;
				var retClr:uint
				if(initiator == "queryFeaturesText" || initiator == "queryFromURL"){
					i = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;
				}else if(initiator == "graphical"){
					i = (cboLayerGraphical.selectedIndex < 0) ? 0 : cboLayerGraphical.selectedIndex;
				}else{
					i = (cboSearchLayerSpatial.selectedIndex < 0) ? 0 : cboSearchLayerSpatial.selectedIndex;
				}

				switch (FeatLyr.layerDetails.geometryType){
					case Geometry.MAPPOINT:{
						if(initiator == "queryFeaturesText" || initiator == "queryFromURL"){
							if(configSearchText[i].symbology){
								sym = configSearchText[i].symbology;
							}else{
								sym = resultMarkerSymbol;
							};
						}else if (initiator == "graphical"){
							if(configSearchGraphical[i].symbology){
								sym = configSearchGraphical[i].symbology;
							}else{
								sym = resultMarkerSymbol;
							};
						}else{
							if(configSpatialSearchLayers[i].symbology){
								sym = configSpatialSearchLayers[i].symbology;
							}else{
								sym = resultMarkerSymbol;
							};
						}
						break;
					}
					case Geometry.POLYLINE:{
						if(initiator == "queryFeaturesText" || initiator == "queryFromURL"){
							if(configSearchText[i].symbology){
								sym = configSearchText[i].symbology;
							}else{
								sym = resultLineSymbol;
							};
						}else if (initiator == "graphical"){
							if(configSearchGraphical[i].symbology){
								sym = configSearchGraphical[i].symbology;
							}else{
								sym = resultLineSymbol;
							};
						}else{
							if(configSpatialSearchLayers[i].symbology){
								sym = configSpatialSearchLayers[i].symbology;
							}else{
								sym = resultLineSymbol;
							};
						}
						break;
					}
					case Geometry.POLYGON:{
						if(initiator == "queryFeaturesText" || initiator == "queryFromURL"){
							if(configSearchText[i].symbology){
								sym = configSearchText[i].symbology;
							}else{
								sym = resultFillSymbol;
							};
						}else if (initiator == "graphical"){
							if(configSearchGraphical[i].symbology){
								sym = configSearchGraphical[i].symbology;
							}else{
								sym = resultFillSymbol;
							};
						}else{
							if(configSpatialSearchLayers[i].symbology){
								sym = configSpatialSearchLayers[i].symbology;
							}else{
								sym = resultFillSymbol;
							};
						}
						break;
					}
				}
				return sym;
			}

			/*
			* Create search results for the widgets results view to dispay
			* @param Array feats the graphics that are selected in the FeatureLayer
			* @param XMLList queryFields the xml list that specifys details about the fields
			* @param Array queryRelates the array of relates for the featureLayer
			* @param String initiator the name of which view initiated this function
			* @return ArrayCollection the ArrayCollection of the formated results
			*/
			private function createSearchResults(feats:Array, queryFields:XMLList, queryRelates:Array = null, initiator:String = null, adding:Boolean = false, removing:Boolean = false):ArrayCollection
			{
				var a:int;
				if(qFeatLayer.layerDetails){
					layerDetails = qFeatLayer.layerDetails;
				}else{
					layerDetails = qFeatLayer.tableDetails;
				}
				var fields:XMLList = qFeatLayer ? queryFields.field : null;

				var result:ArrayCollection = new ArrayCollection();
				if (!queryTitleField){
					queryTitleField = layerDetails.displayField;
				}
				fldAliases = qFeatSet.fieldAliases;
				var gSym:Symbol;
				if(feats.length > 0){
					gSym = getGraphicSymbol(feats[0], initiator);
				}

				for each (var graphic:Graphic in feats){
					var value:String = "";
					var title:String = "";
					var content:String = "";
					var multi:String = "";
					lyrQLinks = [];

					//work with the links now
					for (a = 0; a < qLinks.length; a++){
						var link:String = "";
						var alias:String = "";
						var linkicon:String = "";
                        var linkFieldNull:Boolean = false;
						if(qLinks[a].disablelinksifnull){
							var lfields:Array = getFieldsFromCDATA(qLinks[a].link);
							for (var lf:int=0; lf<lfields.length; lf++){
								if(!graphic.attributes[lfields[lf]] || graphic.attributes[lfields[lf]] == ""){
									linkFieldNull = true;
									break;
								}
							}
						}
						if(linkFieldNull){
							link = "";
						}else{
							link = com.esri.ags.utils.StringUtil.substitute(qLinks[a].link, graphic.attributes);
						}
                        var sub:String = com.esri.ags.utils.StringUtil.substitute(qLinks[a].alias, graphic.attributes);
						alias = (sub) ? sub : qLinks[a].alias;
						linkicon = com.esri.ags.utils.StringUtil.substitute(qLinks[a].icon, graphic.attributes);
						var lObj:Object ={
							link: link,
							icon: linkicon,
							alias: alias
						};
						lyrQLinks.push(lObj);
					}

					if (queryFields && queryFields[0].@all[0] == "true"){
						if (layerDetails.fields){
							for each (var field2:Field in layerDetails.fields){
								if (field2.name in graphic.attributes){
									displayFields(field2.name, getFieldXML(field2.name, fields), field2);
								}
							}
						}else{
							for (var fieldName2:String in graphic.attributes){
								displayFields(fieldName2, getFieldXML(fieldName2, fields), null);
							}
						}
					}else{
						for each (var fieldXML2:XML in fields){ // display the fields in the same order as specified
							if (fieldXML2.@name[0] in graphic.attributes){
								displayFields(fieldXML2.@name[0], fieldXML2, getField(fieldXML2.@name[0]));
							}
						}
					}

					function displayFields(fieldName:String, fieldXML:XML, field:Field):void
					{
						value = (graphic.attributes[fieldName] != null) ? String(graphic.attributes[fieldName]) : "";
						if (value){
							var isDateField:Boolean;
							var dateFormat:String;
							var numFormat:String;
							var curFormat:String;
							var useUTC:Boolean;
							if (fieldXML){
								numFormat = fieldXML.@numberformat[0];
								curFormat = fieldXML.@currencyformat[0];
								useUTC = fieldXML.@useutc[0] == "true";
								dateFormat = fieldXML.@dateformat[0];
								if (dateFormat){
									isDateField = true;
								}
							}
							if (!isDateField && field){
								isDateField = field.type == Field.TYPE_DATE;
							}
							if (isDateField){
								var dateMS:Number = Number(value);
								if (!isNaN(dateMS)){
									//Fix the date format to use the Spark format
									if(dateFormat){
										dateFormat = dateFormat.replace(/D/g, "d").replace(/Y/g, "y");
									}
									value = msToDate(dateMS, dateFormat, useUTC);
								}
							}

							if(numFormat){
								var args:Array = numFormat.split("|");
								if(args[0]){
									numFormatter.fractionalDigits = args[0];
								}
								if(args[1]){
									numFormatter.useGrouping = true;
									numFormatter.groupingSeparator = args[1];
								}else{
									numFormatter.useGrouping = false;
								}
								if(args[2]){
									numFormatter.decimalSeparator = args[2];
								}
								value = numFormatter.format(value);
							}

							if(curFormat){
								var args2:Array = curFormat.split("|");
								if(args2[0]){
									currFormatter.currencySymbol = args2[0];
									currFormatter.useCurrencySymbol = true;
								}
								if(args2[1])
									currFormatter.fractionalDigits = args2[1];
								if(args2[2]){
									currFormatter.useGrouping = true;
									currFormatter.groupingSeparator = args2[2];
								}else{
									currFormatter.useGrouping = false;
								}
								if(args2[3]){
									currFormatter.decimalSeparator = args2[3];
								}
								value = currFormatter.format(value);
							}
							if(layerDetails && field){
								var typeID:String = layerDetails.typeIdField ? graphic.attributes[fieldName] : null;
								if (layerDetails.typeIdField && fieldName.toUpperCase() == layerDetails.typeIdField.toUpperCase()){
									// replace value with feature type name
									var featureType:FeatureType = getFeatureType(typeID);
									if (featureType && featureType.name){
										value = featureType.name;
									}
								}else{
									// replace value with coded value name if one exists
									var codedValue:CodedValue = getCodedValue(fieldName, value, typeID);
									if (codedValue){
										value = codedValue.name;
									}
								}
							}
						}
						if (fieldName.toUpperCase() == queryTitleField.toUpperCase()){
							title = value;
							if (!title){
								title = widgetTitle;
							}
						}
						if (fieldName.toUpperCase() == queryMultiImgField.toUpperCase()){
							multi = value;
						}
						if (fieldName.toUpperCase() != "SHAPE_LENGTH"
							&& fieldName.toUpperCase() != "SHAPE_AREA"
							&& fieldName.toUpperCase() != queryMultiImgField.toUpperCase()
							&& fieldName.toUpperCase() != queryTitleField.toUpperCase()){
							if(fieldXML){
								if(fieldXML.@gridfieldonly[0] && fieldXML.@gridfieldonly[0] == "true" ||
									fieldXML.@hyperlinkgridfieldonly[0] && fieldXML.@hyperlinkgridfieldonly[0] == "true"){
									//ignore
								}else{
									if(!fieldXML.@visible[0] || (fieldXML.@visible[0] && fieldXML.@visible[0] != "false")){
										if (fieldXML && fieldXML.@alias[0]){
											content += "<b>" + fieldXML.@alias[0];
										}else{
											content += "<b>" + qFeatSet.fieldAliases[fieldName];
										}
										content += ": </b><i>" + value + "</i><br>";
									}
								}
							}else{
								if(fieldName != "oid"){
									content += "<b>" + qFeatSet.fieldAliases[fieldName];
									content += ": </b><i>" + value + "</i><br>";
								}
							}
						}
					}
					graphic.checkForMouseListeners = false;
					graphic.symbol = gSym;
					var searchResult:SearchResult = new SearchResult();
					searchResult.title = title;
					searchResult.content = content.substr(0,content.length - 4);
					if(graphic.geometry){
						searchResult.point = getGeomCenter(graphic);
					}
					searchResult.links = lyrQLinks;
					searchResult.relateicon = relateIcon ? relateIcon : null;
					searchResult.multi = multi ? multi :null;
					if(graphic.geometry){
						searchResult.zoomscale = zoomScale;
						searchResult.zoompercent = zoomPercent;
					}

					if(!qFeatLayer.layerDetails){
						if(!qFeatLayer.tableDetails.objectIdField){
							searchResult.oid = graphic.attributes["oid"];
						}else{
							searchResult.oid = graphic.attributes[qFeatLayer.tableDetails.objectIdField];
						}
					}else{
						if(!qFeatLayer.layerDetails.objectIdField){
							searchResult.oid = graphic.attributes["oid"];
						}else{
							searchResult.oid = graphic.attributes[qFeatLayer.layerDetails.objectIdField];
						}
					}
					searchResult.graphic = graphic;
					searchResult.relates = queryRelates;
					if(queryRelates && queryRelates.length == 1){
						searchResult.relateicon = queryRelates[0].icon;
                        searchResult.relatetooltip = queryRelates[0].label;
					}else{
					    searchResult.relatetooltip = configXML.relatetooltip || "Show Relates";
                    }

					graphic.attributes["content__pu__sr"] = searchResult.content;
					graphic.attributes["title__pu__sr"] = searchResult.title;
					graphic.attributes["oid"] = searchResult.oid;

					result.addItem(searchResult);

					if(PopUpsDisabled == false){
						// infoWindowRenderer on each graphic
						var infoWindowRenderer:ClassFactory = new ClassFactory(PopUpRenderer);
						infoWindowRenderer.properties = {popUpInfo:configurePopUpInfo(lyrQLinks)};
						graphic.infoWindowRenderer = infoWindowRenderer;
					}
				}
				if(searchResultAC){
					if(adding){
						result.addAll(searchResultAC);
					}
					if(removing){
						for(var r:int=0; r<result.length; r++){
							for(var r2:int=0; r2<searchResultAC.length; r2++){
								if(searchResultAC[r2].graphic == result[r].graphic){
									searchResultAC.removeItemAt(r2);
									break;
                                }
							}
						}
						result = searchResultAC;
					}
				}
				return result;
                
			}

			/*
			* Get the fields based on the fields used in the CDATA string
			* @param String strCDATA the input CDATA string
			* @return Array of field names
			*/
			private function getFieldsFromCDATA(strCDATA:String):Array
			{
				var retArr:Array = [];
				var b1:int = 0;
				var e1:int = 0;
				var fldName:String;
				do{
					b1 = strCDATA.indexOf("{", e1);
					if(b1 == -1 ){break;};
					e1 = strCDATA.indexOf("}", b1);
					fldName = strCDATA.substring(b1 + 1,e1);
					retArr.push(fldName);
				} while(e1 < strCDATA.length - 1)

				return retArr;
			}

			/*
			* Get the field XML based on the field name from the input XMLList
			* @param String fieldName the field name
			* @return XML based on the field name
			*/
			private function getFieldXML(fieldName:String, fields:XMLList):XML
			{
				var result:XML;

				for each (var fieldXML:XML in fields){
					if (fieldName == fieldXML.@name[0]){
						result = fieldXML;
						break;
					}
				}
				return result;
			}

			/*
			* Get the field object based on the field name
			* @param String fieldName the field name
			* @return Field from the field name
			*/
			private function getField(fieldName:String):Field
			{
				var result:Field;

				if (queryLayer && queryLayer.layerDetails){
					for each (var field:Field in queryLayer.layerDetails.fields){
						if (fieldName == field.name){
							result = field;
							break;
						}
					}
				}
				if(queryLayer && queryLayer.tableDetails){
					for each (var field2:Field in queryLayer.tableDetails.fields){
						if (fieldName == field2.name){
							result = field2;
							break;
						}
					}
				}
				return result;
			}

			/*
			* Get the feature type of the input id
			* @param String typeID the feature type
			* @return FeatureType of the input
			*/
			private function getFeatureType(typeID:String):FeatureType
			{
				var result:FeatureType;
				var featureType:FeatureType;

				if (queryLayer && queryLayer.layerDetails){
					for each (featureType in queryLayer.layerDetails.types){
						if (typeID == featureType.id){
							result = featureType;
							break;
						}
					}
				}
				if(queryLayer && queryLayer.tableDetails){
					for each (featureType in queryLayer.tableDetails.types){
						if (typeID == featureType.id){
							result = featureType;
							break;
						}
					}
				}
				return result;
			}

			/*
			* return a date string from a number and a format string and use UTC value
			* @param Number ms the number representation of the date
			* @param String dateFormat the date format to return the string in
			* @param Boolean useUTC wheter ofr not the date is UTC or local time
			*/
			private function msToDate(ms:Number, dateFormat:String, useUTC:Boolean):String
			{
				var date:Date = new Date(ms);
				if (date.milliseconds == 999){ // workaround for REST bug
					date.milliseconds++;
				}
				if (useUTC){
					date.minutes += date.timezoneOffset;
				}
				if (dateFormat){
					dateFormatter.dateTimePattern = dateFormat;
					var result:String = dateFormatter.format(date);
					if (result){
						return result;
					}else{
						return dateFormatter.errorText;
					}
				}else{
					return date.toLocaleString();
				}
			}

			private var layerDomainsCache:Dictionary = new Dictionary(); // map from queryLayer to domainsCache
			/*
			* Get the coded value from the domain
			* @param String fieldName the field to get the values from
			* @param String fieldValue the value to look up
			* @param String typeID the feature type
			* @return CodedValue the coded value
			*/
			private function getCodedValue(fieldName:String, fieldValue:String, typeID:String):CodedValue
			{
				var result:CodedValue;

				var domainsCache:Object = layerDomainsCache[queryLayer];
				if (!domainsCache){
					domainsCache = {}; // map from (fieldName + typeID) to CodedValueDomain
					layerDomainsCache[queryLayer] = domainsCache;
				}

				var domainsKey:String = fieldName + typeID;
				var codedValueDomain:CodedValueDomain;

				if (domainsKey in domainsCache){
					codedValueDomain = domainsCache[domainsKey];
				}else{
					if (typeID){
						var featureType:FeatureType = getFeatureType(typeID);
						if (featureType){
							codedValueDomain = featureType.domains[fieldName] as CodedValueDomain;
						}
					}else{
						var field:Field = getField(fieldName);
						if (field){
							codedValueDomain = field.domain as CodedValueDomain;
						}
					}
					domainsCache[domainsKey] = codedValueDomain;
				}

				if (codedValueDomain){
					for each (var codedValue:CodedValue in codedValueDomain.codedValues){
						if (fieldValue == codedValue.code){
							result = codedValue;
							break;
						}
					}
				}
				return result;
			}

			private var layerUniqueCache:Dictionary = new Dictionary(); // map from queryLayer to uniqueCache
			/*
			* Populate the SearchExpValueItem with items from a unique vals from a field
			* @param String targetField the field to get the values from
			* @param * sItemVal the dropdown that will be populated
			*/
			private function popCBwithUnique(targetField:String, sItemVal:*, targetDateFormat:String, uUseUTC:Boolean):void
			{
				var i:int = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;
				if (i == -1){
					if(configSearchText[0].layer){
						queryLayer = configSearchText[0].layer;
					}else{
						queryLayer = configSearchText[0].table;
					}
				}else{
					if(configSearchText[i].layer){
						queryLayer = configSearchText[i].layer;
					}else{
						queryLayer = configSearchText[i].table;
					}
				}

				if (queryLayer && !queryLayer.loaded){
					queryLayer.addEventListener(LayerEvent.LOAD, queryLayer_loadHandler);
					function queryLayer_loadHandler(event:LayerEvent):void
					{
						popCBwithUnique(targetField, sItemVal, targetDateFormat, uUseUTC);
					}
					return;
				}

				this.cursorManager.setBusyCursor();
				var uniqueCache:Object = layerUniqueCache[queryLayer];
				if (!uniqueCache){
					uniqueCache = {};
					layerUniqueCache[queryLayer] = uniqueCache;
				}

				var uniqueKey:String = targetField;
				var UniqueValArr:Array;

				if (uniqueKey in uniqueCache){
					UniqueValArr = uniqueCache[uniqueKey];
					sItemVal.setCBDataProvider(UniqueValArr);
					this.cursorManager.removeBusyCursor();
				}else{
					var vNum:Number = (queryLayer.layerDetails)?queryLayer.layerDetails.version:queryLayer.tableDetails.version;
					var isTenOrGreater:Boolean = (vNum >= 10);
                    
					pagingQueryTask = new PagingQueryTask(queryLayer.url, targetField, isTenOrGreater, sItemVal,
						uniqueCache, sItemVal.isValueRequired, targetDateFormat, uUseUTC, queryLayer.token, queryLayer.proxyURL);
					pagingQueryTask.addEventListener("pagingComplete",pagingQueryTask_complete);
					pagingQueryTask.execute();
				}
			}

			/*
			* handle the paging complete task and call popCBwithUnique also adding to unique vals dictionary
			*/
			private function pagingQueryTask_complete(event:Event):void
			{
				cursorManager.removeBusyCursor();
				pagingQueryTask.sItemVal.setCBDataProvider(pagingQueryTask.uniqueValues);
				if(!pagingQueryTask.pagingEscaped){
					pagingQueryTask.uniqueCache[pagingQueryTask.fieldName] = pagingQueryTask.uniqueValues;
				}
				if(popCBwithUniqueQue.length > 0){
					var arr:Object = popCBwithUniqueQue.shift();
					popCBwithUnique(arr.ufld, arr.sitemval, arr.udatefmt, arr.uuseutc);
				}
				validateSearch();
			}

			/*
			* Populate the SearchExpValueItem with items from a user list
			* @param String userList the comma seperated list of user values
			* @param SearchExpValueItem sItemVal the dropdown that will be populated
			*/
			private function popCBwithUserList(userList:String, sItemVal:SearchExpValueItem):void
			{
				configUserVals = [];

				var uArray:Array = mx.utils.StringUtil.trimArrayElements(userList,",").split(",");

				// add an empty entry if the value is not required
				if (!sItemVal.isValueRequired){
					configUserVals.push({
						value: sItemVal.noValue,
						label: sItemVal.noValue
					});
				}

				for each (var val:String in uArray){
					var uval:String = val;
					var ulbl:String = val;
					var uVal:SearchDDItem = new SearchDDItem;
					uVal.label = ulbl;
					uVal.value = uval;
					configUserVals.push(uVal);
				}
				sItemVal.setCBDataProvider(configUserVals);
			}

			/*
			* Populate the SearchExpValueItem with items from the search layers sub type
			* @param SearchExpValueItem sItemVal the dropdown that will be populated
			*/
			private function popCBwithSubType(sItemVal:SearchExpValueItem):void
			{
				configSubTypeVals = [];

				var i:int = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;
				if (i == -1){
					if(configSearchText[0].layer){
						queryLayer = configSearchText[0].layer;
					}else{
						queryLayer = configSearchText[0].table;
					}
				}else{
					if(configSearchText[i].layer){
						queryLayer = configSearchText[i].layer;
					}else{
						queryLayer = configSearchText[i].table;
					}
				}

				if (queryLayer && !queryLayer.loaded){
					queryLayer.addEventListener(LayerEvent.LOAD, queryLayer_loadHandler);
					function queryLayer_loadHandler(event:LayerEvent):void
					{
						popCBwithSubType(sItemVal);
					}
					return;
				}

				var stype:FeatureType;
				if(queryLayer.layerDetails){
					for each (stype in queryLayer.layerDetails.types){
						var stVal:String = stype.id;
						var stLbl:String = stype.name;
						var stOVal:SearchDDItem = new SearchDDItem;
						stOVal.label = stLbl;
						stOVal.value = stVal;
						configSubTypeVals.push(stOVal);
					}
					sItemVal.setCBDataProvider(configSubTypeVals);
				}else{
					for each (stype in queryLayer.tableDetails.types){
						var stTVal:String = stype.id;
						var stTLbl:String = stype.name;
						var stTOVal:SearchDDItem = new SearchDDItem;
						stTOVal.label = stTLbl;
						stTOVal.value = stTVal;
						configSubTypeVals.push(stTOVal);
					}
					sItemVal.setCBDataProvider(configSubTypeVals);
				}
			}

			/*
			* Populate the SearchExpValueItem with items from a fields domain
			* @param String fieldName the name of the field that contains the domain
			* @param SearchExpValueItem sItemVal the dropdown that will be populated
			*/
			private function popCBwithDomain(fieldName:String, sItemVal:SearchExpValueItem):void
			{
				configDomainVals = [];

				var tfield:Field;

				var i:int = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;
				if (i == -1){
					if(configSearchText[0].layer){
						queryLayer = configSearchText[0].layer;
					}else{
						queryLayer = configSearchText[0].table;
					}
				}else{
					if(configSearchText[i].layer){
						queryLayer = configSearchText[i].layer;
					}else{
						queryLayer = configSearchText[i].table;
					}
				}

				if (queryLayer && !queryLayer.loaded){
					queryLayer.addEventListener(LayerEvent.LOAD, queryLayer_loadHandler);
					function queryLayer_loadHandler(event:LayerEvent):void
					{
						popCBwithDomain(fieldName, sItemVal);
					}
					return;
				}

				var domainsCache:Object = layerDomainsCache[queryLayer];
				if (!domainsCache){
					domainsCache = {}; // map from fieldName to CodedValueDomain
					layerDomainsCache[queryLayer] = domainsCache;
				}

				var domainsKey:String = fieldName;
				var codedValueDomain:CodedValueDomain;
				var rangeDomain:RangeDomain;

				if (domainsKey in domainsCache){
					if(domainsCache[domainsKey].hasOwnProperty("codedValues")){
						codedValueDomain = domainsCache[domainsKey];
					}else if (domainsCache[domainsKey].hasOwnProperty("minValue")){
						rangeDomain = domainsCache[domainsKey];
					}
				}else{
					var field:Field = getField(fieldName);
					if (field && field.domain && field.domain is CodedValueDomain){
						codedValueDomain = field.domain as CodedValueDomain;
						domainsCache[domainsKey] = codedValueDomain;
					}else if (field && field.domain && field.domain is RangeDomain){
						rangeDomain = field.domain as RangeDomain;
						domainsCache[domainsKey] = rangeDomain;
					}
				}

				if(codedValueDomain){
					for each (var codedValue:CodedValue in codedValueDomain.codedValues){
						var dVal:String = codedValue.code;
						var dLbl:String = codedValue.name;
						var domVal:SearchDDItem = new SearchDDItem;
						domVal.label = dLbl;
						domVal.value = dVal;
						configDomainVals.push(domVal);
					}
					sItemVal.setCBDataProvider(configDomainVals);
				}
				if(rangeDomain){
					sItemVal.restrictTextBox(rangeDomain);
					searchBtn.addEventListener(MouseEvent.CLICK, inputValidate);
					function inputValidate(evt:Event):void
					{
						sItemVal.validateNum();
					}
				}
			}

			/*
			* Get a graphics geometry center
			* @param Graphic gra the graphic that the center point is to returned for
			* @return MapPoint the center Mappoint of the input graphic
			*/
			private function getGeomCenter(gra:Graphic):MapPoint
			{
				var pt:MapPoint;
				switch (gra.geometry.type){
					case Geometry.MAPPOINT:{
						pt = gra.geometry as MapPoint;
						break;
					}
					case Geometry.POLYLINE:{
						var pl:Polyline = gra.geometry as Polyline;
						var pathCount:Number = pl.paths.length;
						var pathIndex:int = int((pathCount / 2) - 1);
						var midPath:Array = pl.paths[pathIndex];
						var ptCount:Number = midPath.length;
						var ptIndex:int = int((ptCount / 2) - 1);
						pt = pl.getPoint(pathIndex, ptIndex);
						break;
					}
					case Geometry.POLYGON:{
						var poly:Polygon = gra.geometry as Polygon;
						pt = poly.extent.center;
						break;
					}
				}
				return pt;
			}

			/*
			* Get the graphic(s) of the eDraw widget and use those to do a graphical search
			*/
			private function getDrawGra():void
			{
				if(drawGraphicsLayer){
					var geom:Geometry
					var graLayAC:ArrayCollection = drawGraphicsLayer.graphicProvider as ArrayCollection;
					if (graLayAC.length > 1){
						geom = unionGeoms2(drawGraphicsLayer);
						queryFeaturesGraphical(geom, "esriSpatialRelIntersects", configSearchGraphical[(cboLayerGraphical.selectedIndex<0)?0:cboLayerGraphical.selectedIndex]);
					}else if (graLayAC.length == 1){
						geom = (graLayAC[0] as Graphic).geometry;
						queryFeaturesGraphical(geom, "esriSpatialRelIntersects", configSearchGraphical[(cboLayerGraphical.selectedIndex<0)?0:cboLayerGraphical.selectedIndex]);
					}else if(drawGraphicsLayer.graphicProvider.length == 0){
						showStateResults();
						showMessage("There are no graphics available",false);
					}
				}else{
					showStateResults();
					showMessage("There are no graphics available",false);
				}
			}
            
            /*
            * Get the graphic(s) of the eLocate widget and use those to do a graphical search
            */
            private function getLocateGra():void
            {
                if(locateGraphicsLayer){
                    var geom:Geometry
                    var graLayAC:ArrayCollection = locateGraphicsLayer.graphicProvider as ArrayCollection;
                    if (graLayAC.length > 1){
                        geom = unionGeoms2(locateGraphicsLayer);
                        queryFeaturesGraphical(geom, "esriSpatialRelIntersects", configSearchGraphical[(cboLayerGraphical.selectedIndex<0)?0:cboLayerGraphical.selectedIndex]);
                    }else if (graLayAC.length == 1){
                        geom = (graLayAC[0] as Graphic).geometry;
                        queryFeaturesGraphical(geom, "esriSpatialRelIntersects", configSearchGraphical[(cboLayerGraphical.selectedIndex<0)?0:cboLayerGraphical.selectedIndex]);
                    }else if(locateGraphicsLayer.graphicProvider.length == 0){
                        showStateResults();
                        showMessage("There are no graphics available",false);
                    }
                }else{
                    showStateResults();
                    showMessage("There are no graphics available",false);
                }
            }

			/*
			* Get the graphic(s) of the buffer widget and use those to do a graphical search
			*/
			private function getBufferGra():void
			{
				if(bufferGraphicsLayer){
					var geom:Geometry
					var graLayAC:ArrayCollection = bufferGraphicsLayer.graphicProvider as ArrayCollection;
					if (graLayAC.length > 1){
						geom = unionGeoms2(bufferGraphicsLayer);
						queryFeaturesGraphical(geom, "esriSpatialRelIntersects", configSearchGraphical[(cboLayerGraphical.selectedIndex<0)?0:cboLayerGraphical.selectedIndex]);
					}else if (graLayAC.length == 1){
						geom = (graLayAC[0] as Graphic).geometry;
						queryFeaturesGraphical(geom, "esriSpatialRelIntersects", configSearchGraphical[(cboLayerGraphical.selectedIndex<0)?0:cboLayerGraphical.selectedIndex]);
					}else if(bufferGraphicsLayer.graphicProvider.length == 0){
						showStateResults();
						showMessage("There are no graphics availible",false);
					}
				} else {
					showStateResults();
					showMessage("There are no graphics availible",false);
				}
			}

			/*
			* Check to see if the eDraw widgets graphics layer exists in the map and if so add eventlisteners
			* for when graphics are added, deleted, or the graphicsLayer is cleared
			*/
			private function checkForeDrawGL(evt:Event):void
			{
				MapUtil.forEachMapLayer(map, function(layer:Layer):void
				{
					if(layer.name.toLowerCase() == "draw features"){
						drawGraphicsLayer = layer as GraphicsLayer;
						drawGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_ADD, checkeDrawNumGras);
						drawGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_REMOVE, checkeDrawNumGras);
						drawGraphicsLayer.addEventListener(GraphicsLayerEvent.GRAPHICS_CLEAR, checkeDrawNumGras);
					}
				});
			}
            
            /*
            * Check to see if the eLocate widgets graphics layer exists in the map and if so add eventlisteners
            * for when graphics are added, deleted, or the graphicsLayer is cleared
            */
            private function checkForeLocateGL(evt:Event):void
            {
                MapUtil.forEachMapLayer(map, function(layer:Layer):void
                {
                    if(layer.name.toLowerCase() == "elocate features"){
                        locateGraphicsLayer = layer as GraphicsLayer;
                        locateGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_ADD, checkeLocateNumGras);
                        locateGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_REMOVE, checkeLocateNumGras);
                        locateGraphicsLayer.addEventListener(GraphicsLayerEvent.GRAPHICS_CLEAR, checkeLocateNumGras);
                    }
                });
            }
            
			/*
			* Check to see if the eDraw widgets graphics layer has any graphics and if so enable the eDraw widget button
			*/
			private function checkeDrawNumGras(event:Event):void
			{
				if (!executingURLquery){
					clearMessage();
				}
				if(drawGraphicsLayer){
					eDrawBtn.filters = (drawGraphicsLayer.numGraphics > 0)?[]:[cOver];
					eDrawBtn.buttonMode = eDrawBtn.useHandCursor = eDrawBtn.enabled = (drawGraphicsLayer.numGraphics > 0);
				}
			}
            
            /*
            * Check to see if the eLocate widgets graphics layer has any graphics and if so enable the eLocate widget button
            */
            private function checkeLocateNumGras(event:Event):void
            {
                if (!executingURLquery){
                    clearMessage();
                }
                if(locateGraphicsLayer){
                    eLocateBtn.filters = (locateGraphicsLayer.numGraphics > 0)?[]:[cOver];
                    eLocateBtn.buttonMode = eLocateBtn.useHandCursor = eLocateBtn.enabled = (locateGraphicsLayer.numGraphics > 0);
                }
            }

			/*
			* Check to see if the buffer widgets graphics layer exists in the map and if so add eventlisteners
			* for when graphics are added, deleted, or the graphicsLayer is cleared
			*/
			private function checkForpntBufferGL(evt:Event):void
			{
				MapUtil.forEachMapLayer(map, function(layer:Layer):void
				{
					if(layer.name.toLowerCase() == "buffer results"){
						bufferGraphicsLayer = layer as GraphicsLayer;
						bufferGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_ADD, checkBufferNumGras);
						bufferGraphicsLayer.addEventListener(GraphicEvent.GRAPHIC_REMOVE, checkBufferNumGras);
						bufferGraphicsLayer.addEventListener(GraphicsLayerEvent.GRAPHICS_CLEAR, checkBufferNumGras);
					}
				});
			}

			/*
			* Check to see if the buffer widgets graphics layer has any graphics and if so enable the buffer widget button
			*/
			private function checkBufferNumGras(event:Event):void
			{
				if (!executingURLquery){
					clearMessage();
				}
				if(bufferGraphicsLayer){
					pBufferBtn.filters = (bufferGraphicsLayer.numGraphics > 0)?[]:[cOver];
					pBufferBtn.buttonMode = pBufferBtn.useHandCursor = pBufferBtn.enabled = (bufferGraphicsLayer.numGraphics > 0);
				}
			}

			/*
			* Clear the search results, graphicsLayers, reset the search inputs, and clear the datagrids results
			*/
			private function clear():void
			{
				addSharedData("Deactivate_DrawTool", null); // to be able to deactivate drawTool on other widgets

				//hide infowindow if any
				hideInfoWindow();

				if(currentState == "resultsList"){
					currentState = lState;
					if(lState == "graphicalInput"){
                        setTitlebarButtonByLabel(graphicalsearchLabel);
					}else if (lState == "textInput"){
                        setTitlebarButtonByLabel(textsearchLabel);
					}else{ //spatial
                        setTitlebarButtonByLabel(spatialsearchLabel);
					}
				}
				if(qFeatLayer){
					qFeatLayer.clearSelection();
				}
                if(relqueryLayer){
                    relqueryLayer.clearSelection();
                }
				graphicsLayerBuffer.clear();
				graGraphicsLayer.clear();
				clearMessage();
				var sItemVal:SearchExpValueItem;
				for(var sgi:int = 0; sgi < searchGroup.numElements; sgi++){
					sItemVal = searchGroup.getElementAt(sgi) as SearchExpValueItem;
					if(sItemVal.isTextBox()){
						sItemVal.textValue = "";
						sItemVal.resetTxtSearch();
					}
				}
				sumField = "";
				searchResultAC = null;
				if (myfloatdg){
					myfloatdg.datagrid.dataProvider.removeAll();
					gridDataProvider = null;
					myfloatdg.sumField = "";
					//Reset the datagrids sort indicators
					var reset:Vector.<int> = Vector.<int>([]);
					myfloatdg.datagrid.columnHeaderGroup.visibleSortIndicatorIndices = reset;
				}
				if (relfloatdg){
					relfloatdg.datagrid.dataProvider.removeAll();
					relfloatdg.sumField = "";
					//Reset the datagrids sort indicators
					var rreset:Vector.<int> = Vector.<int>([]);
					relfloatdg.datagrid.columnHeaderGroup.visibleSortIndicatorIndices = rreset;
					PopUpManager.removePopUp(relfloatdg);
				}
				if(floatorfixed == "fixed"){
					addSharedData("clearFixedDatagrid", null);
				}
				if(floatorfixed == "fixed"){
					addSharedData("clearRelateFixedDatagrid", null);
				}
				searchLayerExprChangedText();
			}

			/*
			* Clear the buffer graphic
			*/
			private function clearBuffer():void
			{
				graphicsLayerBuffer.clear();
			}

			private var hitimer:uint;
			private var Hits:Array = new Array();

			/*
			* Show the widgets message
			* @param String msg the actual string (message) to display
			* @param Boolean swfVisible whether to show the loading swf with the message
			*/
			private function showMessage(msg:String, swfVisible:Boolean):void
			{
				txtMessage.text = msg;
				swfMessage.visible = swfVisible;
				msgVisible = true;
			}

			/*
			* Clear the widgets message
			*/
			private function clearMessage():void
			{
				msgVisible = false;
			}

			/*
			* When the relate icon in a datagrid is clicked get the searchResult for that row
			*/
			private function preClickSearchRelateResult(event:Event):void
			{
				var searchResult:SearchResult = ItemRenderer(event.target).data as SearchResult;
				clickSearchRelateResult(searchResult);
			}

			/*
			* Execute the relate query for a stand alone table
			*/
			public function standaloneRelate(roid:Number):void
			{
				for (var i:Number = 0; i < searchResultAC.length; i++){
					var sr:SearchResult = searchResultAC[i];
					if(sr.oid == roid){
						clickSearchRelateResult(sr);
						break;
					}
				}
			}

			//PWA Functions
			private function toggleSymbolResult(event:Event):void{
				var searchResult:SearchResult = ItemRenderer(event.target).data as SearchResult;
				var polySymbol:SimpleFillSymbol;
				for each (var grph:Graphic in qFeatLayer.graphicProvider)
				{
					if(grph.attributes.oid == searchResult.oid)
					{
						polySymbol = grph.symbol as SimpleFillSymbol;
						if(polySymbol.style == SimpleFillSymbol.STYLE_SOLID)
							grph.symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NULL, 0xFF0000, 0.5, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, 0xFF0000, 1, 2));
						else
							grph.symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, 0xFF0000, 0.5, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, 0xFF0000, 1, 2));
						return;
					}
				}
				
			}
			
			private function clearSearchResult(event:Event):void
			{
				var recAC:ArrayCollection = searchResultDG.dataProvider as ArrayCollection;
				
				hideInfoWindow();
				
				//If there is only 1 record just run the clear function that the clear link on 
				//the form already does
				if(recAC.length == 1)
				{
					clear();
					return;
				}	
				
				var searchResult:SearchResult = ItemRenderer(event.target).data as SearchResult;
				unhighlightDataGroupItems();
				
				//Remove from the results window (non-grid)
				for(var cnt:int = 0; cnt<recAC.length; ++cnt)
				{
					if(searchResult.oid === recAC[cnt].oid)
					{
						recAC.removeItemAt(cnt);
					}
				}					
				var gridDG:Array = resultsFeatureSet.attributes as Array;
				var gridAC:ArrayCollection = new ArrayCollection(gridDG);
				
				//Remove from the results window (non-grid)
				for(var cntDG:int = 0; cntDG<gridAC.length; ++cntDG)
				{
					if(searchResult.oid === gridAC[cntDG].oid)
					{
						gridAC.removeItemAt(cntDG);
					}
				}	

				addSharedData(widgetTitle, recAC);
				//Updating the Feature Selection Count label.
				showMessage(selectionLabel + " " + recAC.length, false);

				//Clear the feature from all of the graphics layer 
				//clearGraphicFromGraphicLayer(searchResult.oid,graphicsLayer);
				clearGraphicFromGraphicLayer(searchResult.oid);

				Hits.length = 0;
				
				//Remove result from the Results (Grid Format)
				if(myfloatdg){
					if(myfloatdg.datagrid.dataProvider){
						for each(var attributes:Object in gridDataProvider)
						{
							if (attributes.oid === searchResult.oid)
							{
								var myCursor:IViewCursor = (myfloatdg.datagrid.dataProvider as ArrayCollection).createCursor();
								while(!myCursor.afterLast){
									if(myCursor.current.oid == attributes.oid)
									{
										var gp:ArrayCollection = myfloatdg.datagrid.dataProvider as ArrayCollection;
										gp.removeItemAt(myfloatdg.datagrid.dataProvider.getItemIndex(myCursor.current));
										gridDataProvider = gp;
										return;
									}
									myCursor.moveNext();
								}
							}
						}                
					}
					myfloatdg.datagrid.executeBindings(true);
				}else{
				 	gridDG = gridDataProvider as Array;
				 	gridAC = new ArrayCollection(gridDG);
					
					//Remove from the results window (non-grid)
					for(var cntDG1:int = 0; cntDG<gridAC.length; ++cntDG)
					{
						if(searchResult.oid === gridAC[cntDG1].oid)
						{
							gridAC.removeItemAt(cntDG1);
						}
					}	
				}
				
				qFeatLayer.disableClientCaching = true;
				qFeatLayer.refresh();
			}
			
			//Modify 7/14/2011 PWA Clearing a graphic from the graphic layer based on the gid field
			//which is a unique value being generated by the Flex Viewer
			private function clearGraphicFromGraphicLayer(gid:Number):void
			{
				try
				{
					for each (var grph:Graphic in qFeatLayer.graphicProvider)
					{
						if(grph.attributes.oid == gid)
						{
							var query:Query = new Query();
							query.where = qFeatLayer.layerDetails.objectIdField + "= " + gid + "";
							query.outSpatialReference = map.spatialReference;
							qFeatLayer.selectFeatures(query, "subtract", null); 
							return;
						}
					}
					
					//Remove result from the Results (Grid Format)
					if(myfloatdg || floatorfixed == "float"){
						if(myfloatdg.datagrid.dataProvider){
							for each(var attributes:Object in gridDataProvider)
							{
								if (attributes.oid === gid)
								{
									var myCursor:IViewCursor = (myfloatdg.datagrid.dataProvider as ArrayCollection).createCursor();
									while(!myCursor.afterLast){
										if(myCursor.current.oid == attributes.oid)
										{
											var gp:ArrayCollection = myfloatdg.datagrid.dataProvider as ArrayCollection;
											gp.removeItemAt(myfloatdg.datagrid.dataProvider.getItemIndex(myCursor.current));
											gridDataProvider = gp;
											return;
										}
										myCursor.moveNext();
									}
									
								}
							}                
						}
					}
				}catch (e:Error) {
					Alert.show(e.message);
				}

				
				
				
				
				
				
			}	
			//END PWA FUNCTIONS

			/*
			* Execute the relate query and configure the relate fields, hyperlinks once the user
			* has chosen the specific relate they want if multiple are available
			*/
			public function clickSearchRelateResult(searchResult:SearchResult):void
			{
				var relId:int;
				var relLbl:String;
				var relPrintTitle:String;
				var relFields:XMLList;
				var relExportEnabled:Boolean;
				var relPrintEnabled:Boolean;
				var rFields:XMLList;
				qrelateFields = [];
				relateFields = [];
				relateHyperFields = [];
				sumField = "";
				var fldOrder:int = -1;

				var selRelateURL:String;

				var relArr:Array;
				if(queryLayer.layerDetails){
					relArr = queryLayer.layerDetails.relationships;
				}else{
					relArr = queryLayer.tableDetails.relationships;
				}

				if(searchResult.relates.length == 1){
					var relation:Relationship;
					for (var ri:int=0; ri < relArr.length; ri++){
						if(relArr[ri].id == searchResult.relates[0].id){
							relation = relArr[ri] as Relationship;
							break;
						}
					}
					if(queryLayer.url.indexOf("?token=") > 0){
						selRelateURL = queryLayer.url.substring(0,queryLayer.url.lastIndexOf("/")) + "/" + (relation.relatedTableId);
						selRelateURL += queryLayer.url.substring(queryLayer.url.indexOf("?token="));
					}else{
						selRelateURL = queryLayer.url.substring(0,queryLayer.url.lastIndexOf("/")) + "/" + (relation.relatedTableId);
					}
					if(!relqueryLayer){
						relqueryLayer = new FeatureLayer(selRelateURL, null, (queryLayer.token != "")?queryLayer.token:null);
                        relqueryLayer.mode = FeatureLayer.MODE_SELECTION;
					}else{
                        if(relqueryLayer.url != selRelateURL){
                            map.removeLayer(relqueryLayer);
                            relqueryLayer = new FeatureLayer(selRelateURL, null, (queryLayer.token != "")?queryLayer.token:null);
                            relqueryLayer.mode = FeatureLayer.MODE_SELECTION;
                        }
                    }
					if (relqueryLayer && !relqueryLayer.loaded){
						relqueryLayer.addEventListener(LayerEvent.LOAD, queryLayer_loadHandler);
						function queryLayer_loadHandler(levent:LayerEvent):void
						{
							clickSearchRelateResult(searchResult);
						}
						return;
					}
                    
                    if(relqueryLayer.layerDetails){
                        if(!map.getLayer("hiddenLayer_relateLayer")){
                            relqueryLayer.name = relqueryLayer.id = "hiddenLayer_relateLayer";
                            map.addLayer(relqueryLayer);
                        }
                    }

					relId = searchResult.relates[0].id;
					relPrintTitle = searchResult.relates[0].printtitle;
					relLbl = searchResult.relates[0].label;
					relFields = searchResult.relates[0].fields;
					relExportEnabled = searchResult.relates[0].enableexport;
					relPrintEnabled = searchResult.relates[0].enableprint;
                    zoomScale = searchResult.relates[0].zoomscale;
                    zoomPercent = searchResult.relates[0].zoompercent;
					if(relFields.@all[0] == "true"){
						relatesQuery.outFields = ["*"];
						relatesQuery.relationshipId = relId;
						relatesQuery.objectIds = [searchResult.oid];
                        map.cursorManager.setBusyCursor();
						queryLayer.queryRelatedFeatures(relatesQuery, new AsyncResponder(onRelateResult, onFault, searchResult.oid));
					}else{
						rFields = relFields.field;
						for each (var fieldXML:XML in rFields){
							fldOrder++;
							if(fieldXML.@sum[0] && fieldXML.@sum[0] == "true"){
								if(fieldXML.@sumlabel[0]){
									lblSum = fieldXML.@sumlabel[0];
								}
								sumField = fieldXML.@name[0];
							}
							qrelateFields.push(fieldXML.@name[0]);
							var str:String = fieldXML.@name[0] + "~";
							if(fieldXML.@alias[0]){
								if(fieldXML.@alias[0] == ""){
									str += "NA~";
								}else{
									str += fieldXML.@alias[0] + "~";
								}
							}else{
								str += "NA~";
							}
							if(fieldXML.@dateformat[0]){
								if(fieldXML.@dateformat[0] == ""){
									str += "NA~";
								}else{
									str += fieldXML.@dateformat[0] + "~";
								}
							}else{
								str += "NA~";
							}
							if(fieldXML.@currencyformat[0]){
								if(fieldXML.@currencyformat[0] == ""){
									str += "NA~";
								}else{
									str += fieldXML.@currencyformat[0] + "~";
								}
							}else{
								str += "NA~";
							}
							if(fieldXML.@numberformat[0]){
								if(fieldXML.@numberformat[0] == ""){
									str += "NA~";
								}else{
									str += fieldXML.@numberformat[0] + "~";
								}
							}else{
								str += "NA~";
							}
							if(fieldXML.@useutc[0]){
								if(fieldXML.@useutc[0] == "false"){
									str += "false~";
								}else{
									str += "true~";
								}
							}else{
								str += "NA~";
							}
							if(fieldXML.@sort[0]){
								if(fieldXML.@sort[0] == ""){
									str += "NA~";
								}else{
									str += fieldXML.@sort[0] + "~";
								}
							}else{
								str += "NA~";
							}
							str += fldOrder;
							if(!fieldXML.@hyperlinkgridfield[0]){
								relateFields.push(str);
							}
							if (fieldXML.@hyperlinkgridfield[0]){
								if (fieldXML.@hyperlinkgridfield[0]=="true"){
									var str2:String = fieldXML.@name[0] + "~";
									if(fieldXML.@alias[0]){
										if(fieldXML.@alias[0] == ""){
											str2 += "NA~";
										}else{
											str2 += fieldXML.@alias[0] + "~";
										}
									}else{
										str2 += "NA~";
									}
									if(fieldXML.@hyperlinkaliastext[0]){
										if(fieldXML.@hyperlinkaliastext[0] == ""){
											str2 += "NA~";
										}else{
											str2 += fieldXML.@hyperlinkaliastext[0] + "~";
										}
									}else{
										str2 += "NA~";
									}
									if(fieldXML.@linkprefix[0]){
										if(fieldXML.@linkprefix[0] == ""){
											str2 += "NA~";
										}else{
											str2 += fieldXML.@linkprefix[0] + "~";
										}
									}else{
										str2 += "NA~";
									}
									if(fieldXML.@linksuffix[0]){
										if(fieldXML.@linksuffix[0] == ""){
											str2 += "NA~";
										}else{
											str2 += fieldXML.@linksuffix[0] + "~";
										}
									}else{
										str2 += "NA~";
									}
									if(fieldXML.@hyperlinkgridicon[0]){
										if(fieldXML.@hyperlinkgridicon[0] == ""){
											str2 += "NA~";
										}else{
											str2 += fieldXML.@hyperlinkgridicon[0] + "~";
										}
									}else{
										str2 += "NA~";
									}
									str2 += fldOrder;
									relateHyperFields.push(str2);
								}
							}
						}
                        qrelateFields.push((relqueryLayer.layerDetails)?relqueryLayer.layerDetails.objectIdField:relqueryLayer.tableDetails.objectIdField);
						relatesQuery.outFields = qrelateFields;
						relatesQuery.relationshipId = relId;
						relatesQuery.objectIds = [searchResult.oid];
                        map.cursorManager.setBusyCursor();
						queryLayer.queryRelatedFeatures(relatesQuery, new AsyncResponder(onRelateResult, onFault, [searchResult.oid, relLbl]));
					}
				}else{
					////relqueryLayer = null;
					var relArrayColl:ArrayCollection = new ArrayCollection();
					for(var r:int=0; r < searchResult.relates.length; r++){
						var relRslt:RelateResult = new RelateResult();
						relRslt.id = searchResult.relates[r].id;
						relRslt.name = searchResult.relates[r].label;
						relRslt.fields = searchResult.relates[r].fields;
						relRslt.enableexport = searchResult.relates[r].enableexport;
						relRslt.enableprint = searchResult.relates[r].enableprint;
						relRslt.oid = searchResult.oid;
						relRslt.icon = searchResult.relates[r].icon;
						relRslt.printtitle = searchResult.relates[r].printtitle;
						relArrayColl.addItem(relRslt);
					}

					if(!rWindow){
						rWindow = new RelatesWindow();
						rWindow.dProvider = relArrayColl;
						rWindow.addEventListener("relateClicked", relateChoosen);
						PopUpManager.addPopUp(rWindow,map,true,PopUpManagerChildList.POPUP);
						PopUpManager.centerPopUp(rWindow);
						PopUpManager.bringToFront(rWindow);
					}else{
						var exists:Boolean = false;
						for (var p:Number=0;p<systemManager.popUpChildren.numChildren;p++) {
							if(systemManager.popUpChildren.getChildAt(p) is RelatesWindow){
								exists = true;
								break;
							}
						}
						if(exists == false){
							PopUpManager.addPopUp(rWindow,map,true,PopUpManagerChildList.POPUP);
						}
						PopUpManager.centerPopUp(rWindow);
						PopUpManager.bringToFront(rWindow);
					}
					rWindow.dProvider = relArrayColl;
				}

				function relateChoosen(evt:RelateChosenEvent):void{
					var cfldOrder:int = -1;
					var relArr:Array;
					if(queryLayer.layerDetails){
						relArr = queryLayer.layerDetails.relationships;
					}else{
						relArr = queryLayer.tableDetails.relationships;
					}

					var crelRslt:RelateResult = evt.data as RelateResult;

					relId = crelRslt.id;
					var relation:Relationship;
					for (var ri:int=0; ri < relArr.length; ri++){
						if(relArr[ri].id == relId){
							relation = relArr[ri] as Relationship;
							break;
						}
					}

					var relOid:Number;
					relLbl = crelRslt.name;
					relPrintTitle = crelRslt.printtitle;
					relFields = crelRslt.fields;
					relExportEnabled = crelRslt.enableexport;
					relPrintEnabled = crelRslt.enableprint;
                    zoomScale = crelRslt.zoomscale;
                    zoomPercent = crelRslt.zoompercent;
					relOid = crelRslt.oid;

					PopUpManager.removePopUp(rWindow);
					if(queryLayer.url.indexOf("?token=") > 0){
						selRelateURL = queryLayer.url.substring(0,queryLayer.url.lastIndexOf("/")) + "/" + (relation.relatedTableId);
						selRelateURL += queryLayer.url.substring(queryLayer.url.indexOf("?token="));
					}else{
						selRelateURL = queryLayer.url.substring(0,queryLayer.url.lastIndexOf("/")) + "/" + (relation.relatedTableId);
					}
					
					if(!relqueryLayer){
						relqueryLayer = new FeatureLayer(selRelateURL, null, (queryLayer.token != "")?queryLayer.token:null);
                        relqueryLayer.mode = FeatureLayer.MODE_SELECTION;
					}else{
                        if(relqueryLayer.url != selRelateURL){
                            map.removeLayer(relqueryLayer);
                            relqueryLayer = new FeatureLayer(selRelateURL, null, (queryLayer.token != "")?queryLayer.token:null);
                            relqueryLayer.mode = FeatureLayer.MODE_SELECTION;
                        }
                    }
					if (relqueryLayer && !relqueryLayer.loaded){
						relqueryLayer.addEventListener(LayerEvent.LOAD, queryLayer_loadHandler);
						function queryLayer_loadHandler(levent:LayerEvent):void
						{
							relateChoosen(evt);
						}
						return;
					}
                    
                    if(relqueryLayer.layerDetails){
                        if(!map.getLayer("hiddenLayer_relateLayer")){
                            relqueryLayer.name = relqueryLayer.id = "hiddenLayer_relateLayer";
                            map.addLayer(relqueryLayer);
                        }
                    }
                    
					if(relFields.@all[0] == "true"){
						relatesQuery.outFields = ["*"];
						relatesQuery.relationshipId = relId;
						relatesQuery.objectIds = [relOid];
                        map.cursorManager.setBusyCursor();
						queryLayer.queryRelatedFeatures(relatesQuery, new AsyncResponder(onRelateResult, onFault, relOid));
					}else{
						rFields = relFields.field;
						for each (var fieldXML:XML in rFields){
							cfldOrder++;
							if(fieldXML.@sum[0] && fieldXML.@sum[0] == "true"){
								if(fieldXML.@sumlabel[0]){
									lblSum = fieldXML.@sumlabel[0];
								}
								sumField = fieldXML.@name[0];
							}
							qrelateFields.push(fieldXML.@name[0]);
							var str:String = fieldXML.@name[0] + "~";
							if(fieldXML.@alias[0]){
								if(fieldXML.@alias[0] == ""){
									str += "NA~";
								}else{
									str += fieldXML.@alias[0] + "~";
								}
							}else{
								str += "NA~";
							}
							if(fieldXML.@dateformat[0]){
								if(fieldXML.@dateformat[0] == ""){
									str += "NA~";
								}else{
									str += fieldXML.@dateformat[0] + "~";
								}
							}else{
								str += "NA~";
							}
							if(fieldXML.@currencyformat[0]){
								if(fieldXML.@currencyformat[0] == ""){
									str += "NA~";
								}else{
									str += fieldXML.@currencyformat[0] + "~";
								}
							}else{
								str += "NA~";
							}
							if(fieldXML.@numberformat[0]){
								if(fieldXML.@numberformat[0] == ""){
									str += "NA~";
								}else{
									str += fieldXML.@numberformat[0] + "~";
								}
							}else{
								str += "NA~";
							}
							if(fieldXML.@useutc[0]){
								if(fieldXML.@useutc[0] == "false"){
									str += "false~";
								}else{
									str += "true~";
								}
							}else{
								str += "NA~";
							}
							if(fieldXML.@sort[0]){
								if(fieldXML.@sort[0] == ""){
									str += "NA~";
								}else{
									str += fieldXML.@sort[0] + "~";
								}
							}else{
								str += "NA~";
							}
							str += cfldOrder;
							if(!fieldXML.@hyperlinkgridfield[0]){
								relateFields.push(str);
							}
							if (fieldXML.@hyperlinkgridfield[0]){
								if (fieldXML.@hyperlinkgridfield[0]=="true"){
									var str2:String = fieldXML.@name[0] + "~";
									if(fieldXML.@alias[0]){
										if(fieldXML.@alias[0] == ""){
											str2 += "NA~";
										}else{
											str2 += fieldXML.@alias[0] + "~";
										}
									}else{
										str2 += "NA~";
									}
									if(fieldXML.@hyperlinkaliastext[0]){
										if(fieldXML.@hyperlinkaliastext[0] == ""){
											str2 += "NA~";
										}else{
											str2 += fieldXML.@hyperlinkaliastext[0] + "~";
										}
									}else{
										str2 += "NA~";
									}
									if(fieldXML.@linkprefix[0]){
										if(fieldXML.@linkprefix[0] == ""){
											str2 += "NA~";
										}else{
											str2 += fieldXML.@linkprefix[0] + "~";
										}
									}else{
										str2 += "NA~";
									}
									if(fieldXML.@linksuffix[0]){
										if(fieldXML.@linksuffix[0] == ""){
											str2 += "NA~";
										}else{
											str2 += fieldXML.@linksuffix[0] + "~";
										}
									}else{
										str2 += "NA~";
									}
									if(fieldXML.@hyperlinkgridicon[0]){
										if(fieldXML.@hyperlinkgridicon[0] == ""){
											str2 += "NA~";
										}else{
											str2 += fieldXML.@hyperlinkgridicon[0] + "~";
										}
									}else{
										str2 += "NA~";
									}
									str2 += cfldOrder;
									relateHyperFields.push(str2);
								}
							}
						}
                        qrelateFields.push((relqueryLayer.layerDetails)?relqueryLayer.layerDetails.objectIdField:relqueryLayer.tableDetails.objectIdField);
						relatesQuery.outFields = qrelateFields;
						relatesQuery.relationshipId = relId;
						relatesQuery.objectIds = [relOid];
                        map.cursorManager.setBusyCursor();
						queryLayer.queryRelatedFeatures(relatesQuery, new AsyncResponder(onRelateResult, onFault, [relOid, relLbl]));
					}
				}

				/*
				* Process the result of the relate query and show in the datagrid
				*/
				function onRelateResult(relatedRecords:Object, token:Object = null):void
				{
					// get related records for the first feature
					var fset:FeatureSet = (relatedRecords[token[0]]);
					if (!fset){
                        map.cursorManager.removeBusyCursor();
						Alert.show(noRelatesFound + " " + relLbl,noRelatesFoundAlertTitle,4,wTemplate,null,relateClass);
						return;
					}
					relfldAliases = fset.fieldAliases;
					if(relateFields.length == 0){
						var rfld:Field;
						for each (rfld in fset.fields){
							var str0:String = rfld.name + "~";
							str0 += rfld.alias + "~";
							str0 += "NA~";
							str0 += "NA~";
							str0 += "NA~";
							str0 += "NA";
							relateFields.push(str0);
						}
					}
					if (fset is FeatureSet){
						if(floatorfixed == "float"){
							if(!relfloatdg){
								relfloatdg = new SearchWidgetRelateFloatDG();
								PopUpManager.addPopUp(relfloatdg,map,false,PopUpManagerChildList.POPUP);
								PopUpManager.centerPopUp(relfloatdg);
							}else{
								var exists:Boolean = false;
								for (var p:Number=0;p<systemManager.popUpChildren.numChildren;p++) {
									if(systemManager.popUpChildren.getChildAt(p) is SearchWidgetRelateFloatDG){
										exists = true;
										break;
									}
								}
								if(exists == false){
									PopUpManager.addPopUp(relfloatdg,map,false,PopUpManagerChildList.POPUP);
									PopUpManager.centerPopUp(relfloatdg);
								}
							}

							if(relfloatdg.datagrid.dataProvider){
								relfloatdg.datagrid.dataProvider.removeAll();
							}
							relfloatdg.csvExportOptionLbl = exp2csvOptLbl;
							relfloatdg.txtExportOptionLbl = exp2txtOptLbl;
							relfloatdg.ExportButtonLbl = expBtnLbl;
							relfloatdg.csvSeperator = csvSep;
							relfloatdg.dgFieldAliases = relfldAliases;
							relfloatdg.csvName = relatescsvName;
							relfloatdg.sumField = sumField;
							relfloatdg.labelSum = lblSum;
							relfloatdg.dgColumns = relateFields;
							relfloatdg.dgHyperColumns = relateHyperFields;
							relfloatdg.layerDetails = (relqueryLayer.layerDetails)?relqueryLayer.layerDetails:relqueryLayer.tableDetails;
							relfloatdg.dProvider = fset.attributes;
							relfloatdg.enableExport = relExportEnabled;
							relfloatdg.enablePrint = relPrintEnabled;
							relfloatdg.dgtitle = (relPrintTitle != "")?relPrintTitle:relLbl;
							relfloatdg.printLabel = getDefaultString('printSubmitLabel');
							relfloatdg.repeatHeader = dgrepeatheader;
							relfloatdg.headerBGColor = 	dgheaderbgcolor;
							relfloatdg.headerFontColor = dgheaderfontcolor;
							relfloatdg.footerDateFormat = dgfooterdateformat;
							relfloatdg.footerDisclaimer = dgfooterdisclaimer;
							relfloatdg.footerIncludeDate = dgfooterincdate;
							relfloatdg.footerPageofPage = dgfooterpageofpage;
                            relfloatdg.rRid = relId;
                            relfloatdg.rLayer = relqueryLayer;
                            relfloatdg.zoomPercent = zoomPercent;
                            relfloatdg.zoomScale = zoomScale;
						}else if(floatorfixed == "fixed"){
							var dgConfig:Object = {
								dgFieldAliases: relfldAliases,
								csvName: relatescsvName,
								sumField: sumField,
								labelSum: lblSum,
								dgColumns: relateFields,
								dgHyperColumns: relateHyperFields,
								dProvider: fset.attributes,
								featLayer: queryLayer,
								layerDetails: (relqueryLayer.layerDetails)?relqueryLayer.layerDetails:relqueryLayer.tableDetails,
								enableExport: relExportEnabled,
								enablePrint: relPrintEnabled,
								headerBGColor: dgheaderbgcolor,
								repeatHeader: dgrepeatheader,
								headerFontColor: dgheaderfontcolor,
								includeDateInFooter: dgfooterincdate,
								footerDateFormat : dgfooterdateformat,
								footerPageofPage: dgfooterpageofpage,
								footerDisclaimer: dgfooterdisclaimer,
								widgetTitle: relPrintTitle,
                                autoOpenDataGrid: openDataGrid,
                                relateId: relId,
                                relateLayer: relqueryLayer,
                                zoomPercent: zoomPercent,
                                zoomScale: zoomScale,
                                relateToolTip: token[1]
							};
							var dgconfigArr:ArrayCollection = new ArrayCollection();
							dgconfigArr.addItem(dgConfig);
							addSharedData("configRelateFixedDatagrid", dgconfigArr);
							addSharedData("switch2RelateTabFixedDataGrid", null);
						}
					}
                    map.cursorManager.removeBusyCursor();
				}

				//on fault
				function onFault(event:Fault,data:Object):void
				{
                    map.cursorManager.removeBusyCursor();
					Alert.show(event.faultString, "Fault", 4, wTemplate, null, relateClass);
				}
			}

			/*
			* When a search result in the widget is clicked zoom to that results and scroll the datagrid
			* if the datagrid is configured and visible
			*/
			private function clickSearchResult(event:Event):void
			{
				var recAC:ArrayCollection = searchResultDG.dataProvider as ArrayCollection;
				var searchResult:SearchResult = ItemRenderer(event.target).data as SearchResult;
				unhighlightDataGroupItems();
				searchResult.selected = true;

				if(lState == "textInput"){
					var i:Number = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;
					zoomScale = configSearchText[i].zoomscale;
					zoomPercent = configSearchText[i].zoompercent;
				} else if(lState == "graphicalInput"){
					var i2:Number = cboLayerGraphical.selectedIndex;
					zoomScale = configSearchGraphical[i2].zoomscale;
					zoomPercent = configSearchGraphical[i2].zoompercent;
				}

				if (searchResult.graphic.geometry){
					if (searchResult.graphic.geometry.type == Geometry.MAPPOINT){
						if(isNaN(zoomScale)){
							map.zoom(1 / 16, searchResult.point);
							map.centerAt(searchResult.point);
						}else{
							if (map.scale > zoomScale){
								map.scale = zoomScale;
							}
							map.centerAt(searchResult.point);
						}
					}else{
						if(isNaN(zoomScale)){
							map.zoomTo(searchResult.graphic.geometry.extent.expand(zoomPercent));
						}else{
							if (map.scale > zoomScale){
								map.scale = zoomScale;
							}
							map.centerAt(searchResult.point);
						}
					}
				}

				Hits.length = 0;

				if(myfloatdg && myfloatdg.visible){
					if(myfloatdg.datagrid.dataProvider){
						for each(var attributes:Object in gridDataProvider){
							if (attributes.oid === searchResult.oid){
								var myCursor:IViewCursor = (myfloatdg.datagrid.dataProvider as ArrayCollection).createCursor();
								while(!myCursor.afterLast){
									if(myCursor.current.oid == attributes.oid){
										Hits.push(myCursor.current);
									}
									myCursor.moveNext();
								}
								myfloatdg.datagrid.selectedIndex = myfloatdg.datagrid.dataProvider.getItemIndex(Hits[0])
							}
						}
						myfloatdg.datagrid.ensureCellIsVisible(myfloatdg.datagrid.selectedIndex);
					}
				}
				if(floatorfixed == "fixed"){
					var dgConfig:Object = {
						searchResultoid: searchResult.oid
					}
					var dgconfigArr:ArrayCollection = new ArrayCollection();
					dgconfigArr.addItem(dgConfig);
					addSharedData("scrollFixedDataGrid", dgconfigArr);
				}
			}

			/*
			* When the mouse is over a search result show the info window and if the datagrid is configured and
			* visible scroll the grid to the row
			*/
			private function mouseOverSearchResult(event:Event):void
			{
				clearTimeout(hitimer);
				var searchResult:SearchResult = ItemRenderer(event.target).data as SearchResult;
				if(searchResult.point && PopUpsDisabled == false){
					if (map.extent.containsXY(searchResult.point.x, searchResult.point.y)){ // only show infowindow if search result in contained within map extent
						hitimer = setTimeout(showHighlight, 300, [ searchResult ]);
					}else{
						hideInfoWindow();
					}
				}

				Hits.length = 0;

				if(myfloatdg && myfloatdg.visible){
					if(myfloatdg.datagrid && myfloatdg.datagrid.dataProvider){
						for each(var attributes:Object in gridDataProvider){
							if (attributes.oid === searchResult.oid){
								var myCursor:IViewCursor = (myfloatdg.datagrid.dataProvider as ArrayCollection).createCursor();
								while(!myCursor.afterLast){
									if(myCursor.current.oid == attributes.oid){
										Hits.push(myCursor.current);
									}
									myCursor.moveNext();
								}
								myfloatdg.datagrid.selectedIndex = myfloatdg.datagrid.dataProvider.getItemIndex(Hits[0])
							}
						}
						myfloatdg.datagrid.ensureCellIsVisible(myfloatdg.datagrid.selectedIndex);
					}
				}
				if(floatorfixed == "fixed"){
					var dgConfig:Object = {
						searchResultoid: searchResult.oid
					}
					var dgconfigArr:ArrayCollection = new ArrayCollection();
					dgconfigArr.addItem(dgConfig);
					addSharedData("scrollFixedDataGrid", dgconfigArr);
				}
			}

			/*
			* When the mouse leaves a search result clear the hit timer
			*/
			private function mouseOutSearchResult(event:Event):void
			{
				clearTimeout(hitimer);
			}

			/*
			* Turn on the graphicslayers associated with this widget when the widget is opened
			*/
			private function widgetOpenedHandler(event:Event):void
			{
				if(qFeatLayer){
					qFeatLayer.visible = true;
				}
				if (graphicsLayerBuffer){
					graphicsLayerBuffer.visible = true;
				}
				if (graGraphicsLayer){
					graGraphicsLayer.visible = true;
				}
			}

			/*
			* Show the data grid either for the selected search layers results if one has been configured
			*/
			private function showGridResults():void
			{
				try{
					if(gridFields.length == 0){
						showMessage("No Datagrid configured for this layer", false);
						return;
					}

					if(floatorfixed == "float"){
						if(!myfloatdg){
							myfloatdg = new SearchWidgetFloatDG();
							PopUpManager.addPopUp(myfloatdg,map,false,PopUpManagerChildList.POPUP)
							PopUpManager.centerPopUp(myfloatdg);
						}else{
							var exists:Boolean = false;
							for (var p:Number=0;p<systemManager.popUpChildren.numChildren;p++) {
								if(systemManager.popUpChildren.getChildAt(p) is SearchWidgetFloatDG){
									exists = true;
									break;
								}
							}
							if(exists == false){
								PopUpManager.addPopUp(myfloatdg,map,false,PopUpManagerChildList.POPUP);
							}
							PopUpManager.centerPopUp(myfloatdg);
						}
						if(!gridFields){
							gridFields = configSearchText[0].gridfields;
						}
						myfloatdg.RelateIcon = relateIcon;
						myfloatdg.RelateToolTip = relateToolTip;
						myfloatdg.enableExport = queryEnableExport;
						myfloatdg.printLabel = getDefaultString('printSubmitLabel');
						myfloatdg.enablePrint = queryEnablePrint;
						myfloatdg.featLayer = queryLayer;
						myfloatdg.layerDetails = (queryLayer.layerDetails)?queryLayer.layerDetails:queryLayer.tableDetails;
						myfloatdg.csvSeperator = csvSep;
						myfloatdg.csvExportOptionLbl = exp2csvOptLbl;
						myfloatdg.txtExportOptionLbl = exp2txtOptLbl;
						myfloatdg.ExportButtonLbl = expBtnLbl;
						myfloatdg.csvName = _csvName;
						myfloatdg.sumField = sumField;
						myfloatdg.labelSum = lblSum;
						myfloatdg.dgFieldAliases = fldAliases;
						myfloatdg.hasRelates = (queryLayerRels && queryLayerRels.length > 0);
						myfloatdg.dgColumns = gridFields;
						myfloatdg.dgHyperColumns = gridHyperFields;
						myfloatdg.dProvider = gridDataProvider;
						myfloatdg.featlayer = qFeatLayer;
						myfloatdg.widgetInteract = widgetAndGridIteract;
						myfloatdg.popupsdiabled = PopUpsDisabled;
						myfloatdg.headerBGColor = dgheaderbgcolor;
						myfloatdg.repeatHeader = dgrepeatheader;
						myfloatdg.headerFontColor = dgheaderfontcolor;
						myfloatdg.footerIncludeDate = dgfooterincdate;
						myfloatdg.footerDateFormat = dgfooterdateformat;
						myfloatdg.footerDisclaimer = dgfooterdisclaimer;
						myfloatdg.footerPageofPage = dgfooterpageofpage;
						myfloatdg.dgtitle = queryPrintTitle;

						//Added 7/13/2011 PWA
						myfloatdg.integrationWebService = integrationWebService;
						myfloatdg.userID = userid;
						myfloatdg.parcelLayerName = parcelLayerName;
						
						if(lState == "graphicalInput"){
							var i2:Number = (cboLayerGraphical.selectedIndex<0)?0:cboLayerGraphical.selectedIndex;
							zoomScale = configSearchGraphical[i2].zoomscale;
							zoomPercent = configSearchGraphical[i2].zoompercent;
							myfloatdg.enableExport = configSearchGraphical[i2].enableexport;
							myfloatdg.enablePrint = configSearchGraphical[i2].enableprint;
							myfloatdg.dgtitle = (configSearchGraphical[i2].printtitle != "")?configSearchGraphical[i2].printtitle:configSearchGraphical[i2].label;
						}else if (lState == "textInput"){
							var i:Number = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;
							zoomScale = configSearchText[i].zoomscale;
							zoomPercent = configSearchText[i].zoompercent;
							myfloatdg.enableExport = configSearchText[i].enableexport;
							myfloatdg.enablePrint = configSearchText[i].enableprint;
							myfloatdg.dgtitle = (configSearchText[i].printtitle != "")?configSearchText[i].printtitle:configSearchText[i].label;
						}
						myfloatdg.zoomPercent = zoomPercent;
						myfloatdg.zoomScale = zoomScale;
						myfloatdg.ownerWidget = this;
					}

				}
				catch (error:Error){
					showMessage(error.message, false);
				}
			}

			/*
			* highlight specific search widgets result by OID if visible
			* @param Number oid of the graphic whose search result is to be highlighted
			*/
			public function highlightDataGroupItemByOID(oid:Number):void
			{
				if(widgetAndGridIteract){
					for (var i:Number = 0; i < searchResultAC.length; i++){
						var sr:SearchResult = searchResultAC[i];
						if(sr.oid == oid){
							sr.selected = true;
							var spDelta:Point = searchResultDG.layout.getScrollPositionDeltaToElement(i);
							if (spDelta){
								searchResultDG.verticalScrollPosition += spDelta.y;
							}
							break;
						}
					}
				}
			}

			/*
			* highlight specific search widgets results if visible
			* @param Graphic gra the graphic whose search result is to be highlighted
			*/
			public function highlightDataGroupItem(gra:Graphic):void
			{
				if(widgetAndGridIteract){
					var recAC:ArrayCollection = searchResultDG.dataProvider as ArrayCollection;
					if(gra){
						var sr:Object = gra.attributes;
						for (var i:Number = 0; i < recAC.length; i++){
							var sr1:SearchResult = searchResultAC[i];
							if(sr1.oid === sr.oid){
								sr1.selected = true;
								var spDelta:Point = searchResultDG.layout.getScrollPositionDeltaToElement(i);
								if (spDelta){
									searchResultDG.verticalScrollPosition += spDelta.y;
								}
								break;
							}
						}
					}
				}
			}

			/*
			* Unhighlight the search widgets results if visible
			*/
			public function unhighlightDataGroupItems():void
			{
				if(widgetAndGridIteract){
					var recAC:ArrayCollection = searchResultDG.dataProvider as ArrayCollection;
					if(!recAC){return;}
					for (var i:Number = 0; i < recAC.length; i++){
						var sr:SearchResult = searchResultAC[i];
						if(sr.oid == sr.oid){
							sr.selected = false;
						}
					}
				}
			}

			/*
			* Show maps info window
			*/
			private function showHighlight(params:Array):void
			{
				var searchResult:SearchResult = params[0];
				var showHighlightPoint:MapPoint = searchResult.point as MapPoint;
				popUpRenderer.popUpInfo = configurePopUpInfo(searchResult.links);
				popUpRenderer.graphic = searchResult.graphic;
				popUpRenderer.setStyle("skinClass", widgets.eSearch.skins.PopUpRendererSkin);
				
				map.infoWindow.content = popUpRenderer;
				map.infoWindow.contentOwner = popUpRenderer.graphic;
				map.infoWindow.show(showHighlightPoint);
			}

			/*
			* Configure PopUp info to include links and attachments if configured
			*/
			private function configurePopUpInfo(links:Array):PopUpInfo
			{
				var popUpInfo:PopUpInfo = new PopUpInfo;
				popUpInfo.title = "{title__pu__sr}";
				popUpInfo.description = "{content__pu__sr}";
				if(queryAttachments){
					popUpInfo.showAttachments = true;
				}
				var pminfos:Array = [];
				for(var l:int=0; l<links.length; l++){
					if (links[l].link){
						var pos:Number = links[l].link.length - 4;
						var sfx:String = String(links[l].link).substr(pos, 4).toLowerCase();
						if ((sfx == ".jpg") || (sfx == ".png") || (sfx == ".gif")){ // use PopUpMediaInfo if it is an image
							var popUpMediaInfo:PopUpMediaInfo = new PopUpMediaInfo;
							popUpMediaInfo.type = PopUpMediaInfo.IMAGE;
							popUpMediaInfo.imageLinkURL = links[l].link;
							popUpMediaInfo.imageSourceURL = links[l].link;
							pminfos.push(popUpMediaInfo);
						}else{
							var lText:String = (links[l].alias != "") ? links[l].alias : links[l].link;
							popUpInfo.description += "<br /><a href='" + links[l].link + "'>" + lText + "</a>";
						}
					}
				}
				popUpInfo.popUpMediaInfos = pminfos;

				return popUpInfo;
			}

			/*
			* Switch to the Graphical Search view
			*/
			private function showStateGraphicalSearch():void
			{
				lState = currentState;
				currentState = "graphicalInput";
                if(cboLayerGraphical.selectedIndex == -1){
                    cboLayerGraphical.selectedIndex = 0;
                }
			}

			/*
			* Switch to the Text Search view and deactivate draw tool
			*/
			private function showStateTextSearch():void
			{
				addSharedData("Deactivate_DrawTool", null);
				lState = currentState;
				currentState = "textInput";
			}

			/*
			* Switch to the Results view
			*/
			private function showStateResults():void
			{
				if(!disGrid && !disResult){
					lState = currentState;
					currentState = "resultsList";
                    setTitlebarButtonByLabel(resultsLabel);
				}
			}
            
            /*
            * Select a titlebar button by label
            */
            private function setTitlebarButtonByLabel(label:String):void
            {
                //Determine which button index is the desired button based on the label
                for(var tb:int=0; tb < wTemplate.headerToolGroup.numElements; tb++){
                    var tbb:TitlebarButton = wTemplate.headerToolGroup.getElementAt(tb) as TitlebarButton;
                    if(tbb.toolTip == label){
                        wTemplate.selectedTitlebarButtonIndex = tb;
                    }
                }
            }

			/*
			* Switch to the Spatial Search view
			*/
			private function showStateSpatialSearch():void
			{
				lState = currentState;
				currentState = "spatialInput";
			}

			/*
			* When the widget is closed hide the widgets graphic layers, info window and clear the selected
			* drawing icon
			*/
			private function widgetClosedHandler(event:Event):void
			{
				setMapAction(null, null, null, null);
				if(qFeatLayer){
					qFeatLayer.visible = false;
				}
				if(graGraphicsLayer){
					graGraphicsLayer.visible = false;
				}
				hideInfoWindow();
				setMapNavigation(null, null);

				if (selectedDrawingIcon){
					selectedDrawingIcon = null;
				}
			}

			/*
			* When the feature layer is hidden, hide the InfoWindow
			*/
			private function featLayer_hideHandler(event:FlexEvent):void
			{
				hideInfoWindow();
			}

			/*
			* Add the percent symbol to the slider tool tip
			*/
			private function sldrDataTipFormatter(value:Number):String
			{
				return int(value * 100) + "%";
			}

			/*
			* Zoom to all the serach result
			*/
			private function zoomAll():void
			{
				if(qFeatLayer.selectedFeatures){
					if (resultsFeatureSet.features.length == 1
						&& resultsFeatureSet.features[0].geometry.type == Geometry.MAPPOINT){
						var mp:MapPoint = resultsFeatureSet.features[0].geometry as MapPoint;
						map.zoom(1 / 16, mp);
						map.centerAt(mp);
					}else{
						var graphicsExtent:Extent = GraphicUtil.getGraphicsExtent(validateSelectedGeom(qFeatLayer.selectedFeatures));
						if(graphicsExtent){
							map.zoomTo(graphicsExtent.expand(zoomPercent));
						}else{
							var mp2:MapPoint = resultsFeatureSet.features[0].geometry as MapPoint;
							map.zoom(1 / 16, mp2);
							map.centerAt(mp2);
						}
					}
				}
			}

			/*
			* Validate that the selected features have valid geometry and if not remove from
			* from the returned array
			* @param Array FeatsArr the array of graphics to check for valid geometry
			* @return Array of graphics with only valid geometries
			*/
			private function validateSelectedGeom(FeatsArr:Array):Array
			{
				var gra:Graphic;
				var retFeatArr:Array = [];
				for(var i:int=0; i<FeatsArr.length; i++){
					gra = FeatsArr[i];
					if(gra.geometry){
						retFeatArr.push(gra);
					}
				}
				return retFeatArr;
			}

			/*
			* Show an alert box with the geometry service fault text
			*/
			private function geometryService_faultHandler(event:FaultEvent):void
			{
				Alert.show(event.fault.toString(), wTemplate.widgetTitle, 4, wTemplate);
			}

			/*
			* Highlight the draw tool icon
			*/
			private function iconRollOverHandler(event:MouseEvent):void
			{
				clearSelectionFilter();
				event.target.filters = [ glowFilter ];
			}

			/*
			* Clear the selected draw tool icon
			*/
			private function iconRollOutHandler(event:MouseEvent):void
			{
				clearSelectionFilter();
			}

			/*
			* Clear the selected draw tool icon
			*/
			private function clearSelectionFilter():void
			{
				for (var i:int = 0; i < imageGroup.numChildren; i++){
					if (imageGroup.getChildAt(i).filters && imageGroup.getChildAt(i).filters.length > 0){
						if (!(selectedDrawingIcon && imageGroup.getChildAt(i) === selectedDrawingIcon)){
							if(imageGroup.getChildAt(i)!== eDrawBtn && imageGroup.getChildAt(i)!== pBufferBtn){
								imageGroup.getChildAt(i).filters = [];
							}
						}
					}
				}
			}

			/*
			* Disable the draw tool on this widget if any other widget has activated the draw tool
			*/
			private function sharedDataUpdated(event:AppEvent):void
			{
				var data:Object = event.data;

				if (data.key == "Deactivate_DrawTool"){
					setMapAction(null, null, null, null);
					if (selectedDrawingIcon){
						selectedDrawingIcon.filters = [];
						selectedDrawingIcon = null;
					}
				}
			}

			/*
			* Hide the info window popup
			*/
			private function hideInfoWindow():void
			{
				if (map.infoWindow.contentOwner &&
					((map.infoWindow.contentOwner is Graphic && Graphic(map.infoWindow.contentOwner).parent === qFeatLayer) || map.infoWindow.contentOwner is Map)){
					map.infoWindow.hide();
				}
			}

			/*
			* Display the current version and build date of the eSearch Widget when holding the ALT key
			* and clcicking on the widget title
			*/
			private function DisplayVersion(evt:MouseEvent):void
			{
				if(evt.altKey){
					Alert.show("Enhanched Search Widget Version: " + VERSION + "\nBuild Date: " + BUILDDATE,
						wTemplate.widgetTitle, 4, null, null, iconClass);
				}
			}

			/*
			* If the search value textbox or dropdown is not in full view when it gets focus than scroll
			* to bring it into full view
			*/
			protected function searchGroupItem_focusInHandler(evt:FocusEvent):void {
				var idx:int = searchGroup.getElementIndex(evt.currentTarget as IVisualElement);
				var lay:VerticalLayout = searchGroup.layout as VerticalLayout;
				if (lay.fractionOfElementInView(idx) < 1) {
					pth.valueBy = lay.getScrollPositionDeltaToElement(idx).y + 3;
					anim.play([lay]);
				}
			}

			/*
			* plays the show annimation for the buffer config gear in the Graphical Search GUI
			*/
			protected function buffGraCfgBtn_clickHandler(event:MouseEvent):void
			{
				showGraPops.play();
			}

			/*
			* plays the show annimation for the buffer config gear in the Spatial Search GUI
			*/
			protected function buffCfgBtn_clickHandler(event:MouseEvent):void
			{
				showGraPops2.play();
			}

			/*
			* plays the hide annimation for the buffer config gear in the Graphical Search GUI
			*/
			protected function bufGraPropsApplyBtn_clickHandler(event:MouseEvent):void
			{
				hideGraPops.play();
			}

			/*
			* plays the hide annimation for the buffer config gear in the Spatial Search GUI
			*/
			protected function bufPropsApplyBtn_clickHandler(event:MouseEvent):void
			{
				hideGraPops2.play();
			}

			/*
			* Set the width of the DropDown to account for the longest text in the Data Provider
			*	@param Object arr the data provider of the drop down
			*	@return Number the max length needed
			*/
			protected function determineDropDownWidth(arr:Object):Number
			{
				var maxLength:Number = 0;
				var i:int=0;

				for ( i = 0; i < arr.length; i++ ) {
					var o:Object = arr[i];
					if ( ObjectUtil.isSimple(o["label"]) ) {
						var cellMetrics:TextLineMetrics = lblLayerText.measureText(o["label"]+"");
						if ( cellMetrics.width + 40 > maxLength ) {
							maxLength = cellMetrics.width + 40;
						}
					}
				}
				return maxLength;
			}

			/*
			* gets the configuration object for the currently selected search expression
			* @returns Object
			*/
			private function currentSearchExpression(): Object{

				var i:Number = (cboLayerText.selectedIndex < 0) ? 0 : cboLayerText.selectedIndex;
				var j:Number = (cboLayerExpr.selectedIndex < 0) ? 0 : cboLayerExpr.selectedIndex;

				return configSearchText[i].expr[j];
			}

			/*
			* checks that requirements have been met to allow a search
			*  and enables the search button
			*/
			public function validateSearch():void
			{
				// check that child searchexpvalueitems are valid
				var sItemVal:SearchExpValueItem;
				var isValid:Boolean = true;
				var hasAValue:Boolean = false; // does at least one criteria have a value
				for(var sgi:Number = 0; sgi < searchGroup.numElements; sgi++){
					sItemVal = searchGroup.getElementAt(sgi) as SearchExpValueItem;
					if (!sItemVal.isValid()){
						isValid = false;
					};

					if (sItemVal.hasAValue()){
						hasAValue = true;
					}
				};

				var expression:Object = currentSearchExpression();
				var isRequired:Boolean = expression.isvaluerequired; // does the expression require that at least 1 value is given

				var canSearch:Boolean = false;
				if (isRequired && !hasAValue){
					canSearch = false;
				}else{
					canSearch = true;
				};
				searchBtn.enabled = (canSearch && isValid);
			}

			/*
			* plays the annimation for the buffer config gear in the GUI
			*/
			protected function buffCfgBtn_rollOutHandler(event:MouseEvent):void
			{
				mouseOverGear.stop();
				mouseOutGear.play([event.target]);
			}

			/*
			* plays the annimation for the buffer config gear in the GUI
			*/
			protected function buffCfgBtn_rollOverHandler(event:MouseEvent):void
			{
				mouseOutGear.stop();
				mouseOverGear.play([event.target]);
			}

			//Modified 8/1/2011 Pro West & Associates Allow users to push results to table in addtion to functionality
			//on the data grid
			private function pushToResults():void{
				
				//Checking to make sure the the web service is ready 
				portalIntegrationMethods.loadWSDL();
				portalIntegrationMethods.endpointURI = integrationWebService.replace('?wsdl','');
				
				//Setting boolean flag so that it only puts the column names in there once
				var headerGenerated:Boolean = false;
				
				//Creating the shells of the xml tags
				var xmlDoc:XML =  <AttributeTable></AttributeTable>;
				var xmlColumns:XML = <Columns></Columns>;
				var xmlRows:XML= <Rows></Rows>;
				var xmlAttValues:XML = <Row></Row>;
				var xmlHeader:XML;	
											
				var dateMS:Number;
				var value:String;
				
				//Regular Expression to search for.  Since we are constructing the content array from the 
				//content property of the SearchResult object for the given graphic we need to be able to 
				//replace the newline character "\n" with a "|" that then can be used to split the string
				//into an array
				var pattern:RegExp = /\n/g;
				
				
				//Looping through each features in the resulting feature set.
				for each (var abcd:SearchResult in searchResultAC)
				{
					//Creating the array from the content property of the Search Result object from the graphic
					var contentArray:Array = abcd.content.replace(new RegExp("<b>","g"),"").replace(new RegExp("</b>","g"),"").replace(new RegExp("<i>","g"),"").replace(new RegExp("</i>","g"),"")..replace(new RegExp("<br>","g"),"\n").replace(pattern,"|").split("|");
					
					//adding the title field and value to the list since it is another field shown in the result list
					//that is not in the content
					contentArray.push(queryTitleField + ": " + abcd.title);

					xmlAttValues = <Row></Row>;
					//Checking to see if all layers are being generated or specific fields where
					//specified in the xml file for the result layer 
					if (queryFields && queryFields[0].@all[0] == "true")
					{
						if (layerDetails.fields)
						{
							for each (var field:Field in layerDetails.fields)
							{
								xmlHeader = <Column></Column>;
								//Loop through all of the fields shown in result list
								for(var contentCountAllFields:int = 0; contentCountAllFields<contentArray.length; ++contentCountAllFields)
								{
									//Split the array record on the ": " pattern to split apart the field and the value
									var fieldValuePairAllFields:Array = contentArray[contentCountAllFields].toString().split(": ");
									if (field.name == fieldValuePairAllFields[0] || field.alias == fieldValuePairAllFields[0])
									{
										if(!headerGenerated)
										{
											xmlHeader.appendChild(XMLList("<Name>" + field.alias + "</Name>"));
											xmlHeader.appendChild(XMLList("<DataType>" + field.type + "</DataType>"));
											xmlColumns.appendChild(xmlHeader);
										}
										
										value = fieldValuePairAllFields[1].toString();
										//Check to see if the field type is a date, if it is format the date using the MM/DD/YYYY format
										if(field.type.indexOf("date") != -1)
										{
											dateMS = Number(value);
											if (!isNaN(dateMS))
											{
												value = msToDate(dateMS, "MM/DD/YYYY",false).toString();
											}
										}
										if((field.type.indexOf("Int") != -1 || field.type.indexOf("Double") != -1) && (value == ""))
										{
											xmlAttValues.appendChild(XMLList("<Value>NULL</Value>"));
										}else{
											//Append the value tag containing the field's value to the Row tag
											xmlAttValues.appendChild(XMLList("<Value>" + value + "</Value>"));
										}
										
									}
								}
							}
						}else{
							Alert.show("Unable to push to results tab");
							return;
						}
					}else{		
						//Loop through each of the field tags in the fields tag in the SearchWidget.xml file for the given layer
						for each (var fieldXML:XML in queryFields.field) // display the fields in the same order as specified
						{
							//Loop through all of the fields shown in result list
							for(var contentCount:int = 0; contentCount<contentArray.length; ++contentCount)
							{
								//Split the array record on the ": " pattern to split apart the field and the value
								var fieldValuePair:Array = contentArray[contentCount].toString().split(": ");
								if (fieldXML.@name[0] == fieldValuePair[0] || fieldXML.@alias[0] == fieldValuePair[0])
								{
									//If the header has not been generated, generate it
									if(!headerGenerated)
									{
										xmlHeader = <Column></Column>;
										//For the column name, use the alias if provided else the field name
										if(fieldXML.@alias[0] == "")
											xmlHeader.appendChild(XMLList("<Name>" + fieldXML.@name[0] + "</Name>"));
										else
											xmlHeader.appendChild(XMLList("<Name>" + fieldXML.@alias[0] + "</Name>"));	
										
										xmlHeader.appendChild(XMLList("<DataType>" + getField(fieldXML.@name[0]).type + "</DataType>"));
										xmlColumns.appendChild(xmlHeader);
									}
									
									value = fieldValuePair[1].toString();
									//Check to see if the field type is a date, if it is format the date using the MM/DD/YYYY format
									if(getField(fieldXML.@name[0]).type.indexOf("date") != -1)
									{
										dateMS = Number(value);
										if (!isNaN(dateMS))
										{
											value = msToDate(dateMS, "MM/DD/YYYY",false).toString();
										}
									}
									
									if((getField(fieldXML.@name[0]).type.indexOf("Int") != -1 || getField(fieldXML.@name[0]).type.indexOf("Double") != -1) && (value == ""))
									{
										xmlAttValues.appendChild(XMLList("<Value>NULL</Value>"));
									}else{
										//Append the value tag containing the field's value to the Row tag
										xmlAttValues.appendChild(XMLList("<Value>" + value + "</Value>"));
									}
									break;
								}	
							}
							
						}
					}
					headerGenerated = true;	
					
					//Appending the rows worth of attribute data to the rows tag
					xmlRows.appendChild(xmlAttValues);
				}
				//Append the rows and columns tags to the AttributeTable Tag
				xmlDoc.appendChild(xmlColumns);
				xmlDoc.appendChild(xmlRows);

				//Populating the tblSearchResults on the SQL Server
				portalIntegrationMethods.BuildSqlResultsTable(xmlDoc,userid,layerDetails.name,layerDetails.objectIdField);
				portalIntegrationMethods.disconnect();
			}
		]]>
	</fx:Script>

	<viewer:WidgetTemplate id="wTemplate"
						   closed="widgetClosedHandler(event)"
						   open="widgetOpenedHandler(event)"
						   width="450" height="450"
						   minHeight="160"
						   minWidth="210"
						   visible="false" >
		<s:Group id="textInput"
				 width="100%" height="100%"
				 visible="false"
				 visible.textInput="true">
			<s:layout>
				<s:VerticalLayout gap="4" horizontalAlign="center" paddingTop="2" paddingLeft="10"/>
			</s:layout>
			<s:HGroup id="boxText"
					  width="100%"
					  gap="15"
					  horizontalAlign="center" verticalAlign="middle">
				<s:Label id="lblLayerText" text="{layerLabel}"/>
				<s:DropDownList id="cboLayerText" change="searchLayerChangedText()" height="25"/>
				<s:DropDownList id="selectionMethodText"
								width="50" height="25"
								itemRenderer="com.esri.ags.skins.supportClasses.EditorDropDownListItemRenderer"
								labelField="label"
								skinClass="com.esri.ags.skins.EditorSelectionDropDownListSkin"
								toolTip="{SelectionMethodTip}"
								selectedIndex="0" >
					<s:dataProvider>
						<s:ArrayList>
							<fx:Object icon="@Embed('widgets/eSearch/assets/images/NewSelection.png')"
									   label="{NewSelectionMethodTip}"
									   selectionName="{FeatureLayer.SELECTION_NEW}"/>
							<fx:Object icon="@Embed('widgets/eSearch/assets/images/AddToSelection.png')"
									   label="{AddSelectionMethodTip}"
									   selectionName="{FeatureLayer.SELECTION_ADD}"/>
							<fx:Object icon="@Embed('widgets/eSearch/assets/images/RemoveFromSelection.png')"
									   label="{RemoveSelectionMethodTip}"
									   selectionName="{FeatureLayer.SELECTION_SUBTRACT}"/>
						</s:ArrayList>
					</s:dataProvider>
				</s:DropDownList>
			</s:HGroup>
			<s:HGroup id="boxTextexpr"
					  width="100%"
					  gap="15"
					  horizontalAlign="center"  verticalAlign="middle">
				<s:Label id="lblExprText" text="{layerExprLabel}"/>
				<s:DropDownList id="cboLayerExpr" change="searchLayerExprChangedText()"/>
			</s:HGroup>
			<s:RichEditableText id="txtLabelText"
			 		 selectable="true"
					 editable="false"
					 width="100%"
					 text=""
					 textAlign="center"
					 tabEnabled="false" tabFocusEnabled="false"/>
			<s:Label id="uniqueIDStatus"
					 text="{'Processing Unique Values: ' + pagingQueryTask.featuresProcessed +
					 ' of ' + pagingQueryTask.featuresTotal + ' \n(Esc to Cancel)'}"
					 width="100%"
					 visible="{pagingQueryTask.isQuerying}"
					 includeInLayout="{pagingQueryTask.isQuerying}"/>
			<s:Scroller width="100%" height="100%" hasFocusableChildren="true">
				<s:VGroup id="searchGroup" width="100%" paddingTop="3" paddingBottom="3" gap="-1">
					<Search:SearchExpValueItem width="100%" wTemplateWidth="{wTemplate.width}" />
				</s:VGroup>
			</s:Scroller>
			<s:HGroup width="100%" horizontalAlign="center"  verticalAlign="middle">
				<s:Button id="searchBtn" label="{submitLabel}"/>
				<s:Button click="clear()" label="{clearLabel}"/>
			</s:HGroup>
		</s:Group>
		<s:Group id="graphicalInput"
				 width="100%" height="100%"
				 visible="false"
				 visible.graphicalInput="true">
			<s:layout>
				<s:VerticalLayout gap="6" horizontalAlign="center" paddingTop="2" paddingLeft="10"/>
			</s:layout>
			<s:HGroup id="boxGraphical"
					  width="100%"
					  gap="15"
					  horizontalAlign="center" verticalAlign="middle">
				<s:Label id="lblLayerGraphical" text="{layerLabel}"/>
				<s:DropDownList id="cboLayerGraphical" change="searchLayerChangedGraphical()" height="25"/>
				<s:DropDownList id="selectionMethodGraphical"
								width="50" height="25"
								itemRenderer="com.esri.ags.skins.supportClasses.EditorDropDownListItemRenderer"
								labelField="label"
								skinClass="com.esri.ags.skins.EditorSelectionDropDownListSkin"
								toolTip="{SelectionMethodTip}"
								selectedIndex="0" >
					<s:dataProvider>
						<s:ArrayList>
							<fx:Object icon="@Embed('widgets/eSearch/assets/images/NewSelection.png')"
									   label="{NewSelectionMethodTip}"
									   selectionName="{FeatureLayer.SELECTION_NEW}"/>
							<fx:Object icon="@Embed('widgets/eSearch/assets/images/AddToSelection.png')"
									   label="{AddSelectionMethodTip}"
									   selectionName="{FeatureLayer.SELECTION_ADD}"/>
							<fx:Object icon="@Embed('widgets/eSearch/assets/images/RemoveFromSelection.png')"
									   label="{RemoveSelectionMethodTip}"
									   selectionName="{FeatureLayer.SELECTION_SUBTRACT}"/>
						</s:ArrayList>
					</s:dataProvider>
				</s:DropDownList>
			</s:HGroup>
			<s:Label id="txtLabelGraphical"
					 width="100%"
					 text=""
					 textAlign="center"/>
			<s:HGroup id="imageGroup"
					  width="100%"
					  gap="10"
					  horizontalAlign="center">
                <s:Image id="eLocateBtn"
                         width="40" height="40"
                         click="getLocateGra()"
                         source= "{WIDGET_URL + 'i_draw_locate.png'}"
                         toolTip="{elocateGraLabel}"
                         visible="{eLocateEnabled}"
                         includeInLayout="{eLocateEnabled}" />
				<s:Image id="eDrawBtn"
						  width="40" height="40"
						  click="getDrawGra()"
						  source= "{WIDGET_URL + 'i_draw_draw.png'}"
						  toolTip="{drawGraLabel}"
						  visible="{eDrawEnabled}"
						  includeInLayout="{eDrawEnabled}" />
				<s:Image id="pBufferBtn"
						  width="40" height="40"
						  click="getBufferGra()"
						  source= "{WIDGET_URL + 'i_draw_buffer.png'}"
						  toolTip="{bufferGraLabel}"
						  visible="{pBufferEnabled}"
						  includeInLayout="{pBufferEnabled}" />
				<s:Image id="iSearchPnt"
						  name="{DrawTool.MAPPOINT}"
						  width="40" height="40"
						  buttonMode="true"
						  click="{activateSearchTool(event)}"
						  rollOut="iconRollOutHandler(event)"
						  rollOver="iconRollOverHandler(event)"
						  source="assets/images/i_draw_point.png"
						  toolTip="{pointLabel}"
						  useHandCursor="true"/>
				<s:Image id="iSearchLine"
						  name="{DrawTool.POLYLINE}"
						  width="40" height="40"
						  buttonMode="true"
						  click="{activateSearchTool(event)}"
						  rollOut="iconRollOutHandler(event)"
						  rollOver="iconRollOverHandler(event)"
						  source="assets/images/i_draw_line.png"
						  toolTip="{lineLabel}"
						  useHandCursor="true"/>
				<s:Image id="iSearchExt"
						  name="{DrawTool.EXTENT}"
						  width="40" height="40"
						  buttonMode="true"
						  click="{activateSearchTool(event)}"
						  rollOut="iconRollOutHandler(event)"
						  rollOver="iconRollOverHandler(event)"
						  source="assets/images/i_draw_rect.png"
						  toolTip="{rectangleLabel}"
						  useHandCursor="true"/>
				<s:Image id="iSearchPoly"
						  name="{DrawTool.POLYGON}"
						  width="40" height="40"
						  buttonMode="true"
						  click="{activateSearchTool(event)}"
						  rollOut="iconRollOutHandler(event)"
						  rollOver="iconRollOverHandler(event)"
						  source="assets/images/i_draw_poly.png"
						  toolTip="{polygonLabel}"
						  useHandCursor="true"/>
			</s:HGroup>
			<s:HGroup width="100%"
					  verticalAlign="middle"
                      gap="10">
                <s:HGroup width="100%"
                          horizontalAlign="center"
                          verticalAlign="middle"
                          paddingRight="10"
                          paddingTop="2" gap="10">
				    <s:CheckBox id="graMultiChk" selected="{multiPartGraphicSearch}" label="{enableMultiPartSearch}" change="graMultiChanged()"
                            includeInLayout="{enableMutiGra}" visible="{enableMutiGra}"/>
				    <s:Button id="graFeatureQueryBtn" click="queryFeaturesGra()" label="{submitLabel}"/>
                </s:HGroup>
				<s:Label buttonMode="true"
                         textAlign="right"
						 click="clear()"
						 fontWeight="bold"
						 text="{clearLabel}"
						 textDecoration="underline"/>
			</s:HGroup>
			<s:CheckBox id="addTolerance" selected="{applyTolleranceByDefault}" label="{lblTolerance}"
                        includeInLayout="{enableAddTollerance}" visible="{enableAddTollerance}"/>
			<s:Group includeInLayout="{enableIncludeTextSearch}" visible="{enableIncludeTextSearch}">
				<s:layout>
					<s:BasicLayout />
				</s:layout>
				<s:Image toolTip="{includetextquerywarnTip}" 
						 width="{includeTextQuery.width}" height="{includeTextQuery.height}"
						 source="{WIDGET_URL + 'blank.png'}" fillMode="repeat"
						 includeInLayout="{(cboLayerGraphical.selectedItem != cboLayerText.selectedItem)}"
                         visible="{(cboLayerGraphical.selectedItem != cboLayerText.selectedItem)}"/>
				<s:CheckBox id="includeTextQuery" selected="false" label="{lblInclueTextQuery}"
					 	enabled="{(cboLayerGraphical.selectedItem == cboLayerText.selectedItem)}"/>
			</s:Group>
			<s:HGroup verticalAlign="middle" includeInLayout="{enableGraphicsBuffering}" visible="{enableGraphicsBuffering}">
				<s:CheckBox id="bufferUserGraphic" selected="false" label="{lblbufferUserGraphic}"/>
				<s:TextInput id="textGraInputBuffer" text="{BuffValue}" width="40" needsSoftKeyboard="true"/>
				<s:DropDownList id="cboGraBufferUnit" />
				<s:Group>
					<s:Image source="{WIDGET_URL + 'i_gearsmall.png'}"
							 width="22" height="22" smooth="true"
							 toolTip="{configbuffergraTip}" buttonMode="true"
							 useHandCursor="true" id="buffGraCfgBtn"
							 click="buffGraCfgBtn_clickHandler(event)"
							 rollOver="buffCfgBtn_rollOverHandler(event)"
							 rollOut="buffCfgBtn_rollOutHandler(event)"/>
					<s:PopUpAnchor id="graphicPopUp"
								   left="0" bottom="22"
								   popUpPosition="topLeft"
								   styleName="popUpBox">
						<s:BorderContainer width="225" height="160"
										   backgroundAlpha="{getStyle('backgroundAlpha')}"
										   backgroundColor="{getStyle('chromeColor')}"
										   borderColor="{getStyle('accentColor')}"
										   cornerRadius="8">
							<s:VGroup width="100%" height="100%" horizontalAlign="center" verticalAlign="middle"
									  paddingBottom="2" paddingLeft="5" paddingRight="5" paddingTop="2">
								<s:Label text="{buffergrapicpropsLbl}" />
								<s:HGroup width="100%" gap="10" horizontalAlign="left" verticalAlign="middle">
									<s:Label text="{bufferColorLabel}" />
									<mx:ColorPicker id="cpGraBufferColor" selectedColor="#01b9fd" enabled="{!chkNoBufferFill.selected}"/>
									<s:CheckBox id="chkNoBufferFill" label="{nobuffercolorlbl}" selected="false" />
								</s:HGroup>
								<s:HGroup width="100%" gap="5" horizontalAlign="left" verticalAlign="middle">
									<s:Label text="{bufferAlphaLabel}" />
									<s:HSlider id="hsGraBufferAlpha" width="55" value="0.3" minimum="0" maximum="1" snapInterval="0.1"
											   dataTipFormatFunction="sldrDataTipFormatter"
											   skinClass="widgets.eSearch.skins.alphaSliderSkin"/>
								</s:HGroup>
								<s:HGroup width="100%" gap="5" horizontalAlign="left" verticalAlign="middle">
									<s:Label text="{bufferoutlinecolorlbl}" />
									<mx:ColorPicker id="cpGraBufferOLColor" selectedColor="#01b9fd" enabled="{!chkNoBufferOutline.selected}"/>
									<s:CheckBox id="chkNoBufferOutline" label="{nobufferoutlinecolorlbl}" selected="false" />
								</s:HGroup>
								<s:HGroup width="100%" gap="5" horizontalAlign="left" verticalAlign="middle">
									<s:Label text="{bufferoutlinewidthlbl}" />
									<s:NumericStepper id="linewidth"
													   maximum="5"
													   minimum="0"
													   stepSize="1"
													   value="1" width="50"/>
								</s:HGroup>
								<s:HGroup horizontalAlign="right" width="100%" paddingRight="5">
									<s:Button label="Apply" id="bufGraPropsApplyBtn" click="bufGraPropsApplyBtn_clickHandler(event)" />
								</s:HGroup>
							</s:VGroup>
						</s:BorderContainer>
					</s:PopUpAnchor>
				</s:Group>
			</s:HGroup>
		</s:Group>
		<s:Group id="spatialInput"
				 width="100%" height="100%"
				 visible="false"
				 visible.spatialInput="true">
			<s:layout>
				<s:VerticalLayout gap="6" horizontalAlign="center" paddingLeft="10" paddingTop="2"/>
			</s:layout>
			<s:Label id="lblBuffer" text="{bufferLabel}" width="100%"/>
			<s:HGroup verticalAlign="middle" width="100%" horizontalAlign="center">
				<s:TextInput id="textInputBuffer" text="{BuffValue}" width="40" needsSoftKeyboard="true" />
				<s:DropDownList id="cboBufferUnit" />
				<s:Group>
					<s:Image source="{WIDGET_URL + 'i_gearsmall.png'}" width="22" height="22" smooth="true"
							 toolTip="{configbuffergraTip}" buttonMode="true" rollOver="buffCfgBtn_rollOverHandler(event)"
							 useHandCursor="true" id="buffCfgBtn" click="buffCfgBtn_clickHandler(event)" rollOut="buffCfgBtn_rollOutHandler(event)"/>
					<s:PopUpAnchor id="graphicPopUp2"
								   left="0" bottom="22"
								   popUpPosition="right"
								   styleName="popUpBox">
						<s:BorderContainer width="225" height="160"
										   backgroundAlpha="{getStyle('backgroundAlpha')}"
										   backgroundColor="{getStyle('chromeColor')}"
										   borderColor="{getStyle('accentColor')}"
										   cornerRadius="8">
							<s:VGroup width="100%" height="100%" horizontalAlign="center" verticalAlign="middle"
									  paddingBottom="2" paddingLeft="5" paddingRight="5" paddingTop="2">
								<s:Label text="{buffergrapicpropsLbl}" />
								<s:HGroup width="100%" gap="10" horizontalAlign="left" verticalAlign="middle">
									<s:Label text="{bufferColorLabel}" />
									<mx:ColorPicker id="cpBufferColor" selectedColor="#01b9fd" enabled="{!chkNoBufferFill.selected}"/>
									<s:CheckBox id="chkNoBufferFill2" label="{nobuffercolorlbl}" selected="false" />
								</s:HGroup>
								<s:HGroup width="100%" gap="5" horizontalAlign="left" verticalAlign="middle">
									<s:Label text="{bufferAlphaLabel}" />
									<s:HSlider id="hsBufferAlpha" width="55" value="0.3" minimum="0" maximum="1" snapInterval="0.1"
											   toolTip="{bufferAlphaLabel}" dataTipFormatFunction="sldrDataTipFormatter"
											   skinClass="widgets.eSearch.skins.alphaSliderSkin"/>
								</s:HGroup>
								<s:HGroup width="100%" gap="5" horizontalAlign="left" verticalAlign="middle">
									<s:Label text="{bufferoutlinecolorlbl}" />
									<mx:ColorPicker id="cpBufferOLColor" selectedColor="#01b9fd" toolTip="{bufferColorLabel}" />
									<s:CheckBox id="chkNoBufferOutline2" label="{nobufferoutlinecolorlbl}" selected="false" />
								</s:HGroup>
								<s:HGroup width="100%" gap="5" horizontalAlign="left" verticalAlign="middle">
									<s:Label text="{bufferoutlinewidthlbl}" />
									<s:NumericStepper id="linewidth2"
													  maximum="5"
													  minimum="0"
													  stepSize="1"
													  value="1" width="50"/>
								</s:HGroup>
								<s:HGroup horizontalAlign="right" width="100%" paddingRight="5">
									<s:Button label="Apply" id="bufPropsApplyBtn" click="bufPropsApplyBtn_clickHandler(event)" />
								</s:HGroup>
							</s:VGroup>
						</s:BorderContainer>
					</s:PopUpAnchor>
				</s:Group>
			</s:HGroup>
			<s:HGroup width="100%" gap="20" horizontalAlign="center" verticalAlign="middle">
				<s:Image width="40" height="40"
						  buttonMode="true"
						  click="applyBuffer()"
						  source="{WIDGET_URL + 'i_buffer.png'}"
						  toolTip="{applyBufferLabel}"
						  useHandCursor="true"/>
				<s:Image width="40" height="40"
						  buttonMode="true"
						  click="clearBuffer()"
						  source="assets/images/i_clear.png"
						  toolTip="{clearLabel}"
						  useHandCursor="true"/>
			</s:HGroup>
			<s:Line width="100%">
				<s:stroke>
					<s:SolidColorStroke color="0xFFFFFF" weight="1"/>
				</s:stroke>
			</s:Line>
			<s:Label id="lblSearchLayerSpatial" text="{searchLayerLabel}" width="100%"/>
			<s:HGroup width="100%" gap="8" horizontalAlign="center" verticalAlign="middle">
				<s:DropDownList id="cboSearchLayerSpatial" height="25"/>
				<s:DropDownList id="selectionMethodSpatial"
								width="50" height="25"
								itemRenderer="com.esri.ags.skins.supportClasses.EditorDropDownListItemRenderer"
								labelField="label"
								skinClass="com.esri.ags.skins.EditorSelectionDropDownListSkin"
								toolTip="{SelectionMethodTip}"
								selectedIndex="0" >
					<s:dataProvider>
						<s:ArrayList>
							<fx:Object icon="@Embed('widgets/eSearch/assets/images/NewSelection.png')"
									   label="{NewSelectionMethodTip}"
									   selectionName="{FeatureLayer.SELECTION_NEW}"/>
							<fx:Object icon="@Embed('widgets/eSearch/assets/images/AddToSelection.png')"
									   label="{AddSelectionMethodTip}"
									   selectionName="{FeatureLayer.SELECTION_ADD}"/>
							<fx:Object icon="@Embed('widgets/eSearch/assets/images/RemoveFromSelection.png')"
									   label="{RemoveSelectionMethodTip}"
									   selectionName="{FeatureLayer.SELECTION_SUBTRACT}"/>
						</s:ArrayList>
					</s:dataProvider>
				</s:DropDownList>
			</s:HGroup>
			<s:HGroup id="SpatialOps" width="100%" gap="0" horizontalAlign="center" verticalAlign="middle" />
		</s:Group>
		<!-- result-->
		<s:Group id="resultsList"
				 width="100%" height="100%"
				 visible="false"
				 visible.resultsList="true">
			<s:layout>
				<s:VerticalLayout gap="1"/>
			</s:layout>
			<s:HGroup id="boxMessage"
					  width="100%"
					  includeInLayout="{msgVisible}"
					  visible="{msgVisible}" verticalAlign="middle" horizontalAlign="center">
				<s:SWFLoader id="swfMessage"
							 source="assets/images/loader.swf"
							 visible="false"/>
				<s:Label id="txtMessage"
						 width="90%"
						 text=""/>
				<s:Label buttonMode="true" textAlign="right"
						 click="pushToResults()"
						 fontWeight="bold"
						 includeInLayout="{featLyrLen &gt; 0}"
						 text="Push To Results"
						 textDecoration="underline"
						 toolTip="Push to Results Table"
						 visible="{featLyrLen &gt; 0}"/>
				<s:Label buttonMode="true" textAlign="right"
						 click="zoomAll()"
						 fontWeight="bold"
						 includeInLayout="{featLyrLen &gt; 0 &amp;&amp; featSethasGeom}"
						 text="{zoomallLabel}"
						 textDecoration="underline"
						 toolTip="{zoomallTip}"
						 visible="{featLyrLen &gt; 0 &amp;&amp; featSethasGeom}"/>
				<s:Label buttonMode="true" textAlign="right"
						 click="clear()"
						 fontWeight="bold"
						 includeInLayout="{featLyrLen &gt; 0}"
						 text="{clearLabel}"
						 textDecoration="underline"
						 visible="{featLyrLen &gt; 0}"/>
			</s:HGroup>
			<s:Scroller id="recVbox" width="100%" height="100%">
				<Search:SearchResultDataGroup id="searchResultDG"
											  dataProvider="{searchResultAC}"
											  searchResultClick="clickSearchResult(event)"
											  searchResultMouseOut="mouseOutSearchResult(event)"
											  searchResultMouseOver="mouseOverSearchResult(event)"
											  searchResultClear="clearSearchResult(event)"
											  searchResultSymbolToggle="toggleSymbolResult(event)"
											  searchResultRelateClick="preClickSearchRelateResult(event)">
					<Search:layout>
						<s:VerticalLayout gap="2"
										  horizontalAlign="justify"
										  useVirtualLayout="true"/>
					</Search:layout>
				</Search:SearchResultDataGroup>
			</s:Scroller>
		</s:Group>
	</viewer:WidgetTemplate>
</viewer:BaseWidget>